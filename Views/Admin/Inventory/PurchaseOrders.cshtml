@{
    ViewData["Title"] = "Purchase Orders";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Purchase Orders</h1>
        <p class="page-subtitle">Reorder stock from suppliers</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#purchaseOrderModal" onclick="openCreateOrderModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Create Purchase Order
    </button>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card stat-card-warning">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card stat-card-info">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                    <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="shippedOrders">0</div>
                <div class="stat-label">Shipped</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card stat-card-success">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4 fade-in">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Search Orders</label>
                <div class="search-input">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" class="form-control" id="searchOrders" placeholder="Search by PO#, supplier...">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Supplier</label>
                <select class="form-select" id="filterSupplier">
                    <option value="">All Suppliers</option>
                    <!-- Dynamically populated -->
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" id="filterStatus">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date From</label>
                <input type="date" class="form-control" id="dateFrom">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date To</label>
                <input type="date" class="form-control" id="dateTo">
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-primary w-100" onclick="filterOrders()">Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Orders Table -->
<div class="card fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0">Purchase Order List</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="purchaseOrdersTable">
                <thead>
                    <tr>
                        <th>PO Number</th>
                        <th>Supplier</th>
                        <th>Order Date</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchaseOrdersTableBody">
                    <!-- Dynamic content loaded from API -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Purchase Order Modal -->
<div class="modal fade" id="purchaseOrderModal" tabindex="-1" aria-labelledby="purchaseOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseOrderModalLabel">Create Purchase Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchaseOrderForm">
                    <input type="hidden" id="orderId" value="0">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Supplier <span class="text-danger">*</span></label>
                            <select class="form-select" id="orderSupplier" required onchange="loadSupplierProducts()">
                                <option value="">Select Supplier</option>
                                <!-- Suppliers will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Order Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="orderDate" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Expected Delivery</label>
                            <input type="date" class="form-control" id="expectedDelivery">
                        </div>
                    </div>

                    <!-- Order Items Section -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Order Items</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOrderItem()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add Item
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0" id="orderItemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Product</th>
                                            <th style="width: 15%;">Unit Price</th>
                                            <th style="width: 15%;">Quantity</th>
                                            <th style="width: 20%;">Subtotal</th>
                                            <th style="width: 10%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="orderItemsBody">
                                        <tr id="itemRow_1">
                                            <td>
                                                <select class="form-select form-select-sm" onchange="updateItemPrice(1)">
                                                    <option value="">Select Product</option>
                                                    <option value="1" data-price="2500">Gaming Mouse - Razer DeathAdder</option>
                                                    <option value="2" data-price="5500">Mechanical Keyboard - Logitech G Pro</option>
                                                    <option value="3" data-price="4200">Gaming Headset - HyperX Cloud II</option>
                                                    <option value="4" data-price="25000">Monitor - ASUS ROG 27"</option>
                                                    <option value="5" data-price="35000">Graphics Card - RTX 4070</option>
                                                </select>
                                            </td>
                                            <td><input type="number" class="form-control form-control-sm" id="price_1" readonly placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm" id="qty_1" min="1" value="1" onchange="updateSubtotal(1)"></td>
                                            <td><input type="text" class="form-control form-control-sm" id="subtotal_1" readonly placeholder="₱0.00"></td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(1)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light">
                                            <td colspan="3" class="text-end fw-bold">Total Amount:</td>
                                            <td class="fw-bold text-primary" id="orderTotal">₱0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="orderNotes" rows="2" placeholder="Additional notes or instructions..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">Save as Draft</button>
                <button type="button" class="btn btn-primary" onclick="submitOrder()">Submit Order</button>
            </div>
        </div>
    </div>
</div>

<!-- View Order Modal -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl-wide">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Purchase Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label text-muted">PO Number</label>
                        <p class="fw-bold text-primary" id="viewPONumber">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Supplier</label>
                        <p class="fw-medium" id="viewOrderSupplier">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Status</label>
                        <p id="viewOrderStatus">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Order Date</label>
                        <p id="viewOrderDate">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Expected Delivery</label>
                        <p id="viewExpectedDelivery">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">Total Amount</label>
                        <p class="fw-bold text-success" id="viewTotalAmount">-</p>
                    </div>
                </div>

                <h6 class="mb-3">Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Unit Price</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="viewOrderItems">
                            <!-- Items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" onclick="printOrder()">Print Order</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/admin.js"></script>
<script>
    // Global variables
    let itemCounter = 1;
    let supplierProducts = []; // Products for selected supplier
    let allOrders = []; // All loaded purchase orders

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadSuppliers();
        await loadPurchaseOrders();
        document.getElementById('orderDate').valueAsDate = new Date();
    });

    // Load all suppliers from database
    async function loadSuppliers() {
        try {
            const suppliers = await API.get('/suppliers');
            const suppliersList = Array.isArray(suppliers) ? suppliers : (suppliers.data || []);
            
            // Populate create modal dropdown
            const select = document.getElementById('orderSupplier');
            select.innerHTML = '<option value="">Select Supplier</option>';
            
            // Populate filter dropdown
            const filterSelect = document.getElementById('filterSupplier');
            filterSelect.innerHTML = '<option value="">All Suppliers</option>';
            
            suppliersList.forEach(s => {
                if (s.status === 'Active') {
                    select.innerHTML += `<option value="${s.supplierId}">${s.supplierName}</option>`;
                    filterSelect.innerHTML += `<option value="${s.supplierId}">${s.supplierName}</option>`;
                }
            });
        } catch (error) {
            console.error('Failed to load suppliers:', error);
            Toast.error('Failed to load suppliers');
        }
    }

    // Load products when supplier is selected
    async function loadSupplierProducts() {
        const supplierId = document.getElementById('orderSupplier').value;
        if (!supplierId) {
            supplierProducts = [];
            updateProductDropdowns();
            return;
        }

        try {
            const result = await API.get(`/suppliers/${supplierId}/products`);
            supplierProducts = Array.isArray(result) ? result : (result.data || []);
            updateProductDropdowns();
            
            if (supplierProducts.length === 0) {
                Toast.warning('No products found for this supplier');
            } else {
                Toast.success(`Loaded ${supplierProducts.length} products from supplier`);
            }
        } catch (error) {
            console.error('Failed to load supplier products:', error);
            Toast.error('Failed to load supplier products');
            supplierProducts = [];
            updateProductDropdowns();
        }
    }

    // Update all product dropdowns with supplier's products
    function updateProductDropdowns() {
        const selects = document.querySelectorAll('#orderItemsBody select');
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Product</option>';
            supplierProducts.forEach(p => {
                select.innerHTML += `<option value="${p.productId}" data-price="${p.costPrice}" data-stock="${p.stockQuantity}">${p.productName} (Stock: ${p.stockQuantity})</option>`;
            });
            // Restore previous selection if it exists
            if (currentValue) {
                select.value = currentValue;
            }
        });
    }

    // Get product select HTML
    function getProductSelectHTML(rowId) {
        let html = `<select class="form-select form-select-sm" id="product_${rowId}" onchange="updateItemPrice(${rowId})"><option value="">Select Product</option>`;
        supplierProducts.forEach(p => {
            html += `<option value="${p.productId}" data-price="${p.costPrice}" data-stock="${p.stockQuantity}">${p.productName} (Stock: ${p.stockQuantity})</option>`;
        });
        html += '</select>';
        return html;
    }

    function openCreateOrderModal() {
        document.getElementById('purchaseOrderModalLabel').textContent = 'Create Purchase Order';
        document.getElementById('purchaseOrderForm').reset();
        document.getElementById('orderId').value = '0';
        document.getElementById('orderDate').valueAsDate = new Date();
        supplierProducts = []; // Reset products
        
        // Reset items table
        document.getElementById('orderItemsBody').innerHTML = `
            <tr id="itemRow_1">
                <td>
                    <select class="form-select form-select-sm" id="product_1" onchange="updateItemPrice(1)">
                        <option value="">Select Product</option>
                    </select>
                </td>
                <td><input type="number" class="form-control form-control-sm" id="price_1" readonly placeholder="0.00"></td>
                <td><input type="number" class="form-control form-control-sm" id="qty_1" min="1" value="1" onchange="updateSubtotal(1)"></td>
                <td><input type="text" class="form-control form-control-sm" id="subtotal_1" readonly placeholder="₱0.00"></td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(1)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
        itemCounter = 1;
        updateOrderTotal();
        
        var modal = new bootstrap.Modal(document.getElementById('purchaseOrderModal'));
        modal.show();
    }

    function addOrderItem() {
        if (supplierProducts.length === 0) {
            Toast.warning('Please select a supplier first');
            return;
        }
        
        itemCounter++;
        const newRow = `
            <tr id="itemRow_${itemCounter}">
                <td>${getProductSelectHTML(itemCounter)}</td>
                <td><input type="number" class="form-control form-control-sm" id="price_${itemCounter}" readonly placeholder="0.00"></td>
                <td><input type="number" class="form-control form-control-sm" id="qty_${itemCounter}" min="1" value="1" onchange="updateSubtotal(${itemCounter})"></td>
                <td><input type="text" class="form-control form-control-sm" id="subtotal_${itemCounter}" readonly placeholder="₱0.00"></td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(${itemCounter})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('orderItemsBody').insertAdjacentHTML('beforeend', newRow);
    }

    function removeOrderItem(id) {
        const row = document.getElementById(`itemRow_${id}`);
        if (row && document.getElementById('orderItemsBody').children.length > 1) {
            row.remove();
            updateOrderTotal();
        }
    }

    function updateItemPrice(id) {
        const select = document.getElementById(`product_${id}`) || document.querySelector(`#itemRow_${id} select`);
        const selectedOption = select.options[select.selectedIndex];
        const price = selectedOption.dataset.price || 0;
        document.getElementById(`price_${id}`).value = price;
        updateSubtotal(id);
    }

    function updateSubtotal(id) {
        const price = parseFloat(document.getElementById(`price_${id}`).value) || 0;
        const qty = parseInt(document.getElementById(`qty_${id}`).value) || 0;
        const subtotal = price * qty;
        document.getElementById(`subtotal_${id}`).value = `₱${subtotal.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
        updateOrderTotal();
    }

    function updateOrderTotal() {
        let total = 0;
        const rows = document.getElementById('orderItemsBody').querySelectorAll('tr');
        rows.forEach(row => {
            const priceInput = row.querySelector('input[id^="price_"]');
            const qtyInput = row.querySelector('input[id^="qty_"]');
            if (priceInput && qtyInput) {
                const price = parseFloat(priceInput.value) || 0;
                const qty = parseInt(qtyInput.value) || 0;
                total += price * qty;
            }
        });
        document.getElementById('orderTotal').textContent = `₱${total.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
    }

    // Load purchase orders from database
    async function loadPurchaseOrders() {
        try {
            const result = await API.get('/purchase-orders');
            const orders = Array.isArray(result) ? result : (result.data || []);
            allOrders = orders;
            
            renderPurchaseOrders(orders);
        } catch (error) {
            console.error('Failed to load purchase orders:', error);
            Toast.error('Failed to load purchase orders');
            const tbody = document.getElementById('purchaseOrdersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Failed to load purchase orders</td></tr>';
        }
    }

    function renderPurchaseOrders(orders) {
            const tbody = document.getElementById('purchaseOrdersTableBody');
            
            // Update stats
            const stats = {
                total: orders.length,
                pending: orders.filter(o => o.status === 'Pending').length,
                shipped: orders.filter(o => o.status === 'Shipped').length,
                completed: orders.filter(o => o.status === 'Completed').length
            };
            
            document.getElementById('totalOrders').textContent = stats.total;
            document.getElementById('pendingOrders').textContent = stats.pending;
            document.getElementById('shippedOrders').textContent = stats.shipped;
            document.getElementById('completedOrders').textContent = stats.completed;
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No purchase orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const statusClass = {
                    'Pending': 'bg-warning-subtle text-warning',
                    'Approved': 'bg-success-subtle text-success',
                    'Shipped': 'bg-info-subtle text-info',
                    'Completed': 'bg-success-subtle text-success',
                    'Cancelled': 'bg-danger-subtle text-danger'
                }[order.status] || 'bg-secondary-subtle text-secondary';
                
                return `
                    <tr>
                        <td><span class="fw-medium text-primary">${order.poNumber || 'PO-' + order.purchaseOrderId}</span></td>
                        <td>${order.supplierName || '-'}</td>
                        <td>${Format.date(order.orderDate)}</td>
                        <td><span class="badge bg-info-subtle text-info">${order.itemCount || 0} Items</span></td>
                        <td class="fw-medium">${Format.currency(order.totalAmount)}</td>
                        <td><span class="badge ${statusClass}">${order.status}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewOrder(${order.purchaseOrderId})" title="View">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                ${order.status === 'Pending' ? `
                                <button class="btn btn-outline-secondary" onclick="editOrder(${order.purchaseOrderId})" title="Edit">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-outline-success" onclick="approveOrder(${order.purchaseOrderId})" title="Approve">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </button>
                                ` : ''}
                                ${order.status === 'Approved' ? `
                                <button class="btn btn-outline-info" onclick="markShipped(${order.purchaseOrderId})" title="Mark Shipped">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                        <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
                                    </svg>
                                </button>
                                ` : ''}
                                ${order.status === 'Shipped' ? `
                                <button class="btn btn-outline-success" onclick="markCompleted(${order.purchaseOrderId})" title="Mark Completed">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
    }

    async function viewOrder(id) {
        try {
            const result = await API.get(`/purchase-orders/${id}`);
            const order = result.data || result;
            
            document.getElementById('viewPONumber').textContent = order.poNumber || `PO-${id}`;
            document.getElementById('viewOrderSupplier').textContent = order.supplierName || '-';
            
            const statusClass = {
                'Pending': 'bg-warning-subtle text-warning',
                'Approved': 'bg-success-subtle text-success',
                'Shipped': 'bg-info-subtle text-info',
                'Completed': 'bg-success-subtle text-success',
                'Cancelled': 'bg-danger-subtle text-danger'
            }[order.status] || 'bg-secondary-subtle text-secondary';
            document.getElementById('viewOrderStatus').innerHTML = `<span class="badge ${statusClass}">${order.status}</span>`;
            
            document.getElementById('viewOrderDate').textContent = Format.date(order.orderDate);
            document.getElementById('viewExpectedDelivery').textContent = order.expectedDeliveryDate ? Format.date(order.expectedDeliveryDate) : '-';
            document.getElementById('viewTotalAmount').textContent = Format.currency(order.totalAmount);
            
            const items = order.items || [];
            if (items.length === 0) {
                document.getElementById('viewOrderItems').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No items</td></tr>';
            } else {
                document.getElementById('viewOrderItems').innerHTML = items.map(i => `
                    <tr>
                        <td>${i.productName || 'Unknown'}</td>
                        <td>${Format.currency(i.unitPrice)}</td>
                        <td>${i.quantity}</td>
                        <td>${Format.currency(i.subtotal)}</td>
                    </tr>
                `).join('');
            }
            
            if (order.notes) {
                // Add notes row if not already shown
                const notesDiv = document.getElementById('viewOrderNotes');
                if (notesDiv) notesDiv.textContent = order.notes;
            }
            
            var modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
            modal.show();
        } catch (error) {
            console.error('Failed to load order details:', error);
            Toast.error('Failed to load order details');
        }
    }

    async function editOrder(id) {
        try {
            const result = await API.get(`/purchase-orders/${id}`);
            const order = result.data || result;
            
            document.getElementById('purchaseOrderModalLabel').textContent = 'Edit Purchase Order';
            document.getElementById('orderId').value = id;
            
            // Set supplier and load products
            document.getElementById('orderSupplier').value = order.supplierId || '';
            if (order.supplierId) {
                await loadSupplierProducts();
            }
            
            // Set dates
            if (order.orderDate) {
                document.getElementById('orderDate').value = new Date(order.orderDate).toISOString().split('T')[0];
            }
            if (order.expectedDeliveryDate) {
                document.getElementById('expectedDelivery').value = new Date(order.expectedDeliveryDate).toISOString().split('T')[0];
            }
            document.getElementById('orderNotes').value = order.notes || '';
            
            // Populate items
            const items = order.items || [];
            const itemsBody = document.getElementById('orderItemsBody');
            itemsBody.innerHTML = '';
            
            if (items.length > 0) {
                items.forEach((item, index) => {
                    const rowId = index + 1;
                    const row = `
                        <tr id="itemRow_${rowId}">
                            <td>${getProductSelectHTML(rowId)}</td>
                            <td><input type="number" class="form-control form-control-sm" id="price_${rowId}" value="${item.unitPrice || 0}" readonly placeholder="0.00"></td>
                            <td><input type="number" class="form-control form-control-sm" id="qty_${rowId}" min="1" value="${item.quantity}" onchange="updateSubtotal(${rowId})"></td>
                            <td><input type="text" class="form-control form-control-sm" id="subtotal_${rowId}" readonly value="₱${(item.subtotal || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}"></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(${rowId})">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    itemsBody.insertAdjacentHTML('beforeend', row);
                    
                    // Select the product
                    setTimeout(() => {
                        const select = document.getElementById(`product_${rowId}`);
                        if (select && item.productId) {
                            select.value = item.productId;
                        }
                    }, 100);
                    
                    itemCounter = rowId;
                });
            } else {
                itemsBody.innerHTML = `
                    <tr id="itemRow_1">
                        <td>${getProductSelectHTML(1)}</td>
                        <td><input type="number" class="form-control form-control-sm" id="price_1" readonly placeholder="0.00"></td>
                        <td><input type="number" class="form-control form-control-sm" id="qty_1" min="1" value="1" onchange="updateSubtotal(1)"></td>
                        <td><input type="text" class="form-control form-control-sm" id="subtotal_1" readonly placeholder="₱0.00"></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(1)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                itemCounter = 1;
            }
            
            updateOrderTotal();
            
            var modal = new bootstrap.Modal(document.getElementById('purchaseOrderModal'));
            modal.show();
        } catch (error) {
            console.error('Failed to load order for editing:', error);
            Toast.error('Failed to load order for editing');
        }
    }

    async function submitOrder() {
        const supplier = document.getElementById('orderSupplier').value;
        if (!supplier) {
            Toast.error('Please select a supplier');
            return;
        }

        // Collect order items
        const items = [];
        const rows = document.getElementById('orderItemsBody').querySelectorAll('tr');
        rows.forEach(row => {
            const select = row.querySelector('select');
            const qtyInput = row.querySelector('input[id^="qty_"]');
            const priceInput = row.querySelector('input[id^="price_"]');
            
            if (select && select.value && qtyInput && priceInput) {
                items.push({
                    productId: parseInt(select.value),
                    quantity: parseInt(qtyInput.value),
                    unitPrice: parseFloat(priceInput.value)
                });
            }
        });

        if (items.length === 0) {
            Toast.error('Please add at least one product');
            return;
        }

        try {
            const orderData = {
                supplierId: parseInt(supplier),
                orderDate: document.getElementById('orderDate').value,
                expectedDelivery: document.getElementById('expectedDelivery').value || null,
                notes: document.getElementById('orderNotes').value,
                items: items
            };

            await API.post('/purchase-orders', orderData);
            Toast.success('Purchase Order submitted successfully!');
            showNotification('Purchase Order Created', 'A new purchase order has been submitted for approval.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('purchaseOrderModal')).hide();
            await loadPurchaseOrders();
        } catch (error) {
            Toast.error('Failed to submit purchase order: ' + error.message);
        }
    }

    async function saveDraft() {
        const supplier = document.getElementById('orderSupplier').value;
        if (!supplier) {
            Toast.error('Please select a supplier');
            return;
        }
        
        // Collect items (allow empty prices for draft)
        const items = [];
        const rows = document.getElementById('orderItemsBody').querySelectorAll('tr');
        rows.forEach(row => {
            const select = row.querySelector('select');
            const qtyInput = row.querySelector('input[id^="qty_"]');
            const priceInput = row.querySelector('input[id^="price_"]');
            
            if (select && select.value && qtyInput) {
                items.push({
                    productId: parseInt(select.value),
                    quantity: parseInt(qtyInput.value) || 1,
                    unitPrice: parseFloat(priceInput?.value) || 0
                });
            }
        });
        
        try {
            const orderData = {
                supplierId: parseInt(supplier),
                orderDate: document.getElementById('orderDate').value || new Date().toISOString().split('T')[0],
                expectedDelivery: document.getElementById('expectedDelivery').value || null,
                notes: (document.getElementById('orderNotes').value || '') + ' [DRAFT]',
                items: items.length > 0 ? items : [{ productId: parseInt(supplierProducts[0]?.productId || 0), quantity: 1, unitPrice: 0 }]
            };
            
            await API.post('/purchase-orders', orderData);
            Toast.success('Purchase Order saved as draft!');
            bootstrap.Modal.getInstance(document.getElementById('purchaseOrderModal')).hide();
            await loadPurchaseOrders();
        } catch (error) {
            Toast.error('Failed to save draft: ' + error.message);
        }
    }

    async function approveOrder(id) {
        if (confirm('Are you sure you want to approve this purchase order?')) {
            try {
                await API.put(`/purchase-orders/${id}/approve`);
                Toast.success('Purchase Order approved!');
                showNotification('Order Approved', 'Purchase order has been approved.', 'success');
                await loadPurchaseOrders();
            } catch (error) {
                Toast.error('Failed to approve order');
            }
        }
    }

    async function markShipped(id) {
        if (confirm('Mark this order as shipped?')) {
            try {
                await API.put(`/purchase-orders/${id}/ship`);
                Toast.success('Order marked as shipped!');
                await loadPurchaseOrders();
            } catch (error) {
                Toast.error('Failed to update order');
            }
        }
    }

    async function markCompleted(id) {
        if (confirm('Mark this order as completed? This will update inventory stock levels.')) {
            try {
                await API.put(`/purchase-orders/${id}/complete`);
                Toast.success('Order completed! Stock levels updated.');
                showNotification('Stock Updated', 'Inventory has been updated from completed purchase order.', 'info');
                await loadPurchaseOrders();
            } catch (error) {
                Toast.error('Failed to complete order');
            }
        }
    }

    function printOrder() {
        window.print();
    }

    function filterOrders() {
        let filtered = allOrders;
        
        const supplierFilter = document.getElementById('filterSupplier').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        if (supplierFilter) {
            filtered = filtered.filter(o => o.supplierId == supplierFilter);
        }
        if (statusFilter) {
            filtered = filtered.filter(o => o.status === statusFilter);
        }
        if (dateFrom) {
            filtered = filtered.filter(o => new Date(o.orderDate) >= new Date(dateFrom));
        }
        if (dateTo) {
            filtered = filtered.filter(o => new Date(o.orderDate) <= new Date(dateTo + 'T23:59:59'));
        }
        
        renderPurchaseOrders(filtered);
    }

    // Notification helper
    function showNotification(title, message, type = 'info') {
        // Update notification badge
        const badge = document.querySelector('.topbar-badge');
        if (badge) {
            const count = parseInt(badge.textContent || '0') + 1;
            badge.textContent = count;
            badge.style.display = 'flex';
        }
    }

    // Search functionality
    document.getElementById('searchOrders').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#purchaseOrdersTableBody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
</script>
}
