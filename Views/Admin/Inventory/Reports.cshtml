@{
    ViewData["Title"] = "Inventory Reports";
}

<div class="page-header">
    <h1 class="page-title">Inventory Reports</h1>
    <p class="page-subtitle">Analyze inventory performance and trends</p>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Inventory Value</span>
            <span class="stat-value" id="totalInventoryValue">₱0</span>
        </div>
        <div class="stat-icon teal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Products</span>
            <span class="stat-value" id="totalProductCount">0</span>
        </div>
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Stock Units</span>
            <span class="stat-value" id="totalStockUnits">0</span>
        </div>
        <div class="stat-icon" style="background: var(--info-bg); color: var(--info);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Low Stock Items (≤15)</span>
            <span class="stat-value" id="lowStockItems">0</span>
        </div>
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card fade-in h-100">
            <div class="card-header">
                <h3 class="card-title">Stock Distribution by Category</h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card fade-in h-100">
            <div class="card-header">
                <h3 class="card-title">Inventory Value by Category</h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="valueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card fade-in mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">Detailed Inventory Report</h3>
        <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export to CSV
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table" id="inventoryReportTable">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Supplier</th>
                        <th>Stock Qty</th>
                        <th>Cost Price</th>
                        <th>Selling Price</th>
                        <th>Stock Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="inventoryReportBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card fade-in">
    <div class="card-header">
        <h3 class="card-title">Category Summary</h3>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table" id="categorySummaryTable">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Total Products</th>
                        <th>Total Stock</th>
                        <th>Avg. Stock per Product</th>
                        <th>Total Value</th>
                        <th>% of Inventory</th>
                    </tr>
                </thead>
                <tbody id="categorySummaryBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const LOW_STOCK_THRESHOLD = 15;
        let inventoryChart = null;
        let valueChart = null;
        let allProducts = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await loadInventoryReport();
        });

        async function loadInventoryReport() {
            try {
                const products = await API.get('/products');
                allProducts = products;
                
                // Calculate stats
                const totalValue = products.reduce((sum, p) => sum + (p.stockQuantity * (p.costPrice || p.sellingPrice || 0)), 0);
                const totalUnits = products.reduce((sum, p) => sum + p.stockQuantity, 0);
                const lowStock = products.filter(p => p.stockQuantity <= LOW_STOCK_THRESHOLD && p.stockQuantity > 0).length;
                const outOfStock = products.filter(p => p.stockQuantity === 0).length;

                // Update stats
                document.getElementById('totalInventoryValue').textContent = Format.currency(totalValue);
                document.getElementById('totalProductCount').textContent = products.length;
                document.getElementById('totalStockUnits').textContent = totalUnits.toLocaleString();
                document.getElementById('lowStockItems').textContent = lowStock + outOfStock;

                // Group by category for charts
                const categoryData = {};
                const categoryValue = {};
                products.forEach(p => {
                    const cat = p.categoryName || 'Uncategorized';
                    if (!categoryData[cat]) {
                        categoryData[cat] = 0;
                        categoryValue[cat] = 0;
                    }
                    categoryData[cat] += p.stockQuantity;
                    categoryValue[cat] += p.stockQuantity * (p.costPrice || p.sellingPrice || 0);
                });

                const labels = Object.keys(categoryData);
                const stockData = Object.values(categoryData);
                const valueData = Object.values(categoryValue);
                const colors = ['#008080', '#ff6b35', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#6366F1', '#14B8A6'];

                // Create stock distribution chart
                const ctx1 = document.getElementById('inventoryChart').getContext('2d');
                if (inventoryChart) inventoryChart.destroy();
                inventoryChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: stockData,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = stockData.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.raw.toLocaleString()} units (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Create value distribution chart
                const ctx2 = document.getElementById('valueChart').getContext('2d');
                if (valueChart) valueChart.destroy();
                valueChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Inventory Value',
                            data: valueData,
                            backgroundColor: colors.slice(0, labels.length),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return Format.currency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₱' + (value / 1000).toFixed(0) + 'K';
                                    }
                                }
                            }
                        }
                    }
                });

                // Render detailed inventory table
                renderInventoryTable(products);
                
                // Render category summary
                renderCategorySummary(products, categoryData, categoryValue, totalValue);
                
            } catch (error) {
                console.error('Failed to load inventory report:', error);
                Toast.error('Failed to load inventory report');
            }
        }

        function renderInventoryTable(products) {
            const tbody = document.getElementById('inventoryReportBody');
            
            // Sort by stock value descending
            products.sort((a, b) => {
                const valA = a.stockQuantity * (a.costPrice || a.sellingPrice || 0);
                const valB = b.stockQuantity * (b.costPrice || b.sellingPrice || 0);
                return valB - valA;
            });
            
            tbody.innerHTML = products.map(p => {
                const stockValue = p.stockQuantity * (p.costPrice || p.sellingPrice || 0);
                let statusClass, statusText;
                
                if (p.stockQuantity === 0) {
                    statusClass = 'badge-error';
                    statusText = 'Out of Stock';
                } else if (p.stockQuantity <= LOW_STOCK_THRESHOLD) {
                    statusClass = 'badge-warning';
                    statusText = 'Low Stock';
                } else {
                    statusClass = 'badge-success';
                    statusText = 'In Stock';
                }
                
                return `
                    <tr>
                        <td>${p.sku || 'N/A'}</td>
                        <td><strong>${p.productName}</strong></td>
                        <td>${p.categoryName || 'Uncategorized'}</td>
                        <td>${p.supplierName || '-'}</td>
                        <td class="${p.stockQuantity <= LOW_STOCK_THRESHOLD ? 'text-warning fw-600' : ''}">${p.stockQuantity}</td>
                        <td>${Format.currency(p.costPrice || 0)}</td>
                        <td>${Format.currency(p.sellingPrice || 0)}</td>
                        <td class="fw-600">${Format.currency(stockValue)}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderCategorySummary(products, categoryData, categoryValue, totalValue) {
            const tbody = document.getElementById('categorySummaryBody');
            
            const summaryData = Object.keys(categoryData).map(cat => {
                const catProducts = products.filter(p => (p.categoryName || 'Uncategorized') === cat);
                const totalStock = categoryData[cat];
                const value = categoryValue[cat];
                
                return {
                    category: cat,
                    productCount: catProducts.length,
                    totalStock: totalStock,
                    avgStock: catProducts.length > 0 ? Math.round(totalStock / catProducts.length) : 0,
                    value: value,
                    percentage: totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0
                };
            });
            
            // Sort by value descending
            summaryData.sort((a, b) => b.value - a.value);
            
            tbody.innerHTML = summaryData.map(s => `
                <tr>
                    <td><strong>${s.category}</strong></td>
                    <td>${s.productCount}</td>
                    <td>${s.totalStock.toLocaleString()}</td>
                    <td>${s.avgStock.toLocaleString()}</td>
                    <td class="fw-600">${Format.currency(s.value)}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar bg-teal" style="width: ${s.percentage}%"></div>
                            </div>
                            <span class="small">${s.percentage}%</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function exportReport() {
            const headers = ['SKU', 'Product Name', 'Category', 'Supplier', 'Stock Qty', 'Cost Price', 'Selling Price', 'Stock Value', 'Status'];
            const rows = allProducts.map(p => {
                const stockValue = p.stockQuantity * (p.costPrice || p.sellingPrice || 0);
                const status = p.stockQuantity === 0 ? 'Out of Stock' : p.stockQuantity <= LOW_STOCK_THRESHOLD ? 'Low Stock' : 'In Stock';
                return [
                    p.sku || 'N/A',
                    p.productName,
                    p.categoryName || 'Uncategorized',
                    p.supplierName || '-',
                    p.stockQuantity,
                    p.costPrice || 0,
                    p.sellingPrice || 0,
                    stockValue,
                    status
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            Toast.success('Report exported successfully!');
        }
    </script>
}
