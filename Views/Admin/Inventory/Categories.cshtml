@{
    ViewData["Title"] = "Product Categories";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Product Categories</h1>
        <p class="page-subtitle">Manage product categories for your inventory</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCreateCategoryModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Category
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-4 col-md-6 mb-3">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalCategories">0</div>
                <div class="stat-label">Total Categories</div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-md-6 mb-3">
        <div class="stat-card stat-card-success">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="activeCategories">0</div>
                <div class="stat-label">Active Categories</div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-md-6 mb-3">
        <div class="stat-card stat-card-warning">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="inactiveCategories">0</div>
                <div class="stat-label">Inactive Categories</div>
            </div>
        </div>
    </div>
</div>

<!-- Search -->
<div class="card mb-4 fade-in">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label">Search Categories</label>
                <div class="search-input">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" class="form-control" id="searchCategories" placeholder="Search by category name...">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="filterStatus">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="resetCategoryFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                    Reset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Categories Table -->
<div class="card fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Category List</h5>
        <span class="badge bg-primary" id="categoryCount">0 categories</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table" id="categoriesTable">
                <thead>
                    <tr>
                        <th>Category Name</th>
                        <th>Description</th>
                        <th class="text-center">Products</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Created</th>
                        <th class="text-center" style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesTableBody">
                    <!-- Dynamic content loaded via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small" id="categoryPagination">Showing 0 categories</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
        </nav>
    </div>
</div>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-primary">
                <h5 class="modal-title" id="categoryModalLabel">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span id="categoryModalTitle">Add New Category</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <div class="modal-body">
                    <input type="hidden" id="categoryId" value="">
                    
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" required placeholder="Enter category name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3" placeholder="Enter category description"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="displayOrder" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="displayOrder" value="0" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryStatus" class="form-label">Status</label>
                        <select class="form-select" id="categoryStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Category Modal -->
<div class="modal fade" id="viewCategoryModal" tabindex="-1" aria-labelledby="viewCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-info">
                <h5 class="modal-title" id="viewCategoryModalLabel">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                    Category Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewCategoryContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editCategoryFromView()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Edit Category
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/admin.js"></script>
<script>
    // Categories module data
    let categoriesData = [];
    let currentCategoryId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        
        document.getElementById('searchCategories')?.addEventListener('input', filterCategories);
        document.getElementById('filterStatus')?.addEventListener('change', filterCategories);
    });

    async function loadCategories() {
        try {
            const response = await API.get('/product-categories/all');
            categoriesData = response || [];
            renderCategories(categoriesData);
            updateCategoryStats();
        } catch (error) {
            console.error('Failed to load categories:', error);
            Toast.error('Failed to load categories');
        }
    }

    function renderCategories(data) {
        const tbody = document.getElementById('categoriesTableBody');
        if (!tbody) return;

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No categories found. Click "Add Category" to create one.</td></tr>';
            document.getElementById('categoryCount').textContent = '0 categories';
            document.getElementById('categoryPagination').textContent = 'Showing 0 categories';
            return;
        }

        tbody.innerHTML = data.map(c => `
            <tr>
                <td>
                    <div class="fw-semibold">${c.categoryName}</div>
                </td>
                <td>${c.description || '<span class="text-muted">-</span>'}</td>
                <td class="text-center">
                    <span class="badge bg-info">${c.productCount || 0}</span>
                </td>
                <td class="text-center">
                    <span class="badge ${c.isActive ? 'bg-success' : 'bg-secondary'}">${c.isActive ? 'Active' : 'Inactive'}</span>
                </td>
                <td class="text-center">${Format.date(c.createdAt)}</td>
                <td class="text-center">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewCategory(${c.categoryId})" title="View">
                            ${Icons.view}
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editCategory(${c.categoryId})" title="Edit">
                            ${Icons.edit}
                        </button>
                        <button class="btn btn-sm btn-outline-${c.isActive ? 'danger' : 'success'}" onclick="toggleCategoryStatus(${c.categoryId})" title="${c.isActive ? 'Deactivate' : 'Activate'}">
                            ${c.isActive ? Icons.toggleOff : Icons.toggleOn}
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        document.getElementById('categoryCount').textContent = data.length + ' categories';
        document.getElementById('categoryPagination').textContent = `Showing ${data.length} categories`;
    }

    function updateCategoryStats() {
        const total = categoriesData.length;
        const active = categoriesData.filter(c => c.isActive).length;
        const inactive = total - active;

        document.getElementById('totalCategories').textContent = total;
        document.getElementById('activeCategories').textContent = active;
        document.getElementById('inactiveCategories').textContent = inactive;
    }

    function filterCategories() {
        const search = (document.getElementById('searchCategories')?.value || '').toLowerCase();
        const status = document.getElementById('filterStatus')?.value || '';

        let filtered = categoriesData;

        if (search) {
            filtered = filtered.filter(c => 
                c.categoryName.toLowerCase().includes(search) ||
                (c.description && c.description.toLowerCase().includes(search))
            );
        }

        if (status === 'active') {
            filtered = filtered.filter(c => c.isActive);
        } else if (status === 'inactive') {
            filtered = filtered.filter(c => !c.isActive);
        }

        renderCategories(filtered);
    }

    function resetCategoryFilters() {
        document.getElementById('searchCategories').value = '';
        document.getElementById('filterStatus').value = '';
        renderCategories(categoriesData);
    }

    function openCreateCategoryModal() {
        currentCategoryId = null;
        document.getElementById('categoryModalTitle').textContent = 'Add New Category';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryStatus').value = 'true';
    }

    async function viewCategory(id) {
        try {
            const category = categoriesData.find(c => c.categoryId === id);
            if (!category) {
                Toast.error('Category not found');
                return;
            }

            currentCategoryId = id;
            document.getElementById('viewCategoryContent').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-1">Category Name</h6>
                        <p class="fw-semibold fs-5">${category.categoryName}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-muted mb-1">Description</h6>
                        <p>${category.description || '<span class="text-muted">No description</span>'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Status</h6>
                        <p><span class="badge ${category.isActive ? 'bg-success' : 'bg-secondary'}">${category.isActive ? 'Active' : 'Inactive'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Display Order</h6>
                        <p>${category.displayOrder || 0}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Products in Category</h6>
                        <p><span class="badge bg-info">${category.productCount || 0} products</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Created</h6>
                        <p>${Format.date(category.createdAt)}</p>
                    </div>
                </div>
            `;
            Modal.show('viewCategoryModal');
        } catch (error) {
            Toast.error('Failed to load category details');
        }
    }

    function editCategory(id) {
        const category = categoriesData.find(c => c.categoryId === id);
        if (!category) {
            Toast.error('Category not found');
            return;
        }

        currentCategoryId = id;
        document.getElementById('categoryModalTitle').textContent = 'Edit Category';
        document.getElementById('categoryId').value = category.categoryId;
        document.getElementById('categoryName').value = category.categoryName;
        document.getElementById('categoryDescription').value = category.description || '';
        document.getElementById('displayOrder').value = category.displayOrder || 0;
        document.getElementById('categoryStatus').value = category.isActive ? 'true' : 'false';

        Modal.show('categoryModal');
    }

    function editCategoryFromView() {
        Modal.hide('viewCategoryModal');
        setTimeout(() => editCategory(currentCategoryId), 300);
    }

    async function saveCategory(event) {
        event.preventDefault();

        const id = document.getElementById('categoryId').value;
        const data = {
            categoryName: document.getElementById('categoryName').value,
            description: document.getElementById('categoryDescription').value,
            displayOrder: parseInt(document.getElementById('displayOrder').value) || 0,
            isActive: document.getElementById('categoryStatus').value === 'true'
        };

        if (!data.categoryName.trim()) {
            Toast.error('Category name is required');
            return;
        }

        try {
            if (id) {
                await API.put(`/product-categories/${id}`, data);
                Toast.success('Category updated successfully');
            } else {
                await API.post('/product-categories', data);
                Toast.success('Category created successfully');
            }
            Modal.hide('categoryModal');
            loadCategories();
        } catch (error) {
            Toast.error(error.message || 'Failed to save category');
        }
    }

    async function toggleCategoryStatus(id) {
        try {
            const category = categoriesData.find(c => c.categoryId === id);
            if (!category) return;

            const newStatus = !category.isActive;
            await API.put(`/product-categories/${id}/status`, { isActive: newStatus });
            Toast.success(`Category ${newStatus ? 'activated' : 'deactivated'} successfully`);
            loadCategories();
        } catch (error) {
            Toast.error('Failed to update category status');
        }
    }
</script>
}
