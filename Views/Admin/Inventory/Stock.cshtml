@{
    ViewData["Title"] = "Stock Levels";
}

<div class="page-header">
    <h1 class="page-title">Stock Levels</h1>
    <p class="page-subtitle">Monitor inventory stock levels across all products</p>
</div>

<!-- Stats Cards -->
<div class="stat-cards">
    <div class="stat-card fade-in stagger-1">
        <div class="stat-info">
            <span class="stat-label">Total Products</span>
            <span class="stat-value" id="totalProducts">0</span>
            <div class="stat-trend">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <span id="totalTrend">All items</span>
            </div>
        </div>
        <div class="stat-icon teal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-2">
        <div class="stat-info">
            <span class="stat-label">In Stock</span>
            <span class="stat-value" id="inStockCount">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>Healthy</span>
            </div>
        </div>
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-3">
        <div class="stat-info">
            <span class="stat-label">Low Stock (≤15)</span>
            <span class="stat-value" id="lowStockCount">0</span>
            <div class="stat-trend down">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                </svg>
                <span>Warning</span>
            </div>
        </div>
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-4">
        <div class="stat-info">
            <span class="stat-label">Out of Stock</span>
            <span class="stat-value" id="outOfStockCount">0</span>
            <div class="stat-trend down">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <span>Critical</span>
            </div>
        </div>
        <div class="stat-icon" style="background: var(--error); color: #ffffff;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
    </div>
</div>

<!-- Chart + Stock Table Row -->
<div class="grid" style="grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- Stock Distribution Chart -->
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Stock Distribution</h3>
                <p class="card-subtitle">Inventory overview</p>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 220px;">
                <canvas id="stockDistributionChart"></canvas>
            </div>
            <div class="chart-legend" id="stockChartLegend"></div>
        </div>
    </div>

    <!-- Stock Inventory Table -->
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Stock Inventory</h3>
                <p class="card-subtitle">All product stock levels</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm" id="categoryFilter" style="width: auto; font-size: 0.85rem;" onchange="filterStock()">
                    <option value="">All Categories</option>
                </select>
                <select class="form-select form-select-sm" id="statusFilter" style="width: auto; font-size: 0.85rem;" onchange="filterStock()">
                    <option value="">All Status</option>
                    <option value="in-stock">In Stock</option>
                    <option value="low-stock">Low Stock (≤15)</option>
                    <option value="out-stock">Out of Stock</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="adjustStock()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Adjust Stock
                </button>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <div class="data-table-wrapper">
                <table class="data-table" id="stockTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th class="text-center">Stock</th>
                            <th class="text-center">Reorder</th>
                            <th style="width: 130px;">Level</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <tr><td colspan="8" class="text-center py-4" style="color: var(--gray-400);">Loading stock data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center" id="stockPagination"></div>
</div>

<!-- Stock by Category Summary -->
<div class="card fade-in">
    <div class="card-header">
        <div>
            <h3 class="card-title">Stock by Category</h3>
            <p class="card-subtitle">Category-wise inventory breakdown</p>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="data-table-wrapper">
            <table class="data-table" id="stockByCategoryTable">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="text-center">Total Items</th>
                        <th class="text-center">In Stock</th>
                        <th class="text-center">Low Stock</th>
                        <th class="text-center">Out of Stock</th>
                        <th class="text-end">Stock Value</th>
                    </tr>
                </thead>
                <tbody id="stockCategoryBody">
                    <tr><td colspan="6" class="text-center py-4" style="color: var(--gray-400);">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--primary); color: white;">
                <h5 class="modal-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Adjust Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockAdjustmentForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Product <span class="text-danger">*</span></label>
                        <select class="form-select" id="adjustProductId" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Adjustment Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="adjustType" required>
                            <option value="Add">Add Stock</option>
                            <option value="Subtract">Remove Stock</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Quantity <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="adjustQuantity" min="1" required placeholder="Enter quantity">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Reason</label>
                        <textarea class="form-control" id="adjustReason" rows="2" placeholder="Reason for adjustment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStockAdjustment()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Submit Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/js/admin.js"></script>
<script>
    var STOCK_LEVEL_THRESHOLD = 15;
    var allProducts = [];
    var stockChart = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadStockData();
    });

    async function loadStockData() {
        try {
            var response = await fetch('/api/products');
            var result = await response.json();
            var products = Array.isArray(result) ? result : (result && result.data ? result.data : []);
            allProducts = products;

            var totalProducts = products.length;
            var outOfStock = products.filter(function(p) { return (p.stockQuantity || 0) === 0; }).length;
            var lowStock = products.filter(function(p) { return (p.stockQuantity || 0) > 0 && (p.stockQuantity || 0) <= STOCK_LEVEL_THRESHOLD; }).length;
            var inStock = products.filter(function(p) { return (p.stockQuantity || 0) > STOCK_LEVEL_THRESHOLD; }).length;

            updateEl('totalProducts', totalProducts);
            updateEl('inStockCount', inStock);
            updateEl('lowStockCount', lowStock);
            updateEl('outOfStockCount', outOfStock);
            updateEl('totalTrend', totalProducts + ' items');

            // Load categories for filter
            var categories = [];
            var seen = {};
            products.forEach(function(p) {
                if (p.categoryName && !seen[p.categoryName]) {
                    seen[p.categoryName] = true;
                    categories.push(p.categoryName);
                }
            });
            categories.sort();
            var categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(function(c) { return '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>'; }).join('');
            }

            renderStockTable(products);
            renderCategorySummary(products);
            renderStockChart(inStock, lowStock, outOfStock);

        } catch (error) {
            console.error('Failed to load stock data:', error);
            var tbody = document.getElementById('stockTableBody');
            if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4" style="color: var(--error);">Failed to load stock data. Please refresh the page.</td></tr>';
        }
    }

    function updateEl(id, value) {
        var el = document.getElementById(id);
        if (el) el.textContent = value;
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function renderStockChart(inStock, lowStock, outOfStock) {
        var ctx = document.getElementById('stockDistributionChart');
        if (!ctx) return;

        if (stockChart) { stockChart.destroy(); stockChart = null; }

        stockChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                datasets: [{
                    data: [inStock, lowStock, outOfStock],
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        var legend = document.getElementById('stockChartLegend');
        if (legend) {
            legend.innerHTML =
                '<div class="chart-legend-item"><span class="chart-legend-dot" style="background: #10B981;"></span>In Stock (' + inStock + ')</div>' +
                '<div class="chart-legend-item"><span class="chart-legend-dot" style="background: #F59E0B;"></span>Low Stock (' + lowStock + ')</div>' +
                '<div class="chart-legend-item"><span class="chart-legend-dot" style="background: #EF4444;"></span>Out of Stock (' + outOfStock + ')</div>';
        }
    }

    function renderStockTable(products) {
        var tbody = document.getElementById('stockTableBody');
        if (!tbody) return;

        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4" style="color: var(--gray-400);">No products found</td></tr>';
            return;
        }

        tbody.innerHTML = products.map(function(p) {
            var stock = p.stockQuantity || 0;
            var reorder = p.reorderLevel || STOCK_LEVEL_THRESHOLD;
            var maxStock = p.maxStockLevel || (reorder * 3);
            var percentage = Math.min((stock / maxStock) * 100, 100);
            var statusClass, statusText, barColor;

            if (stock === 0) {
                statusClass = 'badge-error'; statusText = 'Out of Stock'; barColor = '#EF4444';
            } else if (stock <= STOCK_LEVEL_THRESHOLD) {
                statusClass = 'badge-warning'; statusText = 'Low Stock'; barColor = '#F59E0B';
            } else {
                statusClass = 'badge-success'; statusText = 'In Stock'; barColor = '#10B981';
            }

            var stockColor = stock === 0 ? 'var(--error)' : stock <= LOW_STOCK_THRESHOLD ? 'var(--warning)' : 'var(--success)';
            var safeName = escapeHtml(p.productName || '');

            return '<tr>' +
                '<td><strong>' + escapeHtml(p.sku || 'N/A') + '</strong></td>' +
                '<td style="font-weight: 500; color: var(--gray-800);">' + safeName + '</td>' +
                '<td>' + escapeHtml(p.categoryName || 'Uncategorized') + '</td>' +
                '<td class="text-center"><span style="font-weight: 600; color: ' + stockColor + ';">' + stock + '</span></td>' +
                '<td class="text-center">' + reorder + '</td>' +
                '<td><div style="background: var(--gray-100); border-radius: 10px; height: 8px; overflow: hidden;">' +
                    '<div style="background: ' + barColor + '; height: 100%; width: ' + percentage + '%; border-radius: 10px; transition: width 0.3s ease;"></div>' +
                '</div></td>' +
                '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                '<td class="text-center">' +
                    '<div class="btn-group btn-group-sm">' +
                        '<button class="btn btn-outline-success btn-sm" onclick="quickAddStock(' + p.productId + ')" title="Add Stock">' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
                        '</button>' +
                        '<button class="btn btn-outline-warning btn-sm" onclick="quickRemoveStock(' + p.productId + ')" title="Remove Stock">' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
                        '</button>' +
                    '</div>' +
                '</td>' +
            '</tr>';
        }).join('');
        if (typeof initPagination === 'function') initPagination('stockTableBody', 'stockPagination', 10);
    }

    function renderCategorySummary(products) {
        var categoryStats = {};
        products.forEach(function(p) {
            var cat = p.categoryName || 'Uncategorized';
            if (!categoryStats[cat]) {
                categoryStats[cat] = { total: 0, inStock: 0, lowStock: 0, outOfStock: 0, value: 0 };
            }
            categoryStats[cat].total++;
            var stock = p.stockQuantity || 0;
            if (stock === 0) categoryStats[cat].outOfStock++;
            else if (stock <= STOCK_LEVEL_THRESHOLD) categoryStats[cat].lowStock++;
            else categoryStats[cat].inStock++;
            categoryStats[cat].value += (stock * (p.costPrice || p.sellingPrice || 0));
        });

        var tbody = document.getElementById('stockCategoryBody');
        if (!tbody) return;

        var entries = Object.entries(categoryStats);
        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4" style="color: var(--gray-400);">No category data available</td></tr>';
            return;
        }

        tbody.innerHTML = entries.map(function(entry) {
            var cat = entry[0];
            var stats = entry[1];
            return '<tr>' +
                '<td style="font-weight: 600; color: var(--gray-800);">' + escapeHtml(cat) + '</td>' +
                '<td class="text-center">' + stats.total + '</td>' +
                '<td class="text-center"><span style="color: var(--success); font-weight: 500;">' + stats.inStock + '</span></td>' +
                '<td class="text-center"><span style="color: var(--warning); font-weight: 500;">' + stats.lowStock + '</span></td>' +
                '<td class="text-center"><span style="color: var(--error); font-weight: 500;">' + stats.outOfStock + '</span></td>' +
                '<td class="text-end" style="font-weight: 500;">' + Format.currency(stats.value) + '</td>' +
            '</tr>';
        }).join('');
    }

    function filterStock() {
        if (typeof resetPagination === 'function') resetPagination('stockPagination');
        var category = document.getElementById('categoryFilter').value;
        var status = document.getElementById('statusFilter').value;
        var filtered = allProducts;

        if (category) {
            filtered = filtered.filter(function(p) { return p.categoryName === category; });
        }
        if (status === 'in-stock') {
            filtered = filtered.filter(function(p) { return (p.stockQuantity || 0) > STOCK_LEVEL_THRESHOLD; });
        } else if (status === 'low-stock') {
            filtered = filtered.filter(function(p) { var s = p.stockQuantity || 0; return s > 0 && s <= STOCK_LEVEL_THRESHOLD; });
        } else if (status === 'out-stock') {
            filtered = filtered.filter(function(p) { return (p.stockQuantity || 0) === 0; });
        }

        renderStockTable(filtered);
    }

    function adjustStock() {
        var select = document.getElementById('adjustProductId');
        if (select) {
            select.innerHTML = '<option value="">Select Product</option>' +
                allProducts.map(function(p) {
                    return '<option value="' + p.productId + '">' + escapeHtml(p.productName) + ' (Stock: ' + (p.stockQuantity || 0) + ')</option>';
                }).join('');
        }
        var form = document.getElementById('stockAdjustmentForm');
        if (form) form.reset();

        var modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
        modal.show();
    }

    async function submitStockAdjustment() {
        var productId = document.getElementById('adjustProductId').value;
        var adjustType = document.getElementById('adjustType').value;
        var quantity = document.getElementById('adjustQuantity').value;
        var reason = document.getElementById('adjustReason').value;

        if (!productId || !quantity || parseInt(quantity) <= 0) {
            Toast.error('Please fill in all required fields');
            return;
        }

        try {
            var response = await fetch('/api/stock-adjustments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: parseInt(productId),
                    adjustmentType: adjustType,
                    quantity: parseInt(quantity),
                    reason: reason || 'Manual adjustment'
                })
            });
            var result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Failed');

            Toast.success('Stock adjustment saved successfully!');
            var modalEl = document.getElementById('stockAdjustmentModal');
            var modalInst = bootstrap.Modal.getInstance(modalEl);
            if (modalInst) modalInst.hide();
            await loadStockData();
        } catch (error) {
            Toast.error('Failed to save stock adjustment: ' + (error.message || 'Unknown error'));
        }
    }

    function getProductById(id) {
        return allProducts.find(function(p) { return p.productId === id; });
    }

    async function quickAddStock(productId) {
        var product = getProductById(productId);
        var name = product ? product.productName : 'Product';
        var quantity = prompt('Enter quantity to add for ' + name + ':', '10');
        if (quantity && parseInt(quantity) > 0) {
            try {
                var response = await fetch('/api/stock-adjustments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: productId,
                        adjustmentType: 'Add',
                        quantity: parseInt(quantity),
                        reason: 'Quick stock addition'
                    })
                });
                if (!response.ok) throw new Error('Failed');
                Toast.success('Added ' + quantity + ' units to ' + name);
                await loadStockData();
            } catch (error) {
                Toast.error('Failed to add stock');
            }
        }
    }

    async function quickRemoveStock(productId) {
        var product = getProductById(productId);
        var name = product ? product.productName : 'Product';
        var quantity = prompt('Enter quantity to remove from ' + name + ':', '1');
        if (quantity && parseInt(quantity) > 0) {
            try {
                var response = await fetch('/api/stock-adjustments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: productId,
                        adjustmentType: 'Subtract',
                        quantity: parseInt(quantity),
                        reason: 'Quick stock removal'
                    })
                });
                if (!response.ok) throw new Error('Failed');
                Toast.success('Removed ' + quantity + ' units from ' + name);
                await loadStockData();
            } catch (error) {
                Toast.error('Failed to remove stock');
            }
        }
    }
</script>
}
