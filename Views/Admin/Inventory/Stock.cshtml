@{
    ViewData["Title"] = "Stock Levels";
}

<div class="page-header">
    <h1 class="page-title">Stock Levels</h1>
    <p class="page-subtitle">Monitor inventory stock levels across all products</p>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Products</span>
            <span class="stat-value" id="totalProducts">0</span>
        </div>
        <div class="stat-icon teal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">In Stock</span>
            <span class="stat-value" id="inStockCount">0</span>
        </div>
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Low Stock (≤15)</span>
            <span class="stat-value" id="lowStockCount">0</span>
        </div>
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Out of Stock</span>
            <span class="stat-value" id="outOfStockCount">0</span>
        </div>
        <div class="stat-icon" style="background: var(--error-bg); color: var(--error);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
    </div>
</div>

<!-- Stock Level Filter -->
<div class="card mb-4 fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Stock Inventory</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="categoryFilter" style="width: auto;" onchange="filterStock()">
                <option value="">All Categories</option>
            </select>
            <select class="form-select form-select-sm" id="statusFilter" style="width: auto;" onchange="filterStock()">
                <option value="">All Status</option>
                <option value="in-stock">In Stock</option>
                <option value="low-stock">Low Stock (≤15)</option>
                <option value="out-stock">Out of Stock</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="adjustStock()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Adjust Stock
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table" id="stockTable">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Max Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    <!-- Dynamic content loaded from products -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Stock by Category Summary -->
<div class="card fade-in">
    <div class="card-header">
        <h3 class="card-title">Stock by Category</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="data-table" id="stockByCategoryTable">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Total Items</th>
                    <th>In Stock</th>
                    <th>Low Stock</th>
                    <th>Out of Stock</th>
                    <th>Stock Value</th>
                </tr>
            </thead>
            <tbody id="stockCategoryBody">
                <!-- Dynamic content loaded from products -->
            </tbody>
        </table>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockAdjustmentForm">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <select class="form-select" id="adjustProductId" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Adjustment Type</label>
                        <select class="form-select" id="adjustType" required>
                            <option value="Add">Add Stock</option>
                            <option value="Subtract">Remove Stock</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="adjustQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="adjustReason" rows="2" placeholder="Reason for adjustment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStockAdjustment()">Submit Adjustment</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/admin.js"></script>
<script>
    const LOW_STOCK_THRESHOLD = 15; // Low stock alert threshold
    let allProducts = [];
    
    document.addEventListener('DOMContentLoaded', async function() {
        await loadStockData();
    });

    async function loadStockData() {
        try {
            const products = await API.get('/products');
            allProducts = products;
            
            // Calculate totals with threshold 15
            const totalProducts = products.length;
            const outOfStock = products.filter(p => p.stockQuantity === 0).length;
            const lowStock = products.filter(p => p.stockQuantity > 0 && p.stockQuantity <= LOW_STOCK_THRESHOLD).length;
            const inStock = products.filter(p => p.stockQuantity > LOW_STOCK_THRESHOLD).length;
            
            // Update stat cards
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('inStockCount').textContent = inStock;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('outOfStockCount').textContent = outOfStock;
            
            // Load categories for filter
            const categories = [...new Set(products.map(p => p.categoryName).filter(c => c))];
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Render stock table
            renderStockTable(products);
            
            // Group by category for summary
            const categoryStats = {};
            products.forEach(p => {
                const cat = p.categoryName || 'Uncategorized';
                if (!categoryStats[cat]) {
                    categoryStats[cat] = { total: 0, inStock: 0, lowStock: 0, outOfStock: 0, value: 0 };
                }
                categoryStats[cat].total++;
                if (p.stockQuantity === 0) categoryStats[cat].outOfStock++;
                else if (p.stockQuantity <= LOW_STOCK_THRESHOLD) categoryStats[cat].lowStock++;
                else categoryStats[cat].inStock++;
                categoryStats[cat].value += (p.stockQuantity * (p.costPrice || p.price || 0));
            });
            
            // Render category summary table
            const tbody = document.getElementById('stockCategoryBody');
            tbody.innerHTML = Object.entries(categoryStats).map(([cat, stats]) => `
                <tr>
                    <td><strong>${cat}</strong></td>
                    <td>${stats.total}</td>
                    <td><span class="text-success">${stats.inStock}</span></td>
                    <td><span class="text-warning">${stats.lowStock}</span></td>
                    <td><span class="text-error">${stats.outOfStock}</span></td>
                    <td>${Format.currency(stats.value)}</td>
                </tr>
            `).join('');
            
            if (Object.keys(categoryStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No products found</td></tr>';
            }
            
            // Check for low stock and create alerts
            await checkAndCreateLowStockAlerts(products);
            
        } catch (error) {
            console.error('Failed to load stock data:', error);
            Toast.error('Failed to load stock data');
        }
    }

    function renderStockTable(products) {
        const tbody = document.getElementById('stockTableBody');
        
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No products found</td></tr>';
            return;
        }
        
        tbody.innerHTML = products.map(p => {
            let statusClass, statusText;
            if (p.stockQuantity === 0) {
                statusClass = 'badge-error';
                statusText = 'Out of Stock';
            } else if (p.stockQuantity <= LOW_STOCK_THRESHOLD) {
                statusClass = 'badge-warning';
                statusText = 'Low Stock';
            } else {
                statusClass = 'badge-success';
                statusText = 'In Stock';
            }
            
            const stockClass = p.stockQuantity === 0 ? 'text-error' : 
                              p.stockQuantity <= LOW_STOCK_THRESHOLD ? 'text-warning' : 'text-success';
            
            return `
                <tr data-id="${p.productId}" data-category="${p.categoryName || ''}" data-status="${statusText.toLowerCase().replace(' ', '-')}">
                    <td>${p.sku || 'N/A'}</td>
                    <td><strong>${p.productName}</strong></td>
                    <td>${p.categoryName || 'Uncategorized'}</td>
                    <td><span class="${stockClass} fw-600">${p.stockQuantity}</span></td>
                    <td>${p.reorderLevel || LOW_STOCK_THRESHOLD}</td>
                    <td>${p.maxStockLevel || '-'}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success btn-sm" onclick="quickAddStock(${p.productId}, '${p.productName}')" title="Add Stock">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="quickRemoveStock(${p.productId}, '${p.productName}')" title="Remove Stock">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterStock() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let filtered = allProducts;
        
        if (category) {
            filtered = filtered.filter(p => p.categoryName === category);
        }
        
        if (status) {
            filtered = filtered.filter(p => {
                if (status === 'in-stock') return p.stockQuantity > LOW_STOCK_THRESHOLD;
                if (status === 'low-stock') return p.stockQuantity > 0 && p.stockQuantity <= LOW_STOCK_THRESHOLD;
                if (status === 'out-stock') return p.stockQuantity === 0;
                return true;
            });
        }
        
        renderStockTable(filtered);
    }

    async function checkAndCreateLowStockAlerts(products) {
        // Check products with low stock (≤15) and create alerts if not already created
        const lowStockProducts = products.filter(p => p.stockQuantity <= LOW_STOCK_THRESHOLD && p.stockQuantity > 0);
        const outOfStockProducts = products.filter(p => p.stockQuantity === 0);
        
        // Update notification badge
        const totalAlerts = lowStockProducts.length + outOfStockProducts.length;
        if (totalAlerts > 0) {
            const badge = document.querySelector('.topbar-badge');
            if (badge) {
                badge.textContent = totalAlerts;
                badge.style.display = 'flex';
            }
            
            // Create stock alerts via API
            for (const product of lowStockProducts) {
                try {
                    await API.post('/stock-alerts', {
                        productId: product.productId,
                        alertType: 'Low Stock',
                        currentStock: product.stockQuantity,
                        thresholdLevel: LOW_STOCK_THRESHOLD
                    });
                } catch (e) {
                    // Alert may already exist
                }
            }
            
            for (const product of outOfStockProducts) {
                try {
                    await API.post('/stock-alerts', {
                        productId: product.productId,
                        alertType: 'Out of Stock',
                        currentStock: 0,
                        thresholdLevel: LOW_STOCK_THRESHOLD
                    });
                } catch (e) {
                    // Alert may already exist
                }
            }
        }
    }

    function adjustStock() {
        // Populate products dropdown
        const select = document.getElementById('adjustProductId');
        select.innerHTML = '<option value="">Select Product</option>' +
            allProducts.map(p => `<option value="${p.productId}">${p.productName} (Stock: ${p.stockQuantity})</option>`).join('');
        
        document.getElementById('stockAdjustmentForm').reset();
        var modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
        modal.show();
    }

    async function submitStockAdjustment() {
        const productId = document.getElementById('adjustProductId').value;
        const adjustType = document.getElementById('adjustType').value;
        const quantity = document.getElementById('adjustQuantity').value;
        const reason = document.getElementById('adjustReason').value;
        
        if (!productId || !quantity) {
            Toast.error('Please fill in all required fields');
            return;
        }
        
        try {
            await API.post('/stock-adjustments', {
                productId: parseInt(productId),
                adjustmentType: adjustType,
                quantity: parseInt(quantity),
                reason: reason || 'Manual adjustment'
            });
            
            Toast.success('Stock adjustment saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal')).hide();
            await loadStockData(); // Refresh data
        } catch (error) {
            Toast.error('Failed to save stock adjustment: ' + error.message);
        }
    }

    async function quickAddStock(productId, productName) {
        const quantity = prompt(`Enter quantity to add for ${productName}:`, '10');
        if (quantity && parseInt(quantity) > 0) {
            try {
                await API.post('/stock-adjustments', {
                    productId: productId,
                    adjustmentType: 'Add',
                    quantity: parseInt(quantity),
                    reason: 'Quick stock addition'
                });
                Toast.success(`Added ${quantity} units to ${productName}`);
                await loadStockData();
            } catch (error) {
                Toast.error('Failed to add stock');
            }
        }
    }

    async function quickRemoveStock(productId, productName) {
        const quantity = prompt(`Enter quantity to remove from ${productName}:`, '1');
        if (quantity && parseInt(quantity) > 0) {
            try {
                await API.post('/stock-adjustments', {
                    productId: productId,
                    adjustmentType: 'Subtract',
                    quantity: parseInt(quantity),
                    reason: 'Quick stock removal'
                });
                Toast.success(`Removed ${quantity} units from ${productName}`);
                await loadStockData();
            } catch (error) {
                Toast.error('Failed to remove stock');
            }
        }
    }
</script>
}
