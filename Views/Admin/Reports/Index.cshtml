@{
    ViewData["Title"] = "Company Reports";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <p class="text-muted mb-0">Reports</p>
            <h1 class="page-title">Company Reports</h1>
            <p class="page-subtitle">Generate and view company-level reports and analytics.</p>
        </div>
        <button class="btn btn-primary" onclick="exportAllReports()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export All
        </button>
    </div>
</div>

<!-- Report Period Filter -->
<div class="card fade-in mb-3">
    <div class="card-body">
        <div class="d-flex gap-3 align-items-end flex-wrap">
            <div class="form-group mb-0">
                <label class="form-label">Report Period</label>
                <select class="form-control" id="reportPeriod" onchange="loadReportData()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last 12 Months</option>
                </select>
            </div>
            <div class="form-group mb-0">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate">
            </div>
            <div class="form-group mb-0">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate">
            </div>
            <button class="btn btn-primary" onclick="loadReportData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                Generate
            </button>
        </div>
    </div>
</div>

<!-- KPI Summary -->
<div class="stat-cards">
    <div class="stat-card fade-in stagger-1">
        <div class="stat-info">
            <span class="stat-label">Total Revenue</span>
            <span class="stat-value" id="rptRevenue">₱0</span>
            <div class="stat-trend up"><span>this period</span></div>
        </div>
        <div class="stat-icon teal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-2">
        <div class="stat-info">
            <span class="stat-label">Total Orders</span>
            <span class="stat-value" id="rptOrders">0</span>
            <div class="stat-trend up"><span>this period</span></div>
        </div>
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-3">
        <div class="stat-info">
            <span class="stat-label">New Customers</span>
            <span class="stat-value" id="rptNewCustomers">0</span>
            <div class="stat-trend up"><span>this period</span></div>
        </div>
        <div class="stat-icon blue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-4">
        <div class="stat-info">
            <span class="stat-label">Support Tickets</span>
            <span class="stat-value" id="rptTickets">0</span>
            <div class="stat-trend"><span>this period</span></div>
        </div>
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
            </svg>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-2 mt-3">
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Revenue Trend</h3>
                <p class="card-subtitle">Revenue over time</p>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container"><canvas id="revenueTrendChart"></canvas></div>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Orders by Status</h3>
                <p class="card-subtitle">Order distribution</p>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height:250px;"><canvas id="orderStatusChart"></canvas></div>
        </div>
    </div>
</div>

<div class="grid grid-2 mt-3">
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Top Selling Products</h3>
                <p class="card-subtitle">By quantity sold</p>
            </div>
        </div>
        <div class="card-body" style="padding:0;">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead><tr><th>Product</th><th class="text-center">Qty Sold</th><th class="text-end">Revenue</th></tr></thead>
                    <tbody id="topProductsTable"><tr><td colspan="3" class="text-center py-4">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Department Performance</h3>
                <p class="card-subtitle">Staff activity by module</p>
            </div>
        </div>
        <div class="card-body" style="padding:0;">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead><tr><th>Department</th><th class="text-center">Actions</th><th class="text-center">Active Staff</th></tr></thead>
                    <tbody id="deptPerfTable"><tr><td colspan="3" class="text-center py-4">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/admin.js"></script>
    <script>
        let revenueTrendChart = null;
        let orderStatusChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const now = new Date();
            const thirtyAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('toDate').value = now.toISOString().split('T')[0];
            document.getElementById('fromDate').value = thirtyAgo.toISOString().split('T')[0];
            loadReportData();
        });

        function getDateRange() {
            const fromEl = document.getElementById('fromDate');
            const toEl = document.getElementById('toDate');
            const periodEl = document.getElementById('reportPeriod');

            // If custom dates are set and differ from period default, use them
            let fromDate, toDate;
            const now = new Date();
            toDate = toEl.value ? new Date(toEl.value + 'T23:59:59') : now;

            if (fromEl.value) {
                fromDate = new Date(fromEl.value + 'T00:00:00');
            } else {
                const days = parseInt(periodEl.value) || 30;
                fromDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
            }

            return { fromDate, toDate };
        }

        // Update date inputs when period dropdown changes
        document.getElementById('reportPeriod')?.addEventListener('change', function() {
            const days = parseInt(this.value) || 30;
            const now = new Date();
            const from = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
            document.getElementById('fromDate').value = from.toISOString().split('T')[0];
            document.getElementById('toDate').value = now.toISOString().split('T')[0];
        });

        async function loadReportData() {
            try {
                const [orders, customers, products, tickets, users] = await Promise.all([
                    fetch('/api/orders').then(r=>r.json()).catch(()=>[]),
                    fetch('/api/customers').then(r=>r.json()).catch(()=>[]),
                    fetch('/api/products').then(r=>r.json()).catch(()=>[]),
                    fetch('/api/tickets').then(r=>r.json()).catch(()=>[]),
                    fetch('/api/users').then(r=>r.json()).catch(()=>[])
                ]);

                const { fromDate, toDate } = getDateRange();

                // Filter by date range
                const filteredOrders = orders.filter(o => {
                    const d = new Date(o.orderDate);
                    return d >= fromDate && d <= toDate;
                });
                const filteredCustomers = customers.filter(c => {
                    const d = new Date(c.createdAt);
                    return d >= fromDate && d <= toDate;
                });
                const filteredTickets = tickets.filter(t => {
                    const d = new Date(t.createdAt);
                    return d >= fromDate && d <= toDate;
                });

                // KPI summary
                const revenue = filteredOrders.reduce((s,o)=>s+(o.totalAmount||0),0);
                document.getElementById('rptRevenue').textContent = '₱' + revenue.toLocaleString('en-PH',{minimumFractionDigits:2});
                document.getElementById('rptOrders').textContent = filteredOrders.length;
                document.getElementById('rptNewCustomers').textContent = filteredCustomers.length;
                document.getElementById('rptTickets').textContent = filteredTickets.length;

                renderRevenueTrend(filteredOrders, fromDate, toDate);
                renderOrderStatus(filteredOrders);
                renderTopProducts(filteredOrders);
                renderDeptPerf(filteredOrders, filteredTickets, users);
            } catch(e) { console.error(e); }
        }

        function renderRevenueTrend(orders, fromDate, toDate) {
            const ctx = document.getElementById('revenueTrendChart')?.getContext('2d');
            if(!ctx) return;
            if (revenueTrendChart) revenueTrendChart.destroy();

            // Group by day or month depending on range
            const rangeDays = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24));
            let labels = [], data = [];

            if (rangeDays <= 31) {
                // Daily grouping
                const daily = {};
                for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                    const key = d.toISOString().split('T')[0];
                    daily[key] = 0;
                }
                orders.forEach(o => {
                    const key = new Date(o.orderDate).toISOString().split('T')[0];
                    if (daily[key] !== undefined) daily[key] += o.totalAmount || 0;
                });
                labels = Object.keys(daily).map(d => new Date(d).toLocaleDateString('en-PH', {month:'short',day:'numeric'}));
                data = Object.values(daily);
            } else {
                // Monthly grouping
                const monthly = {};
                orders.forEach(o => {
                    const d = new Date(o.orderDate);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    monthly[key] = (monthly[key] || 0) + (o.totalAmount || 0);
                });
                const sortedKeys = Object.keys(monthly).sort();
                labels = sortedKeys.map(k => {
                    const [y,m] = k.split('-');
                    return new Date(y, m-1).toLocaleDateString('en-PH', {month:'short',year:'2-digit'});
                });
                data = sortedKeys.map(k => monthly[k]);
            }

            revenueTrendChart = new Chart(ctx,{type:'line',data:{labels,
                datasets:[{label:'Revenue',data,borderColor:'#008080',backgroundColor:'rgba(0,128,128,0.1)',fill:true,tension:0.4}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
                scales:{y:{beginAtZero:true,ticks:{callback:v=>'₱'+(v>=1000?(v/1000).toFixed(0)+'k':v.toFixed(0))}},x:{grid:{display:false}}}}});
        }

        function renderOrderStatus(orders) {
            const ctx = document.getElementById('orderStatusChart')?.getContext('2d');
            if(!ctx) return;
            if (orderStatusChart) orderStatusChart.destroy();

            const statuses = {};
            orders.forEach(o=>{statuses[o.orderStatus||'Unknown']=(statuses[o.orderStatus||'Unknown']||0)+1;});
            orderStatusChart = new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(statuses),
                datasets:[{data:Object.values(statuses),backgroundColor:['#008080','#10B981','#F59E0B','#EF4444','#3B82F6','#8B5CF6'],borderWidth:0,cutout:'65%'}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
        }

        function renderTopProducts(orders) {
            const tbody = document.getElementById('topProductsTable');
            
            // Aggregate items from orders to get actual sales data
            const productSales = {};
            orders.forEach(o => {
                if (o.items && Array.isArray(o.items)) {
                    o.items.forEach(item => {
                        const name = item.productName || 'Unknown Product';
                        if (!productSales[name]) {
                            productSales[name] = { qty: 0, revenue: 0 };
                        }
                        productSales[name].qty += item.quantity || 0;
                        productSales[name].revenue += (item.quantity || 0) * (item.unitPrice || 0);
                    });
                }
            });

            const sorted = Object.entries(productSales)
                .sort((a,b) => b[1].qty - a[1].qty)
                .slice(0, 5);

            if (!sorted.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">No sales data in this period</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(([name, data]) => `
                <tr>
                    <td><strong>${name}</strong></td>
                    <td class="text-center">${data.qty}</td>
                    <td class="text-end">₱${data.revenue.toLocaleString('en-PH',{minimumFractionDigits:2})}</td>
                </tr>
            `).join('');
        }

        function renderDeptPerf(orders, tickets, users) {
            const tbody = document.getElementById('deptPerfTable');
            
            const getStaffCount = (roleIds) => users.filter(u => roleIds.includes(u.roleId) && u.isActive).length;

            const depts = [
                { name: 'Sales', actions: orders.length, staff: getStaffCount([3]) },
                { name: 'Support', actions: tickets.length, staff: getStaffCount([4]) },
                { name: 'Marketing', actions: '-', staff: getStaffCount([5]) },
                { name: 'Billing', actions: orders.filter(o => o.paymentStatus === 'Paid').length, staff: getStaffCount([6]) },
                { name: 'Inventory', actions: '-', staff: getStaffCount([8]) }
            ];
            
            tbody.innerHTML = depts.map(d => `
                <tr>
                    <td><strong>${d.name}</strong></td>
                    <td class="text-center">${d.actions}</td>
                    <td class="text-center">${d.staff}</td>
                </tr>
            `).join('');
        }

        function exportAllReports() {
            const { fromDate, toDate } = getDateRange();
            const period = `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;

            const revenue = document.getElementById('rptRevenue')?.textContent || '₱0';
            const orderCount = document.getElementById('rptOrders')?.textContent || '0';
            const newCust = document.getElementById('rptNewCustomers')?.textContent || '0';
            const ticketCount = document.getElementById('rptTickets')?.textContent || '0';

            // Get top products table data
            const prodRows = Array.from(document.querySelectorAll('#topProductsTable tr')).map(tr => {
                const cells = tr.querySelectorAll('td');
                return cells.length >= 3 ? `"${cells[0].textContent.trim()}","${cells[1].textContent.trim()}","${cells[2].textContent.trim()}"` : null;
            }).filter(Boolean);

            const csv = [
                'CompuGear Company Report',
                `Period: ${period}`,
                '',
                'KPI Summary',
                `Total Revenue,${revenue}`,
                `Total Orders,${orderCount}`,
                `New Customers,${newCust}`,
                `Support Tickets,${ticketCount}`,
                '',
                'Top Selling Products',
                'Product,Qty Sold,Revenue',
                ...prodRows
            ];

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `company-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            Toast.success('Report exported to CSV');
        }
    </script>
}
