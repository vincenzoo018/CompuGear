@{
    ViewData["Title"] = "Sales Reports";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Sales Reports</h1>
        <p class="page-subtitle">Analyze sales performance and trends</p>
    </div>
    <button class="btn btn-primary" onclick="generateAdminPdfReport()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/>
        </svg>
        Generate Report PDF
    </button>
</div>

<!-- Period Filter -->
<div class="card mb-4 fade-in">
    <div class="card-body py-3">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="fw-semibold text-muted">Filter Period:</span>
            <div class="btn-group" role="group" id="adminPeriodFilter">
                <button type="button" class="btn btn-outline-primary" data-period="day" onclick="setAdminPeriod('day')">Today</button>
                <button type="button" class="btn btn-outline-primary" data-period="week" onclick="setAdminPeriod('week')">This Week</button>
                <button type="button" class="btn btn-outline-primary active" data-period="month" onclick="setAdminPeriod('month')">This Month</button>
                <button type="button" class="btn btn-outline-primary" data-period="year" onclick="setAdminPeriod('year')">This Year</button>
                <button type="button" class="btn btn-outline-primary" data-period="all" onclick="setAdminPeriod('all')">All Time</button>
            </div>
            <span class="badge bg-primary ms-auto" id="adminPeriodLabel">This Month</span>
        </div>
    </div>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Revenue</span>
            <span class="stat-value" id="periodRevenue">₱0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="revenueInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Orders</span>
            <span class="stat-value" id="periodOrders">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="ordersInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Completed Orders</span>
            <span class="stat-value" id="periodCompleted">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="completedInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Avg Order Value</span>
            <span class="stat-value" id="avgOrderValue">₱0</span>
        </div>
    </div>
</div>

<div class="card fade-in">
    <div class="card-header">
        <h3 class="card-title">Monthly Sales Performance</h3>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function() {
        var allOrders = [];
        var currentPeriod = 'month';
        var salesChart = null;

        function normalizeStatus(status) {
            return (status || '').toString().trim().toLowerCase();
        }

        function isRevenueStatus(status) {
            var s = normalizeStatus(status);
            return s === 'confirmed' || s === 'processing' || s === 'completed' || s === 'delivered' || s === 'shipped';
        }

        function isCompletedStatus(status) {
            var s = normalizeStatus(status);
            return s === 'completed' || s === 'delivered';
        }

        function formatCurrency(amount) {
            return '₱' + parseFloat(amount || 0).toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function setText(id, txt) {
            var el = document.getElementById(id);
            if (el) el.textContent = String(txt);
        }

        function safeDate(value) {
            if (!value) return null;
            var parsed = new Date(value);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function filterByPeriod(orders, period) {
            if (!orders || !orders.length) return [];
            var now = new Date();
            var startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var start;

            switch (period) {
                case 'day':
                    start = startOfToday;
                    break;
                case 'week':
                    start = new Date(startOfToday);
                    start.setDate(start.getDate() - start.getDay());
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return orders;
            }

            return orders.filter(function(order) {
                var d = safeDate(order.orderDate);
                return d && d >= start;
            });
        }

        function loadReport() {
            setText('revenueInfo', 'Loading...');
            setText('ordersInfo', 'Loading...');
            setText('completedInfo', 'Loading...');

            fetch('/api/orders', {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(result) {
                if (Array.isArray(result)) {
                    allOrders = result;
                } else if (result && Array.isArray(result.data)) {
                    allOrders = result.data;
                } else {
                    allOrders = [];
                }
                updateReport();
            })
            .catch(function(error) {
                console.error('Failed to load sales report:', error);
                allOrders = [];
                updateReport();
                setText('revenueInfo', 'Failed to load data');
                setText('ordersInfo', 'Failed to load data');
                setText('completedInfo', 'Failed to load data');
            });
        }

        function updateReport() {
            var filtered = filterByPeriod(allOrders, currentPeriod);
            var revenueOrders = filtered.filter(function(o) { return isRevenueStatus(o.orderStatus); });
            var revenue = revenueOrders.reduce(function(total, o) { return total + (parseFloat(o.totalAmount) || 0); }, 0);
            var completed = filtered.filter(function(o) { return isCompletedStatus(o.orderStatus); }).length;
            var avgOrderValue = revenueOrders.length ? (revenue / revenueOrders.length) : 0;
            var completionRate = filtered.length ? ((completed / filtered.length) * 100) : 0;

            setText('periodRevenue', formatCurrency(revenue));
            setText('periodOrders', filtered.length);
            setText('periodCompleted', completed);
            setText('avgOrderValue', formatCurrency(avgOrderValue));
            setText('revenueInfo', revenueOrders.length + ' confirmed+ orders');
            setText('ordersInfo', completed + ' completed');
            setText('completedInfo', completionRate.toFixed(0) + '% completion rate');

            renderChart();
        }

        function renderChart() {
            var canvas = document.getElementById('salesChart');
            if (!canvas) return;
            if (typeof Chart === 'undefined') {
                canvas.parentElement.innerHTML = '<div class="alert alert-warning text-center">Chart library not available</div>';
                return;
            }

            var currentYear = new Date().getFullYear();
            var monthlyData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            allOrders.forEach(function(order) {
                var date = safeDate(order.orderDate);
                if (!date || date.getFullYear() !== currentYear) return;
                if (!isRevenueStatus(order.orderStatus)) return;
                monthlyData[date.getMonth()] += parseFloat(order.totalAmount) || 0;
            });

            if (salesChart) salesChart.destroy();

            salesChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Sales (₱)',
                        data: monthlyData,
                        backgroundColor: '#008080',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(v) {
                                    return '₱' + (v >= 1000 ? (v / 1000).toFixed(0) + 'k' : v);
                                }
                            }
                        }
                    }
                }
            });
        }

        window.setAdminPeriod = function(period) {
            currentPeriod = period;

            var buttons = document.querySelectorAll('#adminPeriodFilter .btn');
            buttons.forEach(function(button) { button.classList.remove('active'); });

            var activeButton = document.querySelector('#adminPeriodFilter [data-period="' + period + '"]');
            if (activeButton) activeButton.classList.add('active');

            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            setText('adminPeriodLabel', labels[period] || period);

            updateReport();
        };

        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        window.generateAdminPdfReport = function() {
            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            var periodLabel = labels[currentPeriod] || 'All Time';
            var filtered = filterByPeriod(allOrders, currentPeriod);
            var revenueOrders = filtered.filter(function(o) { return isRevenueStatus(o.orderStatus); });
            var totalRevenue = revenueOrders.reduce(function(total, o) { return total + (parseFloat(o.totalAmount) || 0); }, 0);
            var completedOrders = filtered.filter(function(o) { return isCompletedStatus(o.orderStatus); }).length;
            var avgOrder = revenueOrders.length ? (totalRevenue / revenueOrders.length) : 0;
            var now = new Date();

            var rowsHtml = filtered.map(function(order) {
                var status = normalizeStatus(order.orderStatus);
                var statusClass = 'background:#0dcaf0;color:#333';
                if (status === 'completed' || status === 'delivered') statusClass = 'background:#198754;color:#fff';
                else if (status === 'pending') statusClass = 'background:#ffc107;color:#333';
                else if (status === 'cancelled') statusClass = 'background:#dc3545;color:#fff';

                var payment = normalizeStatus(order.paymentStatus);
                var payClass = 'background:#dc3545;color:#fff';
                if (payment === 'paid') payClass = 'background:#198754;color:#fff';
                else if (payment === 'pending') payClass = 'background:#ffc107;color:#333';

                var orderDate = safeDate(order.orderDate);

                return '<tr>' +
                    '<td><strong>' + escapeHtml(order.orderNumber || '') + '</strong></td>' +
                    '<td>' + escapeHtml(order.customerName || 'Guest') + '</td>' +
                    '<td>' + (orderDate ? orderDate.toLocaleDateString('en-PH') : '-') + '</td>' +
                    '<td style="text-align:center">' + (order.itemCount || 0) + '</td>' +
                    '<td style="text-align:right">' + formatCurrency(order.totalAmount) + '</td>' +
                    '<td style="text-align:center"><span style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;' + statusClass + '">' + escapeHtml(order.orderStatus || '') + '</span></td>' +
                    '<td style="text-align:center"><span style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;' + payClass + '">' + escapeHtml(order.paymentStatus || 'Pending') + '</span></td>' +
                    '</tr>';
            }).join('');

            var html = `
                <html>
                <head>
                    <title>CompuGear Sales Report - ${escapeHtml(periodLabel)}</title>
                    <style>
                        *{margin:0;padding:0;box-sizing:border-box}
                        body{font-family:"Segoe UI",Arial,sans-serif;margin:0;padding:40px;color:#333;font-size:12px}
                        .header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #008080;padding-bottom:20px;margin-bottom:30px}
                        .company h1{color:#008080;font-size:28px;margin-bottom:5px}
                        .company p{color:#666}
                        .report-title{text-align:right}
                        .report-title h2{color:#008080;font-size:20px}
                        .report-title p{color:#666}
                        .summary-cards{display:flex;gap:20px;margin-bottom:30px}
                        .summary-card{flex:1;background:#f8f9fa;border-radius:8px;padding:15px;text-align:center;border-left:4px solid #008080}
                        .summary-card .value{font-size:24px;font-weight:bold;color:#008080}
                        .summary-card .label{color:#666;font-size:11px;text-transform:uppercase}
                        table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px}
                        th{background:#008080;color:white;padding:10px 8px;text-align:left;font-weight:600}
                        td{padding:8px;border-bottom:1px solid #e0e0e0}
                        tr:nth-child(even){background:#f8f9fa}
                        .footer{margin-top:30px;padding-top:15px;border-top:2px solid #e0e0e0;text-align:center;color:#666;font-size:10px}
                        .total-row{font-weight:bold;background:#e8f5f5!important}
                    </style>
                </head>
                <body onload="window.print()">
                    <div class="header">
                        <div class="company"><h1>CompuGear</h1><p>Computer &amp; Gear Solutions</p></div>
                        <div class="report-title">
                            <h2>Sales Report</h2>
                            <p>Period: ${escapeHtml(periodLabel)}</p>
                            <p>Generated: ${now.toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                    </div>
                    <div class="summary-cards">
                        <div class="summary-card"><div class="value">${filtered.length}</div><div class="label">Total Orders</div></div>
                        <div class="summary-card"><div class="value">${formatCurrency(totalRevenue)}</div><div class="label">Total Revenue</div></div>
                        <div class="summary-card"><div class="value">${formatCurrency(avgOrder)}</div><div class="label">Avg Order Value</div></div>
                        <div class="summary-card"><div class="value">${completedOrders}</div><div class="label">Completed Orders</div></div>
                    </div>
                    <h3 style="color:#008080;margin-bottom:15px">Order Details</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th><th>Customer</th><th>Date</th>
                                <th style="text-align:center">Items</th><th style="text-align:right">Amount</th>
                                <th style="text-align:center">Status</th><th style="text-align:center">Payment</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                            <tr class="total-row">
                                <td colspan="4" style="text-align:right"><strong>Grand Total:</strong></td>
                                <td style="text-align:right"><strong>${formatCurrency(totalRevenue)}</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>CompuGear Sales Report &mdash; Generated on ${now.toLocaleString('en-PH')} &mdash; Confidential</p>
                    </div>
                </body>
                </html>`;

            var printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow pop-ups to generate the PDF report.');
                return;
            }

            printWindow.document.write(html);
            printWindow.document.close();
            try {
                printWindow.onload = function() {
                    try { printWindow.focus(); } catch (e) {}
                    try { printWindow.print(); } catch (e) {}
                };
            } catch (e) {}
        };

        loadReport();
    })();
    </script>
}
