@{
    ViewData["Title"] = "Sales Reports";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Sales Reports</h1>
        <p class="page-subtitle">Analyze sales performance and trends</p>
    </div>
    <button class="btn btn-primary" onclick="generateAdminPdfReport()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/>
        </svg>
        Generate Report PDF
    </button>
</div>

<!-- Period Filter -->
<div class="card mb-4 fade-in">
    <div class="card-body py-3">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="fw-semibold text-muted">Filter Period:</span>
            <div class="btn-group" role="group" id="adminPeriodFilter">
                <button type="button" class="btn btn-outline-primary" data-period="day" onclick="setAdminPeriod('day')">Today</button>
                <button type="button" class="btn btn-outline-primary" data-period="week" onclick="setAdminPeriod('week')">This Week</button>
                <button type="button" class="btn btn-outline-primary active" data-period="month" onclick="setAdminPeriod('month')">This Month</button>
                <button type="button" class="btn btn-outline-primary" data-period="year" onclick="setAdminPeriod('year')">This Year</button>
                <button type="button" class="btn btn-outline-primary" data-period="all" onclick="setAdminPeriod('all')">All Time</button>
            </div>
            <span class="badge bg-primary ms-auto" id="adminPeriodLabel">This Month</span>
        </div>
    </div>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Revenue</span>
            <span class="stat-value" id="periodRevenue">₱0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="revenueInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Orders</span>
            <span class="stat-value" id="periodOrders">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="ordersInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Completed Orders</span>
            <span class="stat-value" id="periodCompleted">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="completedInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Avg Order Value</span>
            <span class="stat-value" id="avgOrderValue">₱0</span>
        </div>
    </div>
</div>

<div class="card fade-in">
    <div class="card-header">
        <h3 class="card-title">Monthly Sales Performance</h3>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var salesChart = null;
        var allAdminOrders = [];
        var adminPeriod = 'month';

        document.addEventListener('DOMContentLoaded', function() {
            loadSalesReport();
        });

        function filterByPeriod(orders, period) {
            var now = new Date();
            var startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var result = [];
            var i, d;
            switch (period) {
                case 'day':
                    for (i = 0; i < orders.length; i++) { if (new Date(orders[i].orderDate) >= startOfToday) result.push(orders[i]); }
                    return result;
                case 'week':
                    d = new Date(startOfToday);
                    d.setDate(d.getDate() - d.getDay());
                    for (i = 0; i < orders.length; i++) { if (new Date(orders[i].orderDate) >= d) result.push(orders[i]); }
                    return result;
                case 'month':
                    d = new Date(now.getFullYear(), now.getMonth(), 1);
                    for (i = 0; i < orders.length; i++) { if (new Date(orders[i].orderDate) >= d) result.push(orders[i]); }
                    return result;
                case 'year':
                    d = new Date(now.getFullYear(), 0, 1);
                    for (i = 0; i < orders.length; i++) { if (new Date(orders[i].orderDate) >= d) result.push(orders[i]); }
                    return result;
                default: return orders;
            }
        }

        function setAdminPeriod(period) {
            adminPeriod = period;
            var btns = document.querySelectorAll('#adminPeriodFilter .btn');
            for (var b = 0; b < btns.length; b++) btns[b].classList.remove('active');
            var activeBtn = document.querySelector('#adminPeriodFilter [data-period="' + period + '"]');
            if (activeBtn) activeBtn.classList.add('active');
            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            document.getElementById('adminPeriodLabel').textContent = labels[period] || period;
            updateAdminReport();
        }

        function updateAdminReport() {
            var filtered = filterByPeriod(allAdminOrders, adminPeriod);
            var revenue = 0;
            var completed = 0;
            for (var i = 0; i < filtered.length; i++) {
                revenue += (filtered[i].totalAmount || 0);
                if (filtered[i].orderStatus === 'Completed' || filtered[i].orderStatus === 'Delivered') completed++;
            }
            var avg = filtered.length > 0 ? revenue / filtered.length : 0;

            document.getElementById('periodRevenue').textContent = Format.currency(revenue);
            document.getElementById('periodOrders').textContent = filtered.length;
            document.getElementById('periodCompleted').textContent = completed;
            document.getElementById('avgOrderValue').textContent = Format.currency(avg);
            document.getElementById('revenueInfo').textContent = filtered.length + ' orders in period';
            document.getElementById('ordersInfo').textContent = completed + ' completed';
            document.getElementById('completedInfo').textContent = ((filtered.length > 0 ? (completed / filtered.length * 100) : 0).toFixed(0)) + '% completion rate';

            // Update chart
            var monthlyData = [0,0,0,0,0,0,0,0,0,0,0,0];
            var currentYear = new Date().getFullYear();
            for (var j = 0; j < filtered.length; j++) {
                var d = new Date(filtered[j].orderDate);
                if (d.getFullYear() === currentYear) monthlyData[d.getMonth()] += (filtered[j].totalAmount || 0);
            }

            var ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Sales',
                        data: monthlyData,
                        backgroundColor: '#008080',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: function(v) { return '\u20B1' + (v / 1000).toFixed(0) + 'k'; } } } }
                }
            });
        }

        function loadSalesReport() {
            API.get('/orders').then(function(data) {
                allAdminOrders = data;
                updateAdminReport();
            }).catch(function(error) {
                console.error('Failed to load sales report:', error);
                Toast.error('Failed to load sales report');
            });
        }

        function generateAdminPdfReport() {
            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            var periodLabel = labels[adminPeriod] || 'All Time';
            var filtered = filterByPeriod(allAdminOrders, adminPeriod);
            var totalRevenue = filtered.reduce(function(s, o) { return s + (o.totalAmount || 0); }, 0);
            var avgOrder = filtered.length > 0 ? totalRevenue / filtered.length : 0;
            var completedOrders = 0;
            for (var ci = 0; ci < filtered.length; ci++) {
                if (filtered[ci].orderStatus === 'Completed' || filtered[ci].orderStatus === 'Delivered') completedOrders++;
            }
            var now = new Date();

            var rowsHtml = '';
            for (var ri = 0; ri < filtered.length; ri++) {
                var o = filtered[ri];
                var statusClass = 'bg-info';
                if (o.orderStatus === 'Completed' || o.orderStatus === 'Delivered') statusClass = 'bg-success';
                else if (o.orderStatus === 'Pending') statusClass = 'bg-warning';
                else if (o.orderStatus === 'Cancelled') statusClass = 'bg-danger';
                var payClass = 'bg-danger';
                if (o.paymentStatus === 'Paid') payClass = 'bg-success';
                else if (o.paymentStatus === 'Pending') payClass = 'bg-warning';

                rowsHtml += '<tr>' +
                    '<td><strong>' + (o.orderNumber || '') + '</strong></td>' +
                    '<td>' + (o.customerName || 'Guest') + '</td>' +
                    '<td>' + new Date(o.orderDate).toLocaleDateString('en-PH') + '</td>' +
                    '<td class="text-center">' + (o.itemCount || 0) + '</td>' +
                    '<td class="text-end">' + Format.currency(o.totalAmount) + '</td>' +
                    '<td class="text-center"><span class="badge ' + statusClass + '">' + (o.orderStatus || '') + '</span></td>' +
                    '<td class="text-center"><span class="badge ' + payClass + '">' + (o.paymentStatus || 'Pending') + '</span></td>' +
                    '</tr>';
            }

            var html = '<html><head><title>CompuGear Sales Report - ' + periodLabel + '</title>' +
                '<style>' +
                '*{margin:0;padding:0;box-sizing:border-box}' +
                'body{font-family:"Segoe UI",Arial,sans-serif;margin:0;padding:40px;color:#333;font-size:12px}' +
                '.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #008080;padding-bottom:20px;margin-bottom:30px}' +
                '.company h1{color:#008080;font-size:28px;margin-bottom:5px}' +
                '.company p{color:#666}' +
                '.report-title{text-align:right}' +
                '.report-title h2{color:#008080;font-size:20px}' +
                '.report-title p{color:#666}' +
                '.summary-cards{display:flex;gap:20px;margin-bottom:30px}' +
                '.summary-card{flex:1;background:#f8f9fa;border-radius:8px;padding:15px;text-align:center;border-left:4px solid #008080}' +
                '.summary-card .value{font-size:24px;font-weight:bold;color:#008080}' +
                '.summary-card .label{color:#666;font-size:11px;text-transform:uppercase}' +
                'table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px}' +
                'th{background:#008080;color:white;padding:10px 8px;text-align:left;font-weight:600}' +
                'td{padding:8px;border-bottom:1px solid #e0e0e0}' +
                'tr:nth-child(even){background:#f8f9fa}' +
                '.text-end{text-align:right}' +
                '.text-center{text-align:center}' +
                '.badge{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;color:white}' +
                '.bg-success{background:#198754}.bg-warning{background:#ffc107;color:#333}.bg-danger{background:#dc3545}.bg-info{background:#0dcaf0;color:#333}.bg-primary{background:#0d6efd}' +
                '.footer{margin-top:30px;padding-top:15px;border-top:2px solid #e0e0e0;text-align:center;color:#666;font-size:10px}' +
                '.total-row{font-weight:bold;background:#e8f5f5!important}' +
                '</style></head><body>' +
                '<div class="header">' +
                '<div class="company"><h1>CompuGear</h1><p>Computer & Gear Solutions</p></div>' +
                '<div class="report-title"><h2>Sales Report</h2><p>Period: ' + periodLabel + '</p><p>Generated: ' + now.toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' }) + '</p></div>' +
                '</div>' +
                '<div class="summary-cards">' +
                '<div class="summary-card"><div class="value">' + filtered.length + '</div><div class="label">Total Orders</div></div>' +
                '<div class="summary-card"><div class="value">' + Format.currency(totalRevenue) + '</div><div class="label">Total Revenue</div></div>' +
                '<div class="summary-card"><div class="value">' + Format.currency(avgOrder) + '</div><div class="label">Avg Order Value</div></div>' +
                '<div class="summary-card"><div class="value">' + completedOrders + '</div><div class="label">Completed Orders</div></div>' +
                '</div>' +
                '<h3 style="color:#008080;margin-bottom:15px">Order Details</h3>' +
                '<table><thead><tr><th>Order #</th><th>Customer</th><th>Date</th><th class="text-center">Items</th><th class="text-end">Amount</th><th class="text-center">Status</th><th class="text-center">Payment</th></tr></thead>' +
                '<tbody>' + rowsHtml +
                '<tr class="total-row"><td colspan="4" class="text-end"><strong>Grand Total:</strong></td><td class="text-end"><strong>' + Format.currency(totalRevenue) + '</strong></td><td colspan="2"></td></tr>' +
                '</tbody></table>' +
                '<div class="footer"><p>CompuGear Sales Report - Generated on ' + now.toLocaleString('en-PH') + ' - Confidential</p></div>' +
                '<' + 'script>window.onload=function(){window.print();}</' + 'script></body></html>';

            var printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        }
    </script>
}
