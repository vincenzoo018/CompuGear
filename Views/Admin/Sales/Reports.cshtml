@{
    ViewData["Title"] = "Sales Reports";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Sales Reports</h1>
        <p class="page-subtitle">Analyze sales performance and trends</p>
    </div>
    <button class="btn btn-primary" onclick="generateAdminPdfReport()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/>
        </svg>
        Generate Report PDF
    </button>
</div>

<!-- Period Filter -->
<div class="card mb-4 fade-in">
    <div class="card-body py-3">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="fw-semibold text-muted">Filter Period:</span>
            <div class="btn-group" role="group" id="adminPeriodFilter">
                <button type="button" class="btn btn-outline-primary" data-period="day" onclick="setAdminPeriod('day')">Today</button>
                <button type="button" class="btn btn-outline-primary" data-period="week" onclick="setAdminPeriod('week')">This Week</button>
                <button type="button" class="btn btn-outline-primary active" data-period="month" onclick="setAdminPeriod('month')">This Month</button>
                <button type="button" class="btn btn-outline-primary" data-period="year" onclick="setAdminPeriod('year')">This Year</button>
                <button type="button" class="btn btn-outline-primary" data-period="all" onclick="setAdminPeriod('all')">All Time</button>
            </div>
            <span class="badge bg-primary ms-auto" id="adminPeriodLabel">This Month</span>
        </div>
    </div>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Revenue</span>
            <span class="stat-value" id="periodRevenue">₱0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="revenueInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Period Orders</span>
            <span class="stat-value" id="periodOrders">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="ordersInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Completed Orders</span>
            <span class="stat-value" id="periodCompleted">0</span>
            <div class="stat-trend up">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                </svg>
                <span id="completedInfo">Calculating...</span>
            </div>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Avg Order Value</span>
            <span class="stat-value" id="avgOrderValue">₱0</span>
        </div>
    </div>
</div>

<div class="card fade-in">
    <div class="card-header">
        <h3 class="card-title">Monthly Sales Performance</h3>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function() {
        // ========== SELF-CONTAINED SALES REPORT ==========
        var allOrders = [];
        var currentPeriod = 'month';
        var salesChart = null;

        function normalizeStatus(status) {
            return (status || '').toString().trim().toLowerCase();
        }

        // Revenue should only reflect after approval (Confirmed) and beyond.
        function isRevenueStatus(status) {
            var s = normalizeStatus(status);
            return s === 'confirmed' || s === 'processing' || s === 'completed' || s === 'delivered' || s === 'shipped';
        }

        // Currency formatter
        function formatCurrency(amount) {
            return '₱' + parseFloat(amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Set text of element by id
        function setText(id, txt) {
            var el = document.getElementById(id);
            if (el) el.textContent = txt;
        }

        // Load orders from API
        function loadReport() {
            setText('revenueInfo', 'Loading...');
            setText('ordersInfo', 'Loading...');
            setText('completedInfo', 'Loading...');

            fetch('/api/orders', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.json();
            })
            .then(function(result) {
                // Handle wrapped response {success: true, data: [...]}
                if (result && result.data && Array.isArray(result.data)) {
                    allOrders = result.data;
                } else if (Array.isArray(result)) {
                    allOrders = result;
                } else {
                    allOrders = [];
                }
                updateReport();
            })
            .catch(function(error) {
                console.error('Failed to load report:', error);
                allOrders = [];
                updateReport();
            });
        }

        // Filter orders by period
        function filterByPeriod(orders, period) {
            if (!orders || !orders.length) return [];
            var now = new Date();
            var startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var d;

            switch (period) {
                case 'day':
                    return orders.filter(function(o) { return o.orderDate && new Date(o.orderDate) >= startOfToday; });
                case 'week':
                    d = new Date(startOfToday);
                    d.setDate(d.getDate() - d.getDay());
                    return orders.filter(function(o) { return o.orderDate && new Date(o.orderDate) >= d; });
                case 'month':
                    d = new Date(now.getFullYear(), now.getMonth(), 1);
                    return orders.filter(function(o) { return o.orderDate && new Date(o.orderDate) >= d; });
                case 'year':
                    d = new Date(now.getFullYear(), 0, 1);
                    return orders.filter(function(o) { return o.orderDate && new Date(o.orderDate) >= d; });
                default:
                    return orders;
            }
        }

        // Update all stats and chart
        function updateReport() {
            var filtered = filterByPeriod(allOrders, currentPeriod);
            var revenue = 0;
            var completed = 0;

            var revenueOrders = [];
            for (var i = 0; i < filtered.length; i++) {
                if (isRevenueStatus(filtered[i].orderStatus)) revenueOrders.push(filtered[i]);
            }

            for (var i = 0; i < revenueOrders.length; i++) {
                revenue += parseFloat(revenueOrders[i].totalAmount) || 0;
            }

            for (var i = 0; i < filtered.length; i++) {
                var st = filtered[i].orderStatus;
                if (st === 'Completed' || st === 'Delivered') completed++;
            }

            var avg = revenueOrders.length > 0 ? revenue / revenueOrders.length : 0;
            var completionRate = filtered.length > 0 ? (completed / filtered.length * 100) : 0;

            setText('periodRevenue', formatCurrency(revenue));
            setText('periodOrders', filtered.length);
            setText('periodCompleted', completed);
            setText('avgOrderValue', formatCurrency(avg));
            setText('revenueInfo', revenueOrders.length + ' confirmed+ orders');
            setText('ordersInfo', completed + ' completed');
            setText('completedInfo', completionRate.toFixed(0) + '% completion rate');

            renderChart();
        }

        // Render Chart.js bar chart
        function renderChart() {
            var ctx = document.getElementById('salesChart');
            if (!ctx) return;
            if (typeof Chart === 'undefined') {
                ctx.parentElement.innerHTML = '<div class="alert alert-warning text-center">Chart library not available</div>';
                return;
            }

            var monthlyData = [0,0,0,0,0,0,0,0,0,0,0,0];
            var currentYear = new Date().getFullYear();

            for (var i = 0; i < allOrders.length; i++) {
                var o = allOrders[i];
                if (!o.orderDate) continue;
                if (!isRevenueStatus(o.orderStatus)) continue;
                var d = new Date(o.orderDate);
                if (d.getFullYear() === currentYear) {
                    monthlyData[d.getMonth()] += parseFloat(o.totalAmount) || 0;
                }
            }

            if (salesChart) { salesChart.destroy(); }

            salesChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                    datasets: [{
                        label: 'Sales (₱)',
                        data: monthlyData,
                        backgroundColor: '#008080',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function(v) { return '₱' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v); } }
                        }
                    }
                }
            });
        }

        // Period filter button handler
        window.setAdminPeriod = function(period) {
            currentPeriod = period;

            // Toggle active button
            var btns = document.querySelectorAll('#adminPeriodFilter .btn');
            for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('active'); }
            var activeBtn = document.querySelector('#adminPeriodFilter [data-period="' + period + '"]');
            if (activeBtn) activeBtn.classList.add('active');

            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            setText('adminPeriodLabel', labels[period] || period);

            updateReport();
        };

        // Generate PDF report
        window.generateAdminPdfReport = function() {
            var labels = { day: 'Today', week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' };
            var periodLabel = labels[currentPeriod] || 'All Time';
            var filtered = filterByPeriod(allOrders, currentPeriod);
            var totalRevenue = 0;
            var completedOrders = 0;

            var revenueOrders = [];
            for (var i = 0; i < filtered.length; i++) {
                if (isRevenueStatus(filtered[i].orderStatus)) revenueOrders.push(filtered[i]);
            }

            for (var i = 0; i < revenueOrders.length; i++) {
                totalRevenue += parseFloat(revenueOrders[i].totalAmount) || 0;
            }

            for (var i = 0; i < filtered.length; i++) {
                var st = filtered[i].orderStatus;
                if (st === 'Completed' || st === 'Delivered') completedOrders++;
            }
            var avgOrder = revenueOrders.length > 0 ? totalRevenue / revenueOrders.length : 0;
            var now = new Date();

            var rowsHtml = '';
            for (var i = 0; i < filtered.length; i++) {
                var o = filtered[i];
                var statusClass = 'background:#0dcaf0;color:#333';
                if (o.orderStatus === 'Completed' || o.orderStatus === 'Delivered') statusClass = 'background:#198754;color:#fff';
                else if (o.orderStatus === 'Pending') statusClass = 'background:#ffc107;color:#333';
                else if (o.orderStatus === 'Cancelled') statusClass = 'background:#dc3545;color:#fff';

                var payClass = 'background:#dc3545;color:#fff';
                if (o.paymentStatus === 'Paid') payClass = 'background:#198754;color:#fff';
                else if (o.paymentStatus === 'Pending') payClass = 'background:#ffc107;color:#333';

                rowsHtml += '<tr>' +
                    '<td><strong>' + (o.orderNumber || '') + '</strong></td>' +
                    '<td>' + (o.customerName || 'Guest') + '</td>' +
                    '<td>' + (o.orderDate ? new Date(o.orderDate).toLocaleDateString('en-PH') : '-') + '</td>' +
                    '<td style="text-align:center">' + (o.itemCount || 0) + '</td>' +
                    '<td style="text-align:right">' + formatCurrency(o.totalAmount) + '</td>' +
                    '<td style="text-align:center"><span style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;' + statusClass + '">' + (o.orderStatus || '') + '</span></td>' +
                    '<td style="text-align:center"><span style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;' + payClass + '">' + (o.paymentStatus || 'Pending') + '</span></td>' +
                '</tr>';
            }

            var html = '<html><head><title>CompuGear Sales Report - ' + periodLabel + '</title>' +
                '<style>' +
                '*{margin:0;padding:0;box-sizing:border-box}' +
                'body{font-family:"Segoe UI",Arial,sans-serif;margin:0;padding:40px;color:#333;font-size:12px}' +
                '.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #008080;padding-bottom:20px;margin-bottom:30px}' +
                '.company h1{color:#008080;font-size:28px;margin-bottom:5px}' +
                '.company p{color:#666}' +
                '.report-title{text-align:right}' +
                '.report-title h2{color:#008080;font-size:20px}' +
                '.report-title p{color:#666}' +
                '.summary-cards{display:flex;gap:20px;margin-bottom:30px}' +
                '.summary-card{flex:1;background:#f8f9fa;border-radius:8px;padding:15px;text-align:center;border-left:4px solid #008080}' +
                '.summary-card .value{font-size:24px;font-weight:bold;color:#008080}' +
                '.summary-card .label{color:#666;font-size:11px;text-transform:uppercase}' +
                'table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px}' +
                'th{background:#008080;color:white;padding:10px 8px;text-align:left;font-weight:600}' +
                'td{padding:8px;border-bottom:1px solid #e0e0e0}' +
                'tr:nth-child(even){background:#f8f9fa}' +
                '.footer{margin-top:30px;padding-top:15px;border-top:2px solid #e0e0e0;text-align:center;color:#666;font-size:10px}' +
                '.total-row{font-weight:bold;background:#e8f5f5!important}' +
                '</style></head><body onload="window.print()">' +
                '<div class="header">' +
                    '<div class="company"><h1>CompuGear</h1><p>Computer &amp; Gear Solutions</p></div>' +
                    '<div class="report-title"><h2>Sales Report</h2><p>Period: ' + periodLabel + '</p><p>Generated: ' + now.toLocaleDateString('en-PH', { year:'numeric', month:'long', day:'numeric' }) + '</p></div>' +
                '</div>' +
                '<div class="summary-cards">' +
                    '<div class="summary-card"><div class="value">' + filtered.length + '</div><div class="label">Total Orders</div></div>' +
                    '<div class="summary-card"><div class="value">' + formatCurrency(totalRevenue) + '</div><div class="label">Total Revenue</div></div>' +
                    '<div class="summary-card"><div class="value">' + formatCurrency(avgOrder) + '</div><div class="label">Avg Order Value</div></div>' +
                    '<div class="summary-card"><div class="value">' + completedOrders + '</div><div class="label">Completed Orders</div></div>' +
                '</div>' +
                '<h3 style="color:#008080;margin-bottom:15px">Order Details</h3>' +
                '<table><thead><tr><th>Order #</th><th>Customer</th><th>Date</th><th style="text-align:center">Items</th><th style="text-align:right">Amount</th><th style="text-align:center">Status</th><th style="text-align:center">Payment</th></tr></thead>' +
                '<tbody>' + rowsHtml +
                '<tr class="total-row"><td colspan="4" style="text-align:right"><strong>Grand Total:</strong></td><td style="text-align:right"><strong>' + formatCurrency(totalRevenue) + '</strong></td><td colspan="2"></td></tr>' +
                '</tbody></table>' +
                '<div class="footer"><p>CompuGear Sales Report &mdash; Generated on ' + now.toLocaleString('en-PH') + ' &mdash; Confidential</p></div>' +
                '</body></html>';

            var printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(html);
                printWindow.document.close();

                // Fallback: some browsers block body onload for about:blank writes
                try {
                    printWindow.onload = function() {
                        try { printWindow.focus(); } catch (e) {}
                        try { printWindow.print(); } catch (e) {}
                    };
                } catch (e) {}
            } else {
                alert('Please allow pop-ups to generate the PDF report.');
            }
        };

        // ========== INIT: Load immediately ==========
        loadReport();
    })();
    </script>
}
