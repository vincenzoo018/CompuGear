@{
    ViewData["Title"] = "Ticket Status Dashboard";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Ticket Status Dashboard</h1>
        <p class="page-subtitle">Real-time overview of all support tickets</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="loadTicketStatus()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
            Refresh
        </button>
        <a href="/Support/Tickets" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            View All Tickets
        </a>
    </div>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4 border-warning">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #f59e0b;" id="openCount">0</h2>
                <p class="text-muted mb-0 small">Open</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4 border-info">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #3b82f6;" id="progressCount">0</h2>
                <p class="text-muted mb-0 small">In Progress</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4 border-secondary">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #6b7280;" id="pendingCount">0</h2>
                <p class="text-muted mb-0 small">Pending Customer</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4 border-success">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #10b981;" id="resolvedCount">0</h2>
                <p class="text-muted mb-0 small">Resolved</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4" style="border-color: #374151 !important;">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #374151;" id="closedCount">0</h2>
                <p class="text-muted mb-0 small">Closed</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6 mb-3">
        <div class="card h-100 border-start border-4 border-danger">
            <div class="card-body text-center py-4">
                <h2 class="mb-0" style="font-size: 2.5rem; color: #ef4444;" id="urgentCount">0</h2>
                <p class="text-muted mb-0 small">High Priority</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Status Distribution Chart -->
    <div class="col-lg-5 mb-4">
        <div class="card fade-in h-100">
            <div class="card-header">
                <h5 class="mb-0">üìä Status Distribution</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Priority Distribution -->
    <div class="col-lg-3 mb-4">
        <div class="card fade-in h-100">
            <div class="card-header">
                <h5 class="mb-0">‚ö° By Priority</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions / Unassigned -->
    <div class="col-lg-4 mb-4">
        <div class="card fade-in h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚ö†Ô∏è Unassigned Tickets</h5>
                <span class="badge bg-warning" id="unassignedBadge">0</span>
            </div>
            <div class="card-body p-0">
                <div id="unassignedList" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Status Changes -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card fade-in">
            <div class="card-header">
                <h5 class="mb-0">üî¥ Overdue / Oldest Open Tickets</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="data-table mb-0">
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Priority</th>
                                <th>Age</th>
                                <th>Assigned</th>
                            </tr>
                        </thead>
                        <tbody id="oldestTicketsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card fade-in">
            <div class="card-header">
                <h5 class="mb-0">‚úÖ Recently Resolved</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="data-table mb-0">
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Subject</th>
                                <th>Resolved</th>
                                <th>By</th>
                            </tr>
                        </thead>
                        <tbody id="resolvedTicketsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.priority-low { background: #dcfce7; color: #166534; }
.priority-medium { background: #fef3cd; color: #92400e; }
.priority-high { background: #fee2e2; color: #dc2626; }
.priority-critical { background: #7f1d1d; color: white; }
</style>

@section Scripts {
<script src="~/js/admin.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let statusChart = null, priorityChart = null;
    let ticketsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadTicketStatus();
        // Auto-refresh every 30 seconds
        setInterval(loadTicketStatus, 30000);
    });

    async function loadTicketStatus() {
        try {
            const response = await fetch('/Support/GetTickets');
            ticketsData = await response.json();
            
            updateStatusCounts();
            renderCharts();
            renderUnassignedTickets();
            renderOldestTickets();
            renderResolvedTickets();
        } catch (error) {
            console.error('Failed to load ticket status:', error);
        }
    }

    function updateStatusCounts() {
        const counts = { 'Open': 0, 'In Progress': 0, 'Pending Customer': 0, 'Resolved': 0, 'Closed': 0 };
        ticketsData.forEach(t => { if (counts.hasOwnProperty(t.status)) counts[t.status]++; });
        
        const highPriority = ticketsData.filter(t => 
            (t.priority === 'High' || t.priority === 'Critical') && 
            t.status !== 'Resolved' && t.status !== 'Closed'
        ).length;

        document.getElementById('openCount').textContent = counts['Open'];
        document.getElementById('progressCount').textContent = counts['In Progress'];
        document.getElementById('pendingCount').textContent = counts['Pending Customer'];
        document.getElementById('resolvedCount').textContent = counts['Resolved'];
        document.getElementById('closedCount').textContent = counts['Closed'];
        document.getElementById('urgentCount').textContent = highPriority;
    }

    function renderCharts() {
        // Status chart
        const statusCounts = { 'Open': 0, 'In Progress': 0, 'Pending': 0, 'Resolved': 0, 'Closed': 0 };
        ticketsData.forEach(t => {
            const status = t.status === 'Pending Customer' ? 'Pending' : t.status;
            if (statusCounts.hasOwnProperty(status)) statusCounts[status]++;
        });

        const ctx1 = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['#F59E0B', '#3B82F6', '#9CA3AF', '#10B981', '#374151'],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Priority chart
        const priorityCounts = { 'Low': 0, 'Medium': 0, 'High': 0, 'Critical': 0 };
        ticketsData.filter(t => t.status !== 'Resolved' && t.status !== 'Closed').forEach(t => {
            if (priorityCounts.hasOwnProperty(t.priority)) priorityCounts[t.priority]++;
        });

        const ctx2 = document.getElementById('priorityChart').getContext('2d');
        if (priorityChart) priorityChart.destroy();
        priorityChart = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: Object.keys(priorityCounts),
                datasets: [{
                    data: Object.values(priorityCounts),
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#7F1D1D']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderUnassignedTickets() {
        const unassigned = ticketsData.filter(t => !t.assignedToName && t.status !== 'Resolved' && t.status !== 'Closed')
            .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
            .slice(0, 10);

        document.getElementById('unassignedBadge').textContent = unassigned.length;
        
        const priorityClasses = { 'Low': 'priority-low', 'Medium': 'priority-medium', 'High': 'priority-high', 'Critical': 'priority-critical' };

        document.getElementById('unassignedList').innerHTML = unassigned.length ? unassigned.map(t => `
            <a href="/Support/Tickets" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold small">${t.ticketNumber}</div>
                    <div class="text-muted small">${truncate(t.subject, 25)}</div>
                </div>
                <span class="badge ${priorityClasses[t.priority] || 'bg-secondary'}">${t.priority}</span>
            </a>
        `).join('') : '<div class="text-center py-4 text-muted">No unassigned tickets üéâ</div>';
    }

    function renderOldestTickets() {
        const oldest = ticketsData.filter(t => t.status === 'Open' || t.status === 'In Progress')
            .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
            .slice(0, 8);

        const priorityClasses = { 'Low': 'priority-low', 'Medium': 'priority-medium', 'High': 'priority-high', 'Critical': 'priority-critical' };

        document.getElementById('oldestTicketsBody').innerHTML = oldest.length ? oldest.map(t => `
            <tr>
                <td>
                    <div class="fw-bold small">${t.ticketNumber}</div>
                    <div class="text-muted small">${truncate(t.subject, 20)}</div>
                </td>
                <td><span class="badge ${priorityClasses[t.priority] || 'bg-secondary'}">${t.priority}</span></td>
                <td class="small text-danger">${getAge(t.createdAt)}</td>
                <td class="small">${t.assignedToName || '<span class="text-muted">-</span>'}</td>
            </tr>
        `).join('') : '<tr><td colspan="4" class="text-center py-3 text-muted">No open tickets</td></tr>';
    }

    function renderResolvedTickets() {
        const resolved = ticketsData.filter(t => t.status === 'Resolved' || t.status === 'Closed')
            .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
            .slice(0, 8);

        document.getElementById('resolvedTicketsBody').innerHTML = resolved.length ? resolved.map(t => `
            <tr>
                <td><span class="fw-bold small text-success">${t.ticketNumber}</span></td>
                <td class="small">${truncate(t.subject, 25)}</td>
                <td class="small">${formatDate(t.updatedAt)}</td>
                <td class="small">${t.assignedToName || '-'}</td>
            </tr>
        `).join('') : '<tr><td colspan="4" class="text-center py-3 text-muted">No resolved tickets yet</td></tr>';
    }

    function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : str || ''; }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-'; }
    function getAge(d) {
        const hours = Math.floor((new Date() - new Date(d)) / (1000 * 60 * 60));
        if (hours < 24) return hours + 'h ago';
        const days = Math.floor(hours / 24);
        return days + 'd ago';
    }
</script>
}
            }
        }
    </script>
}
