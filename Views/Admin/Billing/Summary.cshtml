@{
    ViewData["Title"] = "Financial Summary";
}

<div class="page-header">
    <h1 class="page-title">Financial Summary</h1>
    <p class="page-subtitle">Overview of financial performance</p>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Revenue (YTD)</span>
            <span class="stat-value" id="totalRevenue">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">This Month</span>
            <span class="stat-value" id="thisMonthRevenue">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Outstanding</span>
            <span class="stat-value" id="outstandingAmount">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Paid</span>
            <span class="stat-value" id="totalPaid">₱0</span>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Revenue Trend</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Invoice Status</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart = null, categoryChart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadFinancialSummary();
        });

        async function loadFinancialSummary() {
            try {
                const [invoicesResult, ordersResult] = await Promise.all([
                    API.get('/invoices'),
                    API.get('/orders')
                ]);

                const invoices = invoicesResult.data || invoicesResult;
                const orders = ordersResult.data || ordersResult;
                const invoicesList = Array.isArray(invoices) ? invoices : [];
                const ordersList = Array.isArray(orders) ? orders : [];

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Calculate totals from orders
                let totalRevenue = 0, thisMonth = 0;
                const monthlyData = Array(12).fill(0);

                ordersList.forEach(o => {
                    const orderDate = new Date(o.orderDate);
                    const amount = o.totalAmount || 0;

                    if (orderDate.getFullYear() === currentYear) {
                        totalRevenue += amount;
                        monthlyData[orderDate.getMonth()] += amount;
                        
                        if (orderDate.getMonth() === currentMonth) {
                            thisMonth += amount;
                        }
                    }
                });

                // Calculate invoice stats
                const totalInvoiced = invoicesList.reduce((sum, i) => sum + (i.totalAmount || 0), 0);
                const totalPaid = invoicesList.filter(i => i.status === 'Paid').reduce((sum, i) => sum + (i.totalAmount || 0), 0);
                const outstanding = invoicesList.filter(i => i.status === 'Pending' || i.status === 'Overdue').reduce((sum, i) => sum + (i.totalAmount || 0), 0);

                // Update stats
                document.getElementById('totalRevenue').textContent = Format.currency(totalRevenue);
                document.getElementById('thisMonthRevenue').textContent = Format.currency(thisMonth);
                document.getElementById('outstandingAmount').textContent = Format.currency(outstanding);
                document.getElementById('totalPaid').textContent = Format.currency(totalPaid);

                // Revenue trend chart
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                if (revenueChart) revenueChart.destroy();
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyData,
                            borderColor: '#008080',
                            backgroundColor: 'rgba(0, 128, 128, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { callback: v => '₱' + (v/1000).toFixed(0) + 'k' } } }
                    }
                });

                // Invoice status chart
                const statusCounts = { 'Paid': 0, 'Pending': 0, 'Overdue': 0, 'Draft': 0 };
                invoicesList.forEach(i => {
                    if (statusCounts.hasOwnProperty(i.status)) statusCounts[i.status]++;
                });

                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                if (categoryChart) categoryChart.destroy();
                categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#6B7280'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (error) {
                console.error('Failed to load financial summary:', error);
                Toast.error('Failed to load financial summary');
            }
        }
    </script>
}
