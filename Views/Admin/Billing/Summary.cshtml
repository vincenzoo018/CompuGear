@{
    ViewData["Title"] = "Financial Summary";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Financial Summary</h1>
        <p class="page-subtitle">Overview of financial performance</p>
    </div>
    <button class="btn btn-primary" onclick="generateFinancialPDF()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Generate PDF Report
    </button>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Revenue (YTD)</span>
            <span class="stat-value" id="totalRevenue">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">This Month</span>
            <span class="stat-value" id="thisMonthRevenue">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Outstanding</span>
            <span class="stat-value" id="outstandingAmount">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Paid</span>
            <span class="stat-value" id="totalPaid">₱0</span>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Revenue Trend</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Invoice Status</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Financial Table (also used for PDF) -->
<div class="card fade-in mb-4">
    <div class="card-header">
        <h3 class="card-title">Financial Details</h3>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table" id="financialDetailsTable">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Subtotal</th>
                        <th>Tax/VAT</th>
                        <th>Total</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="financialDetailsBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        let revenueChart = null, categoryChart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadFinancialSummary();
        });

        async function loadFinancialSummary() {
            try {
                let report = {};
                let invoicesList = [];
                let ordersList = [];
                let paymentsList = [];

                try {
                    report = await API.get('/reports/financial?period=year');
                } catch (_) {
                    report = {};
                }

                const [invoicesResult, ordersResult, paymentsResult] = await Promise.all([
                    API.get('/invoices').catch(() => []),
                    API.get('/orders').catch(() => []),
                    API.get('/payments').catch(() => [])
                ]);

                const invoices = invoicesResult?.data || invoicesResult;
                const orders = ordersResult?.data || ordersResult;
                const payments = paymentsResult?.data || paymentsResult;

                invoicesList = Array.isArray(invoices) ? invoices : [];
                ordersList = Array.isArray(orders) ? orders : [];
                paymentsList = Array.isArray(payments) ? payments : [];

                const now = new Date();
                const currentMonth = now.getMonth();

                const fallbackMonthlyCollected = Array(12).fill(0);
                ordersList.forEach(order => {
                    const date = new Date(order.orderDate || order.createdAt || now);
                    const amount = order.totalAmount || 0;
                    const isPaid = (order.paymentStatus || '').toLowerCase() === 'paid';
                    if (date.getFullYear() === now.getFullYear() && isPaid) {
                        fallbackMonthlyCollected[date.getMonth()] += amount;
                    }
                });

                const monthlyCollected = Array.isArray(report.monthlyCollected) && report.monthlyCollected.length === 12
                    ? report.monthlyCollected
                    : fallbackMonthlyCollected;

                const totalRevenue = report.totalRevenue ?? ordersList.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const totalPaid = report.totalCollected ?? paymentsList.reduce((sum, p) => sum + (p.amount || 0), 0);
                const outstanding = report.outstanding ?? invoicesList
                    .filter(i => !['Paid', 'Paid/Confirmed', 'Cancelled', 'Void'].includes(i.status))
                    .reduce((sum, i) => sum + (i.balanceDue ?? Math.max(0, (i.totalAmount || 0) - (i.paidAmount || 0))), 0);

                const thisMonth = monthlyCollected[currentMonth] || 0;

                // Update stats
                document.getElementById('totalRevenue').textContent = Format.currency(totalRevenue);
                document.getElementById('thisMonthRevenue').textContent = Format.currency(thisMonth);
                document.getElementById('outstandingAmount').textContent = Format.currency(outstanding);
                document.getElementById('totalPaid').textContent = Format.currency(totalPaid);

                // Revenue trend chart
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                if (revenueChart) revenueChart.destroy();
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyCollected,
                            borderColor: '#008080',
                            backgroundColor: 'rgba(0, 128, 128, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { callback: v => '₱' + (v/1000).toFixed(0) + 'k' } } }
                    }
                });

                // Invoice status chart
                const statusCounts = { 'Paid': 0, 'Paid/Confirmed': 0, 'Pending': 0, 'Overdue': 0, 'Draft': 0, 'Partial': 0, 'Cancelled': 0 };
                const statusBreakdown = Array.isArray(report.invoiceStatusBreakdown) ? report.invoiceStatusBreakdown : [];
                if (statusBreakdown.length > 0) {
                    statusBreakdown.forEach(item => {
                        const key = item.status || item.Status;
                        const count = item.count ?? item.Count ?? 0;
                        if (statusCounts.hasOwnProperty(key)) {
                            statusCounts[key] = count;
                        }
                    });
                } else {
                    invoicesList.forEach(i => {
                        const key = i.status || 'Pending';
                        if (statusCounts.hasOwnProperty(key)) statusCounts[key] += 1;
                    });
                }

                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                if (categoryChart) categoryChart.destroy();
                categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#10B981', '#0EA5E9', '#F59E0B', '#EF4444', '#6B7280', '#3B82F6', '#9CA3AF'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
                
                // Render detailed financial table
                renderFinancialDetails(invoicesList);
            } catch (error) {
                console.error('Failed to load financial summary:', error);
                Toast.error('Failed to load financial summary');
            }
        }
        
        function renderFinancialDetails(invoices) {
            const tbody = document.getElementById('financialDetailsBody');
            if (!tbody) return;
            
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No invoices found</td></tr>';
                return;
            }
            
            tbody.innerHTML = invoices.map(i => {
                const subtotal = i.subtotal || 0;
                const taxAmount = i.taxAmount || 0;
                const totalAmount = i.totalAmount || 0;
                const paidAmount = i.paidAmount || 0;
                const balance = i.balanceDue || (totalAmount - paidAmount);
                
                return `
                    <tr>
                        <td class="fw-medium">${i.invoiceNumber || '-'}</td>
                        <td>${i.customerName || '-'}</td>
                        <td class="text-end">${Format.currency(subtotal)}</td>
                        <td class="text-end">${taxAmount > 0 ? `<span class="text-warning">${Format.currency(taxAmount)}</span>` : '-'}</td>
                        <td class="text-end fw-semibold">${Format.currency(totalAmount)}</td>
                        <td class="text-end text-success">${Format.currency(paidAmount)}</td>
                        <td class="text-end ${balance > 0 ? 'text-danger' : ''}">${Format.currency(balance)}</td>
                        <td>${Format.statusBadge(i.status)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function generateFinancialPDF() {
            // Get summary data
            const totalRevenue = document.getElementById('totalRevenue').textContent;
            const thisMonth = document.getElementById('thisMonthRevenue').textContent;
            const outstanding = document.getElementById('outstandingAmount').textContent;
            const totalPaid = document.getElementById('totalPaid').textContent;
            
            // Build detailed table rows from the financial details table
            const tableRows = document.querySelectorAll('#financialDetailsBody tr');
            let tableHTML = '';
            tableRows.forEach(row => {
                tableHTML += '<tr>';
                row.querySelectorAll('td').forEach(td => {
                    tableHTML += `<td style="padding: 6px 10px; border: 1px solid #ddd; font-size: 11px;">${td.textContent.trim()}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            if (typeof html2pdf === 'undefined') {
                Toast.error('PDF library failed to load. Please try again.');
                return;
            }

            const container = document.createElement('div');
            container.style.padding = '24px';
            container.style.fontFamily = 'Segoe UI, Arial, sans-serif';
            container.innerHTML = `
                <div style="text-align:center;margin-bottom:18px;">
                    <h2 style="margin:0;color:#008080;">Financial Summary Report</h2>
                    <div style="color:#666;">Generated on ${new Date().toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
                <table style="width:100%;border-collapse:collapse;margin-bottom:14px;">
                    <tr>
                        <td style="border:1px solid #ddd;padding:10px;"><strong>Total Revenue (YTD)</strong><br>${totalRevenue}</td>
                        <td style="border:1px solid #ddd;padding:10px;"><strong>This Month</strong><br>${thisMonth}</td>
                        <td style="border:1px solid #ddd;padding:10px;"><strong>Outstanding</strong><br>${outstanding}</td>
                        <td style="border:1px solid #ddd;padding:10px;"><strong>Total Paid</strong><br>${totalPaid}</td>
                    </tr>
                </table>
                <h4 style="margin:8px 0;color:#008080;">Invoice Details</h4>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Invoice #</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Customer</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Subtotal</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Tax/VAT</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Total</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Paid</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Balance</th>
                            <th style="border:1px solid #ddd;padding:8px;text-align:left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>${tableHTML}</tbody>
                </table>
            `;

            const fileDate = new Date().toISOString().split('T')[0];
            const options = {
                margin: 8,
                filename: `financial-summary-${fileDate}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(options).from(container).save();
        }
    </script>
}
