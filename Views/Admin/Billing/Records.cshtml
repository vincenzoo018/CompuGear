@{
    ViewData["Title"] = "Account Records";
}

<div class="page-header">
    <h1 class="page-title">Account Records</h1>
    <p class="page-subtitle">View all billing account records</p>
</div>

<div class="card fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="search-input">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="searchRecords" placeholder="Search records..." oninput="filterRecords()">
        </div>
        <span class="badge bg-primary" id="recordsCount">0 accounts</span>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="data-table" id="recordsTable">
            <thead>
                <tr>
                    <th>Account</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Outstanding</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody">
                <!-- Dynamic content loaded from customers and invoices -->
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script src="~/js/admin.js"></script>
<script>
    let recordsData = [];

    document.addEventListener('DOMContentLoaded', async function() {
        await loadRecords();
    });

    async function loadRecords() {
        try {
            const [customersResult, invoicesResult] = await Promise.all([
                API.get('/customers'),
                API.get('/invoices')
            ]);

            const customers = customersResult.data || customersResult;
            const invoices = invoicesResult.data || invoicesResult;
            const customersList = Array.isArray(customers) ? customers : [];
            const invoicesList = Array.isArray(invoices) ? invoices : [];

            // Calculate outstanding for each customer
            recordsData = customersList.map((c, idx) => {
                const customerInvoices = invoicesList.filter(i => i.customerId === c.customerId);
                const outstanding = customerInvoices
                    .filter(i => i.status === 'Pending' || i.status === 'Overdue')
                    .reduce((sum, i) => sum + (i.totalAmount || 0), 0);
                const hasOverdue = customerInvoices.some(i => i.status === 'Overdue');

                return {
                    accountId: 'ACC-' + String(idx + 1).padStart(3, '0'),
                    customerId: c.customerId,
                    customerName: c.companyName || (c.firstName + ' ' + c.lastName),
                    customerType: c.customerType || 'Regular',
                    outstanding: outstanding,
                    status: hasOverdue ? 'Past Due' : outstanding > 0 ? 'Balance Due' : 'Good Standing'
                };
            });

            renderRecords();
        } catch (error) {
            console.error('Failed to load records:', error);
            Toast.error('Failed to load account records');
        }
    }

    function renderRecords(data = recordsData) {
        const tbody = document.getElementById('recordsTableBody');
        document.getElementById('recordsCount').textContent = data.length + ' accounts';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No account records found</td></tr>';
            return;
        }

        const typeClasses = { 'Business': 'badge-info', 'VIP': 'badge-success', 'Premium': 'badge-warning', 'Regular': 'badge-neutral' };
        const statusClasses = { 'Good Standing': 'badge-success', 'Balance Due': 'badge-warning', 'Past Due': 'badge-error' };

        tbody.innerHTML = data.map(r => `
            <tr data-id="${r.customerId}">
                <td><strong>${r.accountId}</strong></td>
                <td>${r.customerName}</td>
                <td><span class="badge ${typeClasses[r.customerType] || 'badge-neutral'}">${r.customerType}</span></td>
                <td>${Format.currency(r.outstanding)}</td>
                <td><span class="badge ${statusClasses[r.status]}">${r.status}</span></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewAccountDetail(${r.customerId})" title="View Details">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function filterRecords() {
        const search = document.getElementById('searchRecords').value.toLowerCase();
        const filtered = recordsData.filter(r => 
            r.customerName.toLowerCase().includes(search) || 
            r.accountId.toLowerCase().includes(search) ||
            r.customerType.toLowerCase().includes(search)
        );
        renderRecords(filtered);
    }

    async function viewAccountDetail(customerId) {
        try {
            const [customerResult, invoicesResult] = await Promise.all([
                API.get(`/customers/${customerId}`),
                API.get('/invoices')
            ]);
            const customer = customerResult.data || customerResult;
            const allInvoices = invoicesResult.data || invoicesResult;
            const invoices = Array.isArray(allInvoices) ? allInvoices.filter(i => i.customerId === customerId) : [];

            const name = customer.companyName || ((customer.firstName || '') + ' ' + (customer.lastName || '')).trim();
            let html = `
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <strong>Customer:</strong> ${name}<br>
                        <strong>Email:</strong> ${customer.email || '-'}<br>
                        <strong>Phone:</strong> ${customer.phone || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>Total Invoices:</strong> ${invoices.length}<br>
                        <strong>Total Invoiced:</strong> ${Format.currency(invoices.reduce((s, i) => s + (i.totalAmount || 0), 0))}<br>
                        <strong>Outstanding:</strong> <span class="text-danger">${Format.currency(invoices.filter(i => i.status !== 'Paid' && i.status !== 'Cancelled').reduce((s, i) => s + (i.balanceDue || 0), 0))}</span>
                    </div>
                </div>`;

            if (invoices.length > 0) {
                html += `<h6>Invoices</h6>
                    <table class="table table-sm"><thead><tr><th>Invoice #</th><th>Date</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
                    <tbody>${invoices.map(i => `<tr>
                        <td>${i.invoiceNumber}</td>
                        <td>${Format.date(i.invoiceDate)}</td>
                        <td>${Format.currency(i.totalAmount)}</td>
                        <td class="text-success">${Format.currency(i.paidAmount)}</td>
                        <td class="${(i.balanceDue || 0) > 0 ? 'text-danger' : ''}">${Format.currency(i.balanceDue)}</td>
                        <td>${Format.statusBadge(i.status)}</td>
                    </tr>`).join('')}</tbody></table>`;
            }

            Modal.showDynamic('Account Details â€” ' + name, html);
        } catch (error) {
            Toast.error('Failed to load account details');
        }
    }
</script>
}
