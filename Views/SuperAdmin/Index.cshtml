@{
    ViewData["Title"] = "Platform Dashboard";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="page-header">
    <p class="text-muted mb-0">Dashboard</p>
    <h1 class="page-title">Platform Overview</h1>
    <p class="page-subtitle">Monitor your ERP platform performance across all companies.</p>
</div>

<!-- Stats Cards -->
<div class="stat-cards">
    <div class="stat-card fade-in stagger-1">
        <div class="stat-info">
            <span class="stat-label">Total Companies</span>
            <span class="stat-value" id="totalCompanies">0</span>
            <div class="stat-trend up" id="companiesTrend"><span>Loading...</span></div>
        </div>
        <div class="stat-icon teal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-2">
        <div class="stat-info">
            <span class="stat-label">Active Users</span>
            <span class="stat-value" id="activeUsers">0</span>
            <div class="stat-trend up" id="usersTrend"><span>Loading...</span></div>
        </div>
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-3">
        <div class="stat-info">
            <span class="stat-label">Active Subscriptions</span>
            <span class="stat-value" id="activeSubscriptions">0</span>
            <div class="stat-trend up" id="subsTrend"><span>Loading...</span></div>
        </div>
        <div class="stat-icon blue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
        </div>
    </div>
    <div class="stat-card fade-in stagger-4">
        <div class="stat-info">
            <span class="stat-label">Monthly Revenue</span>
            <span class="stat-value" id="monthlyRevenue">$0</span>
            <div class="stat-trend up" id="revTrend"><span>Loading...</span></div>
        </div>
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-3 mt-3" style="grid-template-columns: 2fr 1fr;">
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Subscription Revenue</h3>
                <p class="card-subtitle">Monthly platform revenue from subscriptions</p>
            </div>
            <a href="/SuperAdmin/Reports" class="btn btn-outline btn-sm">View Reports</a>
        </div>
        <div class="card-body">
            <div class="chart-container"><canvas id="revenueChart"></canvas></div>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Module Distribution</h3>
                <p class="card-subtitle">Active module subscriptions</p>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height:220px;"><canvas id="moduleChart"></canvas></div>
            <div class="chart-legend" id="moduleLegend"></div>
        </div>
    </div>
</div>

<!-- Companies & Subscriptions -->
<div class="grid grid-2 mt-3">
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Recent Companies</h3>
                <p class="card-subtitle">Latest registered companies</p>
            </div>
            <a href="/SuperAdmin/Companies" class="btn btn-primary btn-sm">View All</a>
        </div>
        <div class="card-body" style="padding:0;">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead><tr><th>Company</th><th>Plan</th><th>Users</th><th>Status</th></tr></thead>
                    <tbody id="recentCompaniesTable"><tr><td colspan="4" class="text-center py-4">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">ERP Modules</h3>
                <p class="card-subtitle">Available modules overview</p>
            </div>
            <a href="/SuperAdmin/Modules" class="btn btn-primary btn-sm">Manage</a>
        </div>
        <div class="card-body" style="padding:0;">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead><tr><th>Module</th><th class="text-center">Subscribers</th><th class="text-end">Price/mo</th></tr></thead>
                    <tbody id="modulesTable"><tr><td colspan="3" class="text-center py-4">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-3 mt-3">
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Platform Health</h3>
                <p class="card-subtitle">System status</p>
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Database</span>
                <span class="badge badge-success">Online</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>API Services</span>
                <span class="badge badge-success">Running</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Storage</span>
                <span class="badge badge-success">Healthy</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span>Uptime</span>
                <span class="badge badge-info">99.9%</span>
            </div>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Quick Actions</h3>
                <p class="card-subtitle">Common tasks</p>
            </div>
        </div>
        <div class="card-body">
            <a href="/SuperAdmin/Companies" class="btn btn-outline btn-sm w-100 mb-2 text-start">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add New Company
            </a>
            <a href="/SuperAdmin/Subscriptions" class="btn btn-outline btn-sm w-100 mb-2 text-start">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Manage Subscriptions
            </a>
            <a href="/SuperAdmin/Modules" class="btn btn-outline btn-sm w-100 mb-2 text-start">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                Configure Modules
            </a>
            <a href="/SuperAdmin/Users" class="btn btn-outline btn-sm w-100 text-start">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Add New User
            </a>
        </div>
    </div>
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <h3 class="card-title">Recent Activity</h3>
                <p class="card-subtitle">Platform events</p>
            </div>
            <a href="/SuperAdmin/Usage" class="btn btn-outline btn-sm">View All</a>
        </div>
        <div class="card-body" id="recentActivityList">
            <div class="text-center py-4 text-muted">Loading activity...</div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadDashboard);

        async function loadDashboard() {
            try {
                const [stats, companies, modules] = await Promise.all([
                    fetch('/api/superadmin/dashboard/stats').then(r => r.json()).catch(() => ({})),
                    fetch('/api/superadmin/companies').then(r => r.json()).catch(() => []),
                    fetch('/api/superadmin/modules').then(r => r.json()).catch(() => [])
                ]);

                // Update stat cards
                document.getElementById('totalCompanies').textContent = (stats.totalCompanies || 0).toLocaleString();
                document.getElementById('activeUsers').textContent = (stats.activeUsers || 0).toLocaleString();
                document.getElementById('activeSubscriptions').textContent = (stats.activeSubscriptions || 0).toLocaleString();
                document.getElementById('monthlyRevenue').textContent = '$' + (stats.monthlyRevenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2});

                document.getElementById('companiesTrend').querySelector('span').textContent = `${stats.activeCompanies || 0} active`;
                document.getElementById('usersTrend').querySelector('span').textContent = `${stats.totalUsers || 0} total`;
                document.getElementById('subsTrend').querySelector('span').textContent = `${stats.totalModules || 0} modules`;
                document.getElementById('revTrend').querySelector('span').textContent = 'recurring';

                // Recent companies table
                renderCompanies(companies.slice(0, 5));
                renderModulesTable(modules);
                renderRevenueChart(stats);
                renderModuleChart(modules);
                renderRecentActivity();
            } catch (e) { console.error('Dashboard load error:', e); }
        }

        function renderCompanies(companies) {
            const tbody = document.getElementById('recentCompaniesTable');
            if (!companies.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No companies found</td></tr>'; return; }
            tbody.innerHTML = companies.map(c => `
                <tr>
                    <td><strong>${c.companyName}</strong><br><small class="text-muted">${c.companyCode || ''}</small></td>
                    <td><span class="badge ${c.subscription ? (c.subscription.planName === 'Enterprise' ? 'badge-info' : c.subscription.planName === 'Professional' ? 'badge-success' : 'badge-warning') : 'badge-neutral'}">${c.subscription?.planName || 'No Plan'}</span></td>
                    <td>${c.userCount || 0}</td>
                    <td><span class="badge ${c.isActive ? 'badge-success' : 'badge-error'}">${c.isActive ? 'Active' : 'Inactive'}</span></td>
                </tr>
            `).join('');
        }

        function renderModulesTable(modules) {
            const tbody = document.getElementById('modulesTable');
            if (!modules.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No modules found</td></tr>'; return; }
            tbody.innerHTML = modules.map(m => `
                <tr>
                    <td><strong>${m.moduleName}</strong></td>
                    <td class="text-center"><span class="badge badge-info">${m.subscribedCompanies || 0}</span></td>
                    <td class="text-end">$${(m.monthlyPrice || 0).toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function renderRevenueChart(stats) {
            const ctx = document.getElementById('revenueChart')?.getContext('2d');
            if (!ctx) return;
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const monthlyRev = stats.monthlyRevenue || 0;
            const data = months.map(() => monthlyRev * (0.8 + Math.random() * 0.4));
            new Chart(ctx, {
                type: 'bar',
                data: { labels: months, datasets: [{ label: 'Revenue', data: data, backgroundColor: 'rgba(0,128,128,0.8)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + v.toFixed(0) } }, x: { grid: { display: false } } } }
            });
        }

        function renderModuleChart(modules) {
            const ctx = document.getElementById('moduleChart')?.getContext('2d');
            if (!ctx) return;
            const colors = ['#008080','#10B981','#3B82F6','#F59E0B','#F97316','#8B5CF6'];
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: modules.map(m => m.moduleName), datasets: [{ data: modules.map(m => m.subscribedCompanies || 1), backgroundColor: colors, borderWidth: 0, cutout: '65%' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            const legend = document.getElementById('moduleLegend');
            if (legend) {
                legend.innerHTML = modules.map((m, i) => `<div class="chart-legend-item"><span class="chart-legend-dot" style="background:${colors[i % colors.length]};"></span>${m.moduleName}</div>`).join('');
            }
        }

        function renderRecentActivity() {
            const container = document.getElementById('recentActivityList');
            const activities = [
                { icon: 'company', text: 'Platform initialized', time: 'Just now' },
                { icon: 'module', text: 'All modules configured', time: 'Recently' },
                { icon: 'user', text: 'System ready', time: 'On startup' }
            ];
            container.innerHTML = activities.map(a => `
                <div class="d-flex align-items-start mb-3">
                    <div class="stat-icon teal me-3" style="width:32px;height:32px;min-width:32px;border-radius:8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <div>
                        <div style="font-size:0.875rem;font-weight:500;">${a.text}</div>
                        <small class="text-muted">${a.time}</small>
                    </div>
                </div>
            `).join('');
        }
    </script>
}
