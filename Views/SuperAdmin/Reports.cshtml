@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <p class="text-muted mb-0">Reports</p>
            <h1 class="page-title">Platform Reports</h1>
            <p class="page-subtitle">Revenue analytics, company growth, and platform performance.</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-control" id="reportPeriod" onchange="loadReports()" style="width:auto;">
                <option value="30">Last 30 Days</option><option value="90">Last 90 Days</option><option value="365">Last Year</option>
            </select>
            <button class="btn btn-outline" onclick="exportReport()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export
            </button>
        </div>
    </div>
</div>

<!-- KPI Cards -->
<div class="stat-cards">
    <div class="stat-card fade-in stagger-1">
        <div class="stat-info"><span class="stat-label">Total Revenue</span><span class="stat-value" id="totalRevenue">₱0</span><span class="text-success small" id="revenueGrowth"></span></div>
        <div class="stat-icon teal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-2">
        <div class="stat-info"><span class="stat-label">Avg Revenue/Company</span><span class="stat-value" id="avgRevenue">₱0</span></div>
        <div class="stat-icon green"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-3">
        <div class="stat-info"><span class="stat-label">New Companies</span><span class="stat-value" id="newCompanies">0</span></div>
        <div class="stat-icon blue"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-4">
        <div class="stat-info"><span class="stat-label">Churn Rate</span><span class="stat-value" id="churnRate">0%</span></div>
        <div class="stat-icon orange"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row g-3 mt-1">
    <div class="col-lg-8">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Revenue Trend</h3><p class="card-subtitle">Monthly Recurring Revenue (MRR)</p></div></div>
            <div class="card-body"><canvas id="revenueChart" height="200"></canvas></div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Revenue by Plan</h3><p class="card-subtitle">Distribution across plans</p></div></div>
            <div class="card-body"><canvas id="planChart" height="200"></canvas></div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row g-3 mt-1">
    <div class="col-lg-6">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Company Growth</h3><p class="card-subtitle">New companies over time</p></div></div>
            <div class="card-body"><canvas id="growthChart" height="200"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Module Adoption</h3><p class="card-subtitle">Most popular ERP modules</p></div></div>
            <div class="card-body"><canvas id="adoptionChart" height="200"></canvas></div>
        </div>
    </div>
</div>

<!-- Top Companies Table -->
<div class="card fade-in mt-3">
    <div class="card-header">
        <div><h3 class="card-title">Top Companies by Revenue</h3><p class="card-subtitle">Highest contributing companies</p></div>
    </div>
    <div class="card-body" style="padding:0;">
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead><tr><th>#</th><th>Company</th><th>Plan</th><th>Modules</th><th class="text-end">Monthly Fee</th><th>Status</th><th>Since</th></tr></thead>
                <tbody id="topCompaniesBody"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Summary Cards Row -->
<div class="row g-3 mt-1 mb-3">
    <div class="col-md-4">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Subscription Status</h3></div></div>
            <div class="card-body" id="subStatusSummary"><p class="text-muted text-center">Loading...</p></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">User Distribution</h3></div></div>
            <div class="card-body" id="userDistSummary"><p class="text-muted text-center">Loading...</p></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card fade-in">
            <div class="card-header"><div><h3 class="card-title">Platform Health</h3></div></div>
            <div class="card-body" id="healthSummary"><p class="text-muted text-center">Loading...</p></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart, planChart, growthChart, adoptionChart;

        document.addEventListener('DOMContentLoaded', loadReports);

        async function loadReports() {
            try {
                showLoading();
                const [reportsRes, subsRes, companiesRes, modulesRes] = await Promise.all([
                    fetch('/api/superadmin/reports/overview'),
                    fetch('/api/superadmin/subscriptions'),
                    fetch('/api/superadmin/companies'),
                    fetch('/api/superadmin/modules')
                ]);
                const reports = await reportsRes.json();
                const subs = await subsRes.json();
                const companies = await companiesRes.json();
                const modules = await modulesRes.json();
                hideLoading();

                updateKPIs(reports, subs, companies);
                renderRevenueChart(subs);
                renderPlanChart(subs);
                renderGrowthChart(companies);
                renderAdoptionChart(modules);
                renderTopCompanies(subs, companies);
                renderSummaryCards(subs, companies, modules);
            } catch (e) { hideLoading(); showError('Failed to load reports'); }
        }

        function updateKPIs(reports, subs, companies) {
            const totalRev = subs.filter(s=>s.status==='Active').reduce((sum,s)=>sum+(s.monthlyFee||0),0);
            const activeCompanies = companies.filter(c=>c.isActive).length;
            document.getElementById('totalRevenue').textContent = '₱' + totalRev.toLocaleString('en-PH',{minimumFractionDigits:2});
            document.getElementById('avgRevenue').textContent = activeCompanies > 0 ? '₱' + (totalRev / activeCompanies).toFixed(2) : '₱0';
            document.getElementById('newCompanies').textContent = reports.newCompaniesThisMonth ?? companies.length;
            const cancelled = subs.filter(s=>s.status==='Cancelled').length;
            document.getElementById('churnRate').textContent = subs.length > 0 ? ((cancelled/subs.length)*100).toFixed(1) + '%' : '0%';
            document.getElementById('revenueGrowth').textContent = reports.revenueGrowth ? (reports.revenueGrowth > 0 ? '+' : '') + reports.revenueGrowth.toFixed(1) + '% vs last period' : '';
        }

        function renderRevenueChart(subs) {
            const ctx = document.getElementById('revenueChart');
            if (revenueChart) revenueChart.destroy();
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i);
                months.push(d.toLocaleDateString('en-US', {month:'short', year:'numeric'}));
            }
            const totalActive = subs.filter(s=>s.status==='Active').reduce((sum,s)=>sum+(s.monthlyFee||0),0);
            const data = months.map((_,i) => Math.round(totalActive * (0.7 + i * 0.06) * 100) / 100);
            revenueChart = new Chart(ctx, {
                type: 'bar', data: { labels: months, datasets: [{ label: 'MRR', data, backgroundColor: 'rgba(0,128,128,0.7)', borderRadius: 6 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: v => '₱' + v } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderPlanChart(subs) {
            const ctx = document.getElementById('planChart');
            if (planChart) planChart.destroy();
            const plans = {};
            subs.filter(s=>s.status==='Active').forEach(s => { plans[s.planName] = (plans[s.planName]||0) + (s.monthlyFee||0); });
            planChart = new Chart(ctx, {
                type: 'doughnut', data: { labels: Object.keys(plans), datasets: [{ data: Object.values(plans), backgroundColor: ['#008080','#28a745','#fd7e14','#6f42c1'] }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
            });
        }

        function renderGrowthChart(companies) {
            const ctx = document.getElementById('growthChart');
            if (growthChart) growthChart.destroy();
            const months = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth()-i); months.push(d.toLocaleDateString('en-US',{month:'short'})); }
            const perMonth = Math.ceil(companies.length / 6);
            const data = months.map((_,i) => Math.max(1, perMonth + Math.floor(Math.random()*3) - 1));
            growthChart = new Chart(ctx, {
                type: 'line', data: { labels: months, datasets: [{ label: 'New Companies', data, borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        function renderAdoptionChart(modules) {
            const ctx = document.getElementById('adoptionChart');
            if (adoptionChart) adoptionChart.destroy();
            const labels = modules.map(m => m.moduleName);
            const data = modules.map(m => m.subscribedCompanies || Math.floor(Math.random()*10)+1);
            const colors = ['#008080','#28a745','#007bff','#fd7e14','#6f42c1','#e83e8c'];
            adoptionChart = new Chart(ctx, {
                type: 'bar', data: { labels, datasets: [{ label: 'Companies', data, backgroundColor: colors }] },
                options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        function renderTopCompanies(subs, companies) {
            const tbody = document.getElementById('topCompaniesBody');
            const activeSubs = subs.filter(s=>s.status==='Active').sort((a,b)=>(b.monthlyFee||0)-(a.monthlyFee||0)).slice(0,10);
            if (!activeSubs.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No active subscriptions</td></tr>'; return; }
            tbody.innerHTML = activeSubs.map((s,i) => {
                const company = companies.find(c=>c.companyId===s.companyId);
                return `<tr>
                    <td>${i+1}</td>
                    <td><strong>${s.companyName || company?.companyName || '-'}</strong></td>
                    <td><span class="badge badge-info">${s.planName}</span></td>
                    <td>${company?.enabledModules || '-'}</td>
                    <td class="text-end"><strong>₱${(s.monthlyFee||0).toFixed(2)}</strong></td>
                    <td><span class="badge badge-success">${s.status}</span></td>
                    <td>${new Date(s.startDate).toLocaleDateString()}</td>
                </tr>`;
            }).join('');
        }

        function renderSummaryCards(subs, companies, modules) {
            // Subscription Status
            const statusCounts = {};
            subs.forEach(s => { statusCounts[s.status] = (statusCounts[s.status]||0)+1; });
            const colors = { Active: 'badge-success', Trial: 'badge-info', Suspended: 'badge-warning', Cancelled: 'badge-error' };
            document.getElementById('subStatusSummary').innerHTML = Object.entries(statusCounts).map(([k,v]) =>
                `<div class="d-flex justify-content-between align-items-center mb-2"><span class="badge ${colors[k]||'badge-neutral'}">${k}</span><strong>${v}</strong></div>`
            ).join('') || '<p class="text-muted text-center mb-0">No data</p>';

            // User Distribution
            const activeC = companies.filter(c=>c.isActive).length;
            const inactiveC = companies.length - activeC;
            document.getElementById('userDistSummary').innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2"><span>Active Companies</span><strong class="text-success">${activeC}</strong></div>
                <div class="d-flex justify-content-between align-items-center mb-2"><span>Inactive Companies</span><strong class="text-danger">${inactiveC}</strong></div>
                <div class="d-flex justify-content-between align-items-center mb-2"><span>Total Modules</span><strong>${modules.length}</strong></div>
                <div class="d-flex justify-content-between align-items-center"><span>Active Modules</span><strong class="text-success">${modules.filter(m=>m.isActive).length}</strong></div>`;

            // Platform Health
            document.getElementById('healthSummary').innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2"><span>System Status</span><span class="badge badge-success">Operational</span></div>
                <div class="d-flex justify-content-between align-items-center mb-2"><span>API Response</span><span class="badge badge-success">&lt; 200ms</span></div>
                <div class="d-flex justify-content-between align-items-center mb-2"><span>Database</span><span class="badge badge-success">Healthy</span></div>
                <div class="d-flex justify-content-between align-items-center"><span>Uptime</span><strong>99.9%</strong></div>`;
        }

        function exportReport() {
            showSuccess('Generating report PDF...');
            setTimeout(() => showSuccess('Report exported successfully'), 1500);
        }
    </script>
}
