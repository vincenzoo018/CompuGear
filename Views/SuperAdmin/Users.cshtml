@{
    ViewData["Title"] = "Users";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <p class="text-muted mb-0">Users</p>
            <h1 class="page-title">User Management</h1>
            <p class="page-subtitle">Manage all platform users across all companies.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/SuperAdmin/UsersArchive" class="btn btn-outline-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                    <polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
            <button class="btn btn-primary" onclick="openCreateUserModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Add User
            </button>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="stat-cards">
    <div class="stat-card fade-in stagger-1">
        <div class="stat-info"><span class="stat-label">Total Users</span><span class="stat-value" id="totalUsers">0</span></div>
        <div class="stat-icon teal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-2">
        <div class="stat-info"><span class="stat-label">Active</span><span class="stat-value" id="activeUsers">0</span></div>
        <div class="stat-icon green"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-3">
        <div class="stat-info"><span class="stat-label">Admins</span><span class="stat-value" id="adminUsers">0</span></div>
        <div class="stat-icon blue"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
    </div>
    <div class="stat-card fade-in stagger-4">
        <div class="stat-info"><span class="stat-label">Companies</span><span class="stat-value" id="companiesCount">0</span></div>
        <div class="stat-icon orange"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    </div>
</div>

<!-- Filters -->
<div class="card fade-in mt-3 mb-3">
    <div class="card-body">
        <div class="d-flex gap-3 align-items-end flex-wrap">
            <div class="form-group mb-0 flex-grow-1">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="searchUsers" placeholder="Search by name, email..." oninput="filterUsers()">
            </div>
            <div class="form-group mb-0">
                <label class="form-label">Role</label>
                <select class="form-control" id="roleFilter" onchange="filterUsers()"></select>
            </div>
            <div class="form-group mb-0">
                <label class="form-label">Status</label>
                <select class="form-control" id="statusFilter" onchange="filterUsers()">
                    <option value="">All</option><option value="true">Active</option><option value="false">Inactive</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card fade-in">
    <div class="card-body" style="padding:0;">
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead><tr><th>User</th><th>Email</th><th>Company</th><th>Role</th><th>Status</th><th>Last Login</th><th class="text-center">Actions</th></tr></thead>
                <tbody id="usersTableBody"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-primary">
                <h5 class="modal-title" id="userModalTitle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                    Add User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId">
                <div class="row g-3">
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">First Name *</label><input type="text" class="form-control" id="userFirstName" required></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Last Name *</label><input type="text" class="form-control" id="userLastName" required></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Email *</label><input type="email" class="form-control" id="userEmail" required></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Phone</label><input type="text" class="form-control" id="userPhone"></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Company *</label><select class="form-control" id="userCompanyId"></select></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Role *</label><select class="form-control" id="userRoleId"></select></div></div>
                    <div class="col-md-6" id="passwordGroup"><div class="form-group mb-0"><label class="form-label">Password *</label><input type="password" class="form-control" id="userPassword"></div></div>
                    <div class="col-md-6"><div class="form-group mb-0"><label class="form-label">Status</label>
                        <select class="form-control" id="userIsActive"><option value="true">Active</option><option value="false">Inactive</option></select></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-info">
                <h5 class="modal-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> User Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewUserContent"></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-danger">
                <h5 class="modal-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Deactivate User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><p>Are you sure you want to deactivate <strong id="deleteUserName"></strong>?</p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUserBtn">Deactivate</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allUsers = [], allRoles = [], allCompaniesForUser = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadUsers(), loadRoles(), loadCompaniesForUserSelect()]);
        });

        async function loadRoles() {
            try {
                const res = await fetch('/api/superadmin/roles');
                allRoles = await res.json();
                const roleSel = document.getElementById('userRoleId');
                roleSel.innerHTML = '<option value="">Select Role</option>' + allRoles.map(r => `<option value="${r.roleId}">${r.roleName}</option>`).join('');
                const filterSel = document.getElementById('roleFilter');
                filterSel.innerHTML = '<option value="">All Roles</option>' + allRoles.map(r => `<option value="${r.roleId}">${r.roleName}</option>`).join('');
            } catch(e) {}
        }

        async function loadCompaniesForUserSelect() {
            try {
                const res = await fetch('/api/superadmin/companies');
                allCompaniesForUser = await res.json();
                const sel = document.getElementById('userCompanyId');
                sel.innerHTML = '<option value="">Select Company</option>' + allCompaniesForUser.map(c => `<option value="${c.companyId}">${c.companyName}</option>`).join('');
            } catch(e) {}
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/superadmin/users');
                allUsers = await res.json();
                updateUserStats();
                filterUsers();
            } catch (e) { showError('Failed to load users'); }
        }

        function updateUserStats() {
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('activeUsers').textContent = allUsers.filter(u => u.isActive).length;
            document.getElementById('adminUsers').textContent = allUsers.filter(u => u.roleId === 1 || u.roleId === 2).length;
            const uniqueCompanies = [...new Set(allUsers.map(u => u.companyId).filter(Boolean))];
            document.getElementById('companiesCount').textContent = uniqueCompanies.length;
        }

        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            let filtered = allUsers;
            if (search) filtered = filtered.filter(u =>
                (u.firstName||'').toLowerCase().includes(search) ||
                (u.lastName||'').toLowerCase().includes(search) ||
                (u.email||'').toLowerCase().includes(search)
            );
            if (role) filtered = filtered.filter(u => u.roleId == role);
            if (status) filtered = filtered.filter(u => String(u.isActive) === status);
            renderUsers(filtered);
        }

        function getRoleName(roleId) {
            const r = allRoles.find(x => x.roleId === roleId);
            return r ? r.roleName : 'Unknown';
        }

        function getCompanyName(companyId) {
            const c = allCompaniesForUser.find(x => x.companyId === companyId);
            return c ? c.companyName : '-';
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!users.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No users found</td></tr>'; return; }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width:32px;height:32px;border-radius:50%;background:#008080;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;">
                                ${(u.firstName||'?')[0]}${(u.lastName||'?')[0]}
                            </div>
                            <div><strong>${u.firstName} ${u.lastName}</strong></div>
                        </div>
                    </td>
                    <td>${u.email}</td>
                    <td>${u.companyName || getCompanyName(u.companyId)}</td>
                    <td><span class="badge ${u.roleId===1?'badge-error':u.roleId===2?'badge-warning':'badge-info'}">${u.roleName || getRoleName(u.roleId)}</span></td>
                    <td><span class="badge ${u.isActive?'badge-success':'badge-error'}">${u.isActive?'Active':'Inactive'}</span></td>
                    <td><small>${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleDateString() : 'Never'}</small></td>
                    <td class="text-center">
                        <div class="d-flex gap-1 justify-content-center">
                            <button class="btn btn-sm btn-outline" onclick="viewUser(${u.userId})" title="View">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editUser(${u.userId})" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-outline text-danger" onclick="confirmDeleteUser(${u.userId}, '${u.firstName} ${u.lastName}')" title="Deactivate">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openCreateUserModal() {
            document.getElementById('userId').value = '';
            document.getElementById('userFirstName').value = '';
            document.getElementById('userLastName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userCompanyId').value = '';
            document.getElementById('userRoleId').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsActive').value = 'true';
            document.getElementById('passwordGroup').style.display = '';
            document.getElementById('userModalTitle').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> Add User';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function editUser(id) {
            const u = allUsers.find(x => x.userId === id); if(!u) return;
            document.getElementById('userId').value = u.userId;
            document.getElementById('userFirstName').value = u.firstName || '';
            document.getElementById('userLastName').value = u.lastName || '';
            document.getElementById('userEmail').value = u.email || '';
            document.getElementById('userPhone').value = u.phone || '';
            document.getElementById('userCompanyId').value = u.companyId || '';
            document.getElementById('userRoleId').value = u.roleId || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsActive').value = u.isActive ? 'true' : 'false';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userModalTitle').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit User';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function viewUser(id) {
            const u = allUsers.find(x => x.userId === id); if(!u) return;
            document.getElementById('viewUserContent').innerHTML = `
                <div class="text-center mb-3">
                    <div style="width:64px;height:64px;border-radius:50%;background:#008080;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:22px;font-weight:600;">
                        ${(u.firstName||'?')[0]}${(u.lastName||'?')[0]}
                    </div>
                    <h5 class="mt-2 mb-0">${u.firstName} ${u.lastName}</h5>
                    <p class="text-muted">${u.email}</p>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom"><span class="text-muted">Company</span><strong>${u.companyName || getCompanyName(u.companyId)}</strong></div>
                <div class="d-flex justify-content-between py-2 border-bottom"><span class="text-muted">Role</span><span class="badge ${u.roleId===1?'badge-error':u.roleId===2?'badge-warning':'badge-info'}">${u.roleName || getRoleName(u.roleId)}</span></div>
                <div class="d-flex justify-content-between py-2 border-bottom"><span class="text-muted">Phone</span><span>${u.phone || '-'}</span></div>
                <div class="d-flex justify-content-between py-2 border-bottom"><span class="text-muted">Status</span><span class="badge ${u.isActive?'badge-success':'badge-error'}">${u.isActive?'Active':'Inactive'}</span></div>
                <div class="d-flex justify-content-between py-2 border-bottom"><span class="text-muted">Last Login</span><span>${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleString() : 'Never'}</span></div>
                <div class="d-flex justify-content-between py-2"><span class="text-muted">Created</span><span>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-'}</span></div>
            `;
            new bootstrap.Modal(document.getElementById('viewUserModal')).show();
        }

        async function saveUser() {
            const id = document.getElementById('userId').value;
            const data = {
                firstName: document.getElementById('userFirstName').value,
                lastName: document.getElementById('userLastName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value || null,
                companyId: parseInt(document.getElementById('userCompanyId').value) || null,
                roleId: parseInt(document.getElementById('userRoleId').value) || null,
                isActive: document.getElementById('userIsActive').value === 'true'
            };
            if (!id) data.password = document.getElementById('userPassword').value;
            if (!data.firstName || !data.lastName || !data.email) { showError('First name, last name and email are required'); return; }
            if (!id && !data.password) { showError('Password is required for new users'); return; }
            if (!data.companyId || !data.roleId) { showError('Company and role are required'); return; }

            try {
                showLoading();
                const url = id ? `/api/superadmin/users/${id}` : '/api/superadmin/users';
                const res = await fetch(url, { method: id ? 'PUT' : 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                const result = await res.json();
                hideLoading();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('userModal'))?.hide();
                    showSuccess(result.message);
                    loadUsers();
                } else { showError(result.message || 'Failed to save user'); }
            } catch (e) { hideLoading(); showError('Failed to save user'); }
        }

        let deleteUserId = null;
        function confirmDeleteUser(id, name) {
            deleteUserId = id;
            document.getElementById('deleteUserName').textContent = name;
            new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
        }

        document.getElementById('confirmDeleteUserBtn').addEventListener('click', async () => {
            if (!deleteUserId) return;
            try {
                showLoading();
                const res = await fetch(`/api/superadmin/users/${deleteUserId}`, { method: 'DELETE' });
                const result = await res.json();
                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'))?.hide();
                if (result.success) { showSuccess(result.message); loadUsers(); }
                else { showError(result.message); }
            } catch (e) { hideLoading(); showError('Failed to deactivate user'); }
        });
    </script>
}
