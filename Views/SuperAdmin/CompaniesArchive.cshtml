@{
    ViewData["Title"] = "Company Archive";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <p class="text-muted mb-0">Companies</p>
            <h1 class="page-title">Company Archive</h1>
            <p class="page-subtitle">Deactivated companies that can be restored.</p>
        </div>
        <a href="/SuperAdmin/Companies" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Companies
        </a>
    </div>
</div>

<div class="card fade-in">
    <div class="card-header d-flex justify-content-between align-items-center" style="padding: 1rem 1.25rem;">
        <h5 class="mb-0">Archived Companies</h5>
        <span class="badge bg-secondary" id="archiveCount">0 archived</span>
    </div>
    <div class="card-body" style="padding:0;">
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Code</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th class="text-center">Users</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="archiveTableBody">
                    <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center" id="companyArchivePagination"></div>
</div>

@section Scripts {
    <script>
        let archivedCompanies = [];

        document.addEventListener('DOMContentLoaded', loadArchivedCompanies);

        async function loadArchivedCompanies() {
            try {
                showLoading();
                const res = await fetch('/api/superadmin/companies');
                const companies = await res.json();
                archivedCompanies = (companies || []).filter(c => !c.isActive);
                renderArchivedCompanies();
                hideLoading();
            } catch (error) {
                hideLoading();
                showError('Failed to load archived companies');
            }
        }

        function renderArchivedCompanies() {
            const tbody = document.getElementById('archiveTableBody');
            document.getElementById('archiveCount').textContent = `${archivedCompanies.length} archived`;

            if (!archivedCompanies.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No archived companies</td></tr>';
                return;
            }

            tbody.innerHTML = archivedCompanies.map(c => `
                <tr>
                    <td><strong>${c.companyName}</strong></td>
                    <td><code>${c.companyCode || 'N/A'}</code></td>
                    <td>${c.email || '-'}</td>
                    <td>${c.phone || '-'}</td>
                    <td class="text-center">${c.userCount || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="restoreCompany(${c.companyId})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                                <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Restore
                        </button>
                    </td>
                </tr>
            `).join('');
            if (typeof initPagination === 'function') initPagination('archiveTableBody', 'companyArchivePagination', 10);
        }

        async function restoreCompany(id) {
            if (!confirm('Are you sure you want to reactivate this company?')) return;
            try {
                showLoading();
                const res = await fetch(`/api/superadmin/companies/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isActive: true })
                });
                const result = await res.json();
                hideLoading();

                if (result.success || res.ok) {
                    showSuccess(result.message || 'Company restored successfully');
                    archivedCompanies = archivedCompanies.filter(c => c.companyId !== id);
                    renderArchivedCompanies();

                    if (archivedCompanies.length === 0) {
                        setTimeout(() => { window.location.href = '/SuperAdmin/Companies'; }, 500);
                    }
                } else {
                    showError(result.message || 'Failed to restore company');
                }
            } catch (error) {
                hideLoading();
                showError('Failed to restore company');
            }
        }
    </script>
}
