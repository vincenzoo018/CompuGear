@{
    ViewData["Title"] = "Company Management";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <p class="text-muted mb-0">Companies</p>
            <h1 class="page-title">Company Management</h1>
            <p class="page-subtitle">Manage all registered companies and their subscriptions.</p>
        </div>
        <button class="btn btn-primary" onclick="openCreateCompanyModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Company
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card fade-in mb-3">
    <div class="card-body">
        <div class="d-flex gap-3 align-items-end flex-wrap">
            <div class="form-group mb-0 flex-grow-1">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search companies..." oninput="filterCompanies()">
            </div>
            <div class="form-group mb-0">
                <label class="form-label">Status</label>
                <select class="form-control" id="statusFilter" onchange="filterCompanies()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="loadCompanies()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                    <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Companies Table -->
<div class="card fade-in">
    <div class="card-body" style="padding:0;">
        <div class="data-table-wrapper">
            <table class="data-table" id="companiesTable">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Code</th>
                        <th>Contact</th>
                        <th class="text-center">Users</th>
                        <th class="text-center">Modules</th>
                        <th>Plan</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="companiesTableBody">
                    <tr><td colspan="8" class="text-center py-4">Loading companies...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Company Modal -->
<div class="modal fade" id="companyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-primary">
                <h5 class="modal-title" id="companyModalTitle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    Add Company
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="companyId">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" required></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Company Code</label>
                        <input type="text" class="form-control" id="companyCode" placeholder="Auto-generated"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Email</label>
                        <input type="email" class="form-control" id="companyEmail"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="companyPhone"></div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-group mb-0"><label class="form-label">Address</label>
                        <input type="text" class="form-control" id="companyAddress"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-0"><label class="form-label">City</label>
                        <input type="text" class="form-control" id="companyCity"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-0"><label class="form-label">Country</label>
                        <input type="text" class="form-control" id="companyCountry"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-0"><label class="form-label">Website</label>
                        <input type="text" class="form-control" id="companyWebsite"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Tax ID</label>
                        <input type="text" class="form-control" id="companyTaxId"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-0"><label class="form-label">Status</label>
                        <select class="form-control" id="companyStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCompany()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Company
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Company Details Modal -->
<div class="modal fade" id="companyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header modal-header-info">
                <h5 class="modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                    Company Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="companyDetailsContent">Loading...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editCompanyFromViewBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Edit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-danger">
                <h5 class="modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Confirm Deactivation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate <strong id="deleteCompanyName"></strong>?</p>
                <p class="text-muted mb-0">The company and its users will be deactivated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteCompanyBtn">Deactivate</button>
            </div>
        </div>
    </div>
</div>

<!-- Module Assignment Modal -->
<div class="modal fade" id="moduleAssignModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header modal-header-primary">
                <h5 class="modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    Assign Modules - <span id="assignModuleCompanyName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="moduleAssignContent">Loading modules...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allCompanies = [];

        document.addEventListener('DOMContentLoaded', loadCompanies);

        async function loadCompanies() {
            try {
                const res = await fetch('/api/superadmin/companies');
                allCompanies = await res.json();
                renderCompanies(allCompanies);
            } catch (e) { showError('Failed to load companies'); }
        }

        function filterCompanies() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            let filtered = allCompanies;
            if (search) filtered = filtered.filter(c => c.companyName.toLowerCase().includes(search) || (c.companyCode||'').toLowerCase().includes(search) || (c.email||'').toLowerCase().includes(search));
            if (status === 'active') filtered = filtered.filter(c => c.isActive);
            if (status === 'inactive') filtered = filtered.filter(c => !c.isActive);
            renderCompanies(filtered);
        }

        function renderCompanies(companies) {
            const tbody = document.getElementById('companiesTableBody');
            if (!companies.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No companies found</td></tr>'; return; }
            tbody.innerHTML = companies.map(c => `
                <tr>
                    <td><strong>${c.companyName}</strong></td>
                    <td><code>${c.companyCode || 'N/A'}</code></td>
                    <td>${c.email || 'N/A'}<br><small class="text-muted">${c.phone || ''}</small></td>
                    <td class="text-center">${c.userCount || 0}</td>
                    <td class="text-center"><span class="badge badge-info">${c.moduleCount || 0}</span></td>
                    <td><span class="badge ${c.subscription ? (c.subscription.planName === 'Enterprise' ? 'badge-info' : c.subscription.planName === 'Professional' ? 'badge-success' : 'badge-warning') : 'badge-neutral'}">${c.subscription?.planName || 'None'}</span></td>
                    <td><span class="badge ${c.isActive ? 'badge-success' : 'badge-error'}">${c.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="text-center">
                        <div class="d-flex gap-1 justify-content-center">
                            <button class="btn btn-sm btn-outline" onclick="viewCompany(${c.companyId})" title="View Details">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editCompany(${c.companyId})" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="openModuleAssign(${c.companyId}, '${c.companyName}')" title="Assign Modules">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-outline text-danger" onclick="confirmDeleteCompany(${c.companyId}, '${c.companyName}')" title="Deactivate">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openCreateCompanyModal() {
            document.getElementById('companyId').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('companyCode').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('companyCity').value = '';
            document.getElementById('companyCountry').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyTaxId').value = '';
            document.getElementById('companyStatus').value = 'true';
            document.getElementById('companyModalTitle').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Company';
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        async function editCompany(id) {
            try {
                const res = await fetch(`/api/superadmin/companies/${id}`);
                const data = await res.json();
                const c = data.company;
                document.getElementById('companyId').value = c.companyId;
                document.getElementById('companyName').value = c.companyName || '';
                document.getElementById('companyCode').value = c.companyCode || '';
                document.getElementById('companyEmail').value = c.email || '';
                document.getElementById('companyPhone').value = c.phone || '';
                document.getElementById('companyAddress').value = c.address || '';
                document.getElementById('companyCity').value = c.city || '';
                document.getElementById('companyCountry').value = c.country || '';
                document.getElementById('companyWebsite').value = c.website || '';
                document.getElementById('companyTaxId').value = c.taxId || '';
                document.getElementById('companyStatus').value = c.isActive ? 'true' : 'false';
                document.getElementById('companyModalTitle').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit Company';
                new bootstrap.Modal(document.getElementById('companyModal')).show();
            } catch (e) { showError('Failed to load company'); }
        }

        async function saveCompany() {
            const id = document.getElementById('companyId').value;
            const data = {
                companyName: document.getElementById('companyName').value,
                companyCode: document.getElementById('companyCode').value || null,
                email: document.getElementById('companyEmail').value || null,
                phone: document.getElementById('companyPhone').value || null,
                address: document.getElementById('companyAddress').value || null,
                city: document.getElementById('companyCity').value || null,
                country: document.getElementById('companyCountry').value || null,
                website: document.getElementById('companyWebsite').value || null,
                taxId: document.getElementById('companyTaxId').value || null,
                isActive: document.getElementById('companyStatus').value === 'true'
            };
            if (!data.companyName) { showError('Company name is required'); return; }

            try {
                showLoading();
                const url = id ? `/api/superadmin/companies/${id}` : '/api/superadmin/companies';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                const result = await res.json();
                hideLoading();
                if (result.success || res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('companyModal'))?.hide();
                    showSuccess(result.message || 'Company saved successfully');
                    loadCompanies();
                } else { showError(result.message || 'Failed to save'); }
            } catch (e) { hideLoading(); showError('Failed to save company'); }
        }

        async function viewCompany(id) {
            try {
                const res = await fetch(`/api/superadmin/companies/${id}`);
                const data = await res.json();
                const c = data.company;
                const content = document.getElementById('companyDetailsContent');
                content.innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="mb-3">Company Information</h6>
                            <table class="table table-sm"><tbody>
                                <tr><td class="text-muted" style="width:140px;">Name</td><td><strong>${c.companyName}</strong></td></tr>
                                <tr><td class="text-muted">Code</td><td><code>${c.companyCode||'N/A'}</code></td></tr>
                                <tr><td class="text-muted">Email</td><td>${c.email||'N/A'}</td></tr>
                                <tr><td class="text-muted">Phone</td><td>${c.phone||'N/A'}</td></tr>
                                <tr><td class="text-muted">Address</td><td>${c.address||'N/A'}, ${c.city||''} ${c.country||''}</td></tr>
                                <tr><td class="text-muted">Website</td><td>${c.website||'N/A'}</td></tr>
                                <tr><td class="text-muted">Tax ID</td><td>${c.taxId||'N/A'}</td></tr>
                                <tr><td class="text-muted">Status</td><td><span class="badge ${c.isActive?'badge-success':'badge-error'}">${c.isActive?'Active':'Inactive'}</span></td></tr>
                            </tbody></table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Subscription</h6>
                            ${data.subscription ? `<table class="table table-sm"><tbody>
                                <tr><td class="text-muted" style="width:140px;">Plan</td><td><span class="badge badge-info">${data.subscription.planName}</span></td></tr>
                                <tr><td class="text-muted">Status</td><td><span class="badge badge-success">${data.subscription.status}</span></td></tr>
                                <tr><td class="text-muted">Billing</td><td>${data.subscription.billingCycle}</td></tr>
                                <tr><td class="text-muted">Fee</td><td>$${(data.subscription.monthlyFee||0).toFixed(2)}/mo</td></tr>
                                <tr><td class="text-muted">Max Users</td><td>${data.subscription.maxUsers}</td></tr>
                            </tbody></table>` : '<p class="text-muted">No active subscription</p>'}

                            <h6 class="mb-3 mt-4">Enabled Modules (${data.modules.filter(m=>m.isEnabled).length})</h6>
                            <div class="d-flex flex-wrap gap-2">${data.modules.filter(m=>m.isEnabled).map(m=>`<span class="badge badge-info">${m.moduleName}</span>`).join('')||'<span class="text-muted">No modules enabled</span>'}</div>
                        </div>
                        <div class="col-12 mt-3">
                            <h6 class="mb-3">Users (${data.users.length})</h6>
                            <div class="data-table-wrapper"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Last Login</th></tr></thead><tbody>
                                ${data.users.map(u=>`<tr><td><strong>${u.firstName} ${u.lastName}</strong></td><td>${u.email}</td><td><span class="badge badge-neutral">${u.roleName}</span></td><td><span class="badge ${u.isActive?'badge-success':'badge-error'}">${u.isActive?'Active':'Inactive'}</span></td><td>${u.lastLoginAt?new Date(u.lastLoginAt).toLocaleDateString():'Never'}</td></tr>`).join('')||'<tr><td colspan="5" class="text-center py-3">No users</td></tr>'}
                            </tbody></table></div>
                        </div>
                    </div>`;
                document.getElementById('editCompanyFromViewBtn').onclick = () => { bootstrap.Modal.getInstance(document.getElementById('companyDetailsModal'))?.hide(); editCompany(id); };
                new bootstrap.Modal(document.getElementById('companyDetailsModal')).show();
            } catch (e) { showError('Failed to load company details'); }
        }

        let deleteCompanyId = null;
        function confirmDeleteCompany(id, name) {
            deleteCompanyId = id;
            document.getElementById('deleteCompanyName').textContent = name;
            new bootstrap.Modal(document.getElementById('deleteCompanyModal')).show();
        }

        document.getElementById('confirmDeleteCompanyBtn').addEventListener('click', async () => {
            if (!deleteCompanyId) return;
            try {
                showLoading();
                const res = await fetch(`/api/superadmin/companies/${deleteCompanyId}`, { method: 'DELETE' });
                const result = await res.json();
                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('deleteCompanyModal'))?.hide();
                if (result.success) { showSuccess(result.message); loadCompanies(); }
                else { showError(result.message || 'Failed to deactivate'); }
            } catch (e) { hideLoading(); showError('Failed to deactivate company'); }
        });

        async function openModuleAssign(companyId, companyName) {
            document.getElementById('assignModuleCompanyName').textContent = companyName;
            const content = document.getElementById('moduleAssignContent');
            content.innerHTML = '<div class="text-center py-4">Loading modules...</div>';
            new bootstrap.Modal(document.getElementById('moduleAssignModal')).show();

            try {
                const res = await fetch(`/api/superadmin/company-modules/${companyId}`);
                const modules = await res.json();
                content.innerHTML = `
                    <div class="list-group">${modules.map(m => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${m.moduleName}</h6>
                                <small class="text-muted">${m.description || ''}</small><br>
                                <small class="text-muted">$${(m.monthlyPrice||0).toFixed(2)}/mo | $${(m.annualPrice||0).toFixed(2)}/yr</small>
                                ${m.features ? `<br><small>${m.features.split(',').map(f=>'<span class="badge badge-neutral me-1">'+f.trim()+'</span>').join('')}</small>` : ''}
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="module_${m.moduleId}" ${m.isEnabled?'checked':''} onchange="toggleModule(${companyId}, ${m.moduleId}, this.checked)" style="width:3em;height:1.5em;cursor:pointer;">
                            </div>
                        </div>
                    `).join('')}</div>`;
            } catch (e) { content.innerHTML = '<p class="text-danger">Failed to load modules</p>'; }
        }

        async function toggleModule(companyId, moduleId, isEnabled) {
            try {
                const res = await fetch('/api/superadmin/company-modules', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ companyId, moduleId, isEnabled })
                });
                const result = await res.json();
                if (result.success) { showSuccess(result.message); loadCompanies(); }
                else { showError(result.message); }
            } catch (e) { showError('Failed to update module access'); }
        }
    </script>
}
