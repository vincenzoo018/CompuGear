@{
    ViewData["Title"] = "Ticket Escalations";
    Layout = "~/Views/Shared/_SupportLayout.cshtml";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title">Ticket Escalations</h1>
        <p class="page-subtitle">Escalate tickets to admin for special handling - Requires approval</p>
    </div>
    <button class="btn btn-warning" onclick="openEscalationModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/>
        </svg>
        Escalate Ticket
    </button>
</div>

<!-- Info Alert -->
<div class="alert alert-info d-flex align-items-center mb-4">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
    <strong>Escalation Process:</strong>&nbsp;Escalating tickets sends them for admin review. Use for complex issues requiring higher authority.
</div>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center p-3">
            <div class="h3 text-warning mb-1" id="pendingEscalations">0</div>
            <div class="text-muted small">Pending Escalations</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center p-3">
            <div class="h3 text-success mb-1" id="approvedEscalations">0</div>
            <div class="text-muted small">Approved</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center p-3">
            <div class="h3 text-danger mb-1" id="rejectedEscalations">0</div>
            <div class="text-muted small">Rejected</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center p-3">
            <div class="h3 text-info mb-1" id="openTickets">0</div>
            <div class="text-muted small">Open Tickets</div>
        </div>
    </div>
</div>

<!-- Escalations Table -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">My Escalation Requests</h5>
        <span class="badge bg-primary" id="requestCount">0</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Request Code</th>
                        <th>Ticket #</th>
                        <th>Subject</th>
                        <th>Priority</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Admin Notes</th>
                    </tr>
                </thead>
                <tbody id="escalationsTableBody">
                    <tr><td colspan="8" class="text-center py-4">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center" id="escalationsPagination"></div>
</div>

<!-- Escalation Modal -->
<div class="modal fade" id="escalationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Escalate Support Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="escalationForm" onsubmit="submitEscalation(event)">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Escalating a ticket will send it to an administrator for review and special handling.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Ticket to Escalate <span class="text-danger">*</span></label>
                        <select class="form-select" id="ticketId" required onchange="loadTicketDetails()">
                            <option value="">-- Select a Ticket --</option>
                        </select>
                    </div>
                    
                    <div id="ticketDetails" style="display: none;">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Ticket:</strong> <span id="ticketNumber">-</span><br>
                                        <strong>Subject:</strong> <span id="ticketSubject">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Customer:</strong> <span id="customerName">-</span><br>
                                        <strong>Current Priority:</strong> <span id="currentPriority" class="badge bg-secondary">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Escalation Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="escalationType" required>
                                <option value="Priority">Priority Upgrade</option>
                                <option value="Refund">Refund Required</option>
                                <option value="Technical">Technical Expert Needed</option>
                                <option value="Complaint">Customer Complaint</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Requested Priority <span class="text-danger">*</span></label>
                            <select class="form-select" id="requestedPriority" required>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Reason for Escalation <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="reason" rows="3" required placeholder="Explain why this ticket needs to be escalated..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Suggested Action</label>
                            <textarea class="form-control" id="suggestedAction" rows="2" placeholder="What action do you recommend?"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="submitBtn" disabled>Submit Escalation</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let allRequests = [];
    let tickets = [];
    let selectedTicket = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadTickets();
        loadMyEscalations();
    });

    async function loadTickets() {
        try {
            const response = await fetch('/api/tickets?status=Open,In Progress,Pending Customer');
            tickets = await response.json();
            
            document.getElementById('openTickets').textContent = tickets.length;
            
            const select = document.getElementById('ticketId');
            select.innerHTML = '<option value="">-- Select a Ticket --</option>' + 
                tickets.map(t => `<option value="${t.ticketId}">${t.ticketNumber} - ${t.subject}</option>`).join('');
        } catch (error) {
            console.error('Error loading tickets:', error);
        }
    }

    async function loadMyEscalations() {
        try {
            const response = await fetch('/api/approval-requests/my-requests?module=Support&requestType=TicketEscalate');
            allRequests = await response.json();
            renderEscalations();
            updateStats();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderEscalations() {
        const tbody = document.getElementById('escalationsTableBody');
        document.getElementById('requestCount').textContent = allRequests.length;
        
        if (allRequests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No escalations found</td></tr>';
            return;
        }
        
        tbody.innerHTML = allRequests.map(r => {
            const data = r.requestData ? JSON.parse(r.requestData) : {};
            const priorityClass = r.priority === 'Urgent' ? 'danger' : r.priority === 'High' ? 'warning' : 'secondary';
            return `
                <tr>
                    <td><code>${r.requestCode}</code></td>
                    <td>${data.ticketNumber || '-'}</td>
                    <td>${data.ticketSubject || '-'}</td>
                    <td><span class="badge bg-${priorityClass}">${r.priority}</span></td>
                    <td>${r.reason}</td>
                    <td><span class="badge bg-${r.status === 'Pending' ? 'warning' : r.status === 'Approved' ? 'success' : 'danger'}">${r.status}</span></td>
                    <td>${new Date(r.requestedAt).toLocaleDateString()}</td>
                    <td>${r.approvalNotes || '-'}</td>
                </tr>
            `;
        }).join('');
        if (typeof initPagination === 'function') initPagination('escalationsTableBody', 'escalationsPagination', 10);
    }

    function updateStats() {
        const pending = allRequests.filter(r => r.status === 'Pending').length;
        const approved = allRequests.filter(r => r.status === 'Approved').length;
        const rejected = allRequests.filter(r => r.status === 'Rejected').length;
        
        document.getElementById('pendingEscalations').textContent = pending;
        document.getElementById('approvedEscalations').textContent = approved;
        document.getElementById('rejectedEscalations').textContent = rejected;
    }

    function openEscalationModal() {
        document.getElementById('escalationForm').reset();
        document.getElementById('ticketDetails').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
        selectedTicket = null;
        new bootstrap.Modal(document.getElementById('escalationModal')).show();
    }

    function loadTicketDetails() {
        const ticketId = document.getElementById('ticketId').value;
        if (!ticketId) {
            document.getElementById('ticketDetails').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            selectedTicket = null;
            return;
        }
        
        selectedTicket = tickets.find(t => t.ticketId == ticketId);
        if (!selectedTicket) return;
        
        document.getElementById('ticketNumber').textContent = selectedTicket.ticketNumber;
        document.getElementById('ticketSubject').textContent = selectedTicket.subject;
        document.getElementById('customerName').textContent = selectedTicket.customerName || selectedTicket.contactName || 'Unknown';
        document.getElementById('currentPriority').textContent = selectedTicket.priority;
        document.getElementById('currentPriority').className = `badge bg-${selectedTicket.priority === 'Critical' ? 'danger' : selectedTicket.priority === 'High' ? 'warning' : 'secondary'}`;
        
        document.getElementById('ticketDetails').style.display = 'block';
        document.getElementById('submitBtn').disabled = false;
    }

    async function submitEscalation(event) {
        event.preventDefault();
        
        if (!selectedTicket) return;
        
        const reason = document.getElementById('reason').value;
        const escalationType = document.getElementById('escalationType').value;
        const requestedPriority = document.getElementById('requestedPriority').value;
        const suggestedAction = document.getElementById('suggestedAction').value;
        
        if (!reason || reason.length < 10) {
            alert('Please provide a detailed reason (at least 10 characters)');
            return;
        }
        
        const data = {
            requestType: 'TicketEscalate',
            module: 'Support',
            title: `Escalate Ticket ${selectedTicket.ticketNumber} - ${escalationType}`,
            description: `Escalation request for ticket: ${selectedTicket.subject}`,
            reason: reason,
            entityType: 'Ticket',
            entityId: selectedTicket.ticketId,
            entityName: selectedTicket.ticketNumber,
            priority: requestedPriority,
            requestData: JSON.stringify({
                ticketId: selectedTicket.ticketId,
                ticketNumber: selectedTicket.ticketNumber,
                ticketSubject: selectedTicket.subject,
                customerId: selectedTicket.customerId,
                customerName: selectedTicket.customerName || selectedTicket.contactName,
                currentPriority: selectedTicket.priority,
                escalationType: escalationType,
                requestedPriority: requestedPriority,
                suggestedAction: suggestedAction
            })
        };
        
        try {
            const response = await fetch('/api/approval-requests', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                alert('Escalation request submitted successfully!');
                bootstrap.Modal.getInstance(document.getElementById('escalationModal')).hide();
                loadMyEscalations();
            } else {
                alert(result.message || 'Failed to submit escalation');
            }
        } catch (error) {
            alert('Error submitting escalation');
        }
    }
</script>
}
