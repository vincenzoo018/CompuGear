@{
    ViewData["Title"] = "Knowledge Base";
    Layout = "~/Views/Shared/_SupportLayout.cshtml";
}

<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <p class="text-muted mb-0">Support</p>
        <h1 class="page-title">Knowledge Base</h1>
        <p class="page-subtitle">Help articles and documentation for support</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="openRequestArticleModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Request New Article
        </button>
    </div>
</div>

<style>
    .readonly-notice {
        background: linear-gradient(135deg, #fef3cd, #fff8e1);
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        color: #92400e;
        margin-bottom: 20px;
    }

    .stat-cards-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card-mini {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .stat-icon-mini {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-icon-mini.primary { background: linear-gradient(135deg, #cffafe, #a5f3fc); color: #0d9488; }
    .stat-icon-mini.success { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #16a34a; }
    .stat-icon-mini.warning { background: linear-gradient(135deg, #fef3cd, #fde68a); color: #d97706; }
    .stat-icon-mini.info { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }

    .stat-icon-mini svg { width: 24px; height: 24px; }

    .stat-content-mini h4 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--foreground);
    }

    .stat-content-mini span {
        font-size: 0.85rem;
        color: var(--muted-foreground);
    }

    .search-card {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .category-pills {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }

    .category-pill {
        padding: 10px 20px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .category-pill:hover, .category-pill.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .category-pill .count {
        background: rgba(0,0,0,0.1);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
    }

    .category-pill.active .count { background: rgba(255,255,255,0.2); }

    .articles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .article-card {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: all 0.2s;
    }

    .article-card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .article-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
    }

    .article-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .article-status.published { background: #dcfce7; color: #16a34a; }
    .article-status.draft { background: #f3f4f6; color: #6b7280; }
    .article-status.pending { background: #fef3cd; color: #d97706; }
    .article-status.archived { background: #fee2e2; color: #dc2626; }

    .article-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .article-category {
        font-size: 0.8rem;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .article-card-body {
        padding: 20px;
    }

    .article-summary {
        color: var(--muted-foreground);
        font-size: 0.9rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 15px;
    }

    .article-meta {
        display: flex;
        gap: 20px;
        font-size: 0.8rem;
        color: var(--muted-foreground);
    }

    .article-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .article-card-footer {
        padding: 15px 20px;
        background: var(--muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .article-tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .article-tag {
        background: var(--card);
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 0.7rem;
        color: var(--muted-foreground);
    }

    .pending-requests-section {
        background: linear-gradient(135deg, #fef3cd, #fff8e1);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .pending-requests-section h4 {
        color: #92400e;
        font-size: 1rem;
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .pending-article-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pending-article-item:last-child { margin-bottom: 0; }

    .pending-article-info h5 {
        margin: 0 0 5px 0;
        font-size: 0.95rem;
        color: #1f2937;
    }

    .pending-article-info span {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--muted-foreground);
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        stroke: var(--border);
        margin-bottom: 20px;
    }

    @@media (max-width: 1024px) {
        .stat-cards-row { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 768px) {
        .stat-cards-row { grid-template-columns: 1fr; }
        .articles-grid { grid-template-columns: 1fr; }
    }
</style>

<!-- Notice about view-only access for certain features -->
<div class="readonly-notice">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
    <span>You can view and request new articles. Publishing and managing articles requires Admin approval.</span>
</div>

<!-- Stats -->
<div class="stat-cards-row">
    <div class="stat-card-mini">
        <div class="stat-icon-mini primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
            </svg>
        </div>
        <div class="stat-content-mini">
            <h4 id="totalArticles">0</h4>
            <span>Total Articles</span>
        </div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-icon-mini success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <div class="stat-content-mini">
            <h4 id="publishedArticles">0</h4>
            <span>Published</span>
        </div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-icon-mini warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        </div>
        <div class="stat-content-mini">
            <h4 id="myPendingArticles">0</h4>
            <span>My Pending</span>
        </div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-icon-mini info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
            </svg>
        </div>
        <div class="stat-content-mini">
            <h4 id="totalViews">0</h4>
            <span>Total Views</span>
        </div>
    </div>
</div>

<!-- My Pending Requests -->
<div class="pending-requests-section" id="myPendingRequestsSection" style="display: none;">
    <h4>‚è≥ My Pending Article Requests</h4>
    <div id="myPendingRequestsList"></div>
</div>

<!-- Search & Filter -->
<div class="search-card">
    <div class="row g-3 align-items-end">
        <div class="col-md-5">
            <label class="form-label">Search Articles</label>
            <input type="text" class="form-control" id="searchArticles" placeholder="Search by title or content..." oninput="filterArticles()">
        </div>
        <div class="col-md-3">
            <label class="form-label">Category</label>
            <select class="form-select" id="filterCategory" onchange="filterArticles()">
                <option value="">All Categories</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Status</label>
            <select class="form-select" id="filterStatus" onchange="filterArticles()">
                <option value="">All Status</option>
                <option value="Published">Published</option>
                <option value="Pending Approval">Pending Approval</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
                Reset
            </button>
        </div>
    </div>
</div>

<!-- Category Pills -->
<div class="category-pills" id="categoryPills">
    <div class="category-pill active" data-category="" onclick="selectCategory(this)">
        üìö All
        <span class="count" id="allCount">0</span>
    </div>
</div>

<!-- Articles Grid -->
<div class="articles-grid" id="articlesGrid">
    <div class="empty-state" style="grid-column: 1/-1;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading articles...</p>
    </div>
</div>

<!-- Request Article Modal -->
<div class="modal fade" id="requestArticleModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #0d9488); color: white;">
                <h5 class="modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Request New Article
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="requestArticleForm" onsubmit="submitArticleRequest(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Note:</strong> Your article request will be reviewed by an Admin before being published.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="requestTitle" placeholder="Article title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="requestCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Summary</label>
                        <textarea class="form-control" id="requestSummary" rows="2" placeholder="Brief summary of the article"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="requestContent" rows="8" placeholder="Full article content..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="requestTags" placeholder="e.g., orders, shipping, returns">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit for Approval</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Article Modal -->
<div class="modal fade" id="viewArticleModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewArticleTitle">Article Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <span class="article-status published" id="viewArticleStatus">Published</span>
                    <span class="article-category ms-2" id="viewArticleCategory">Category</span>
                </div>
                <div id="viewArticleContent" style="line-height: 1.8;"></div>
                <hr>
                <div class="d-flex gap-4 text-muted small">
                    <span>üëÅÔ∏è <span id="viewArticleViews">0</span> views</span>
                    <span>üëç <span id="viewArticleHelpful">0</span> helpful</span>
                    <span>üìÖ Updated: <span id="viewArticleUpdated"></span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="successMessage">Success!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="errorMessage">Error!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let allArticles = [];
    let allCategories = [];
    let currentUserId = null;

    document.addEventListener('DOMContentLoaded', function() {
        getCurrentUser();
        loadCategories();
        loadArticles();
    });

    async function getCurrentUser() {
        try {
            const response = await fetch('/api/GetCurrentUser');
            const result = await response.json();
            if (result.success) {
                currentUserId = result.data.userId;
                // Load pending requests after getting user ID
                loadMyPendingRequests();
            }
        } catch (error) {
            console.error('Error getting current user:', error);
        }
    }

    async function loadCategories() {
        try {
            const response = await fetch('/api/knowledge-categories');
            const categories = await response.json();
            allCategories = Array.isArray(categories) ? categories : [];

            // Populate filter dropdown
            const filterSelect = document.getElementById('filterCategory');
            const requestSelect = document.getElementById('requestCategory');
            allCategories.forEach(cat => {
                filterSelect.innerHTML += `<option value="${cat.categoryId}">${cat.categoryName}</option>`;
                requestSelect.innerHTML += `<option value="${cat.categoryId}">${cat.categoryName}</option>`;
            });

            // Populate category pills
            const pillsContainer = document.getElementById('categoryPills');
            allCategories.forEach(cat => {
                pillsContainer.innerHTML += `
                    <div class="category-pill" data-category="${cat.categoryId}" onclick="selectCategory(this)">
                        üìÅ ${cat.categoryName}
                        <span class="count" id="cat-count-${cat.categoryId}">0</span>
                    </div>
                `;
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function loadArticles() {
        try {
            const response = await fetch('/api/knowledge-articles');
            const articles = await response.json();
            
            // Filter to show only Published and Pending Approval articles
            allArticles = (Array.isArray(articles) ? articles : []).filter(a => 
                a.status === 'Published' || a.status === 'Pending Approval'
            );
            
            updateStats();
            updateCategoryCounts();
            renderArticles(allArticles);
        } catch (error) {
            console.error('Error loading articles:', error);
            document.getElementById('articlesGrid').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h5>No articles available</h5>
                    <p>Be the first to request an article!</p>
                </div>
            `;
        }
    }

    async function loadMyPendingRequests() {
        if (!currentUserId) return;
        
        try {
            const response = await fetch('/api/knowledge-articles');
            const articles = await response.json();
            
            const allArticlesArray = Array.isArray(articles) ? articles : [];
            const myPending = allArticlesArray.filter(a => 
                a.status === 'Pending Approval' && a.createdBy === currentUserId
            );
            
            document.getElementById('myPendingArticles').textContent = myPending.length;
            
            if (myPending.length > 0) {
                document.getElementById('myPendingRequestsSection').style.display = 'block';
                document.getElementById('myPendingRequestsList').innerHTML = myPending.map(article => `
                    <div class="pending-article-item">
                        <div class="pending-article-info">
                            <h5>${escapeHtml(article.title)}</h5>
                            <span>Submitted ${formatDate(article.createdAt)}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewArticle(${article.articleId})">View</button>
                    </div>
                `).join('');
            } else {
                document.getElementById('myPendingRequestsSection').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading pending requests:', error);
        }
    }

    function updateStats() {
        document.getElementById('totalArticles').textContent = allArticles.length;
        document.getElementById('publishedArticles').textContent = allArticles.filter(a => a.status === 'Published').length;
        document.getElementById('totalViews').textContent = allArticles.reduce((sum, a) => sum + (a.viewCount || 0), 0);
        document.getElementById('allCount').textContent = allArticles.length;
    }

    function updateCategoryCounts() {
        allCategories.forEach(cat => {
            const count = allArticles.filter(a => a.categoryId === cat.categoryId).length;
            const countEl = document.getElementById(`cat-count-${cat.categoryId}`);
            if (countEl) countEl.textContent = count;
        });
    }

    function renderArticles(articles) {
        const container = document.getElementById('articlesGrid');
        
        if (articles.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h5>No articles found</h5>
                    <p>Try adjusting your search or filters.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = articles.map(article => {
            const statusClass = article.status === 'Published' ? 'published' : 
                              article.status === 'Pending Approval' ? 'pending' : 'draft';
            const tags = article.tags ? article.tags.split(',').slice(0, 3) : [];
            const category = allCategories.find(c => c.categoryId === article.categoryId);

            return `
                <div class="article-card">
                    <div class="article-card-header">
                        <span class="article-status ${statusClass}">${article.status}</span>
                        <h3 class="article-title">${escapeHtml(article.title)}</h3>
                        <span class="article-category">
                            üìÅ ${category ? category.categoryName : 'Uncategorized'}
                        </span>
                    </div>
                    <div class="article-card-body">
                        <p class="article-summary">${escapeHtml(article.summary || (article.content ? article.content.substring(0, 150) + '...' : ''))}</p>
                        <div class="article-meta">
                            <span class="article-meta-item">üëÅÔ∏è ${article.viewCount || 0}</span>
                            <span class="article-meta-item">üëç ${article.helpfulCount || 0}</span>
                            <span class="article-meta-item">üìÖ ${formatDate(article.updatedAt)}</span>
                        </div>
                    </div>
                    <div class="article-card-footer">
                        <div class="article-tags">
                            ${tags.map(tag => `<span class="article-tag">${escapeHtml(tag.trim())}</span>`).join('')}
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewArticle(${article.articleId})">Read</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectCategory(element) {
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('filterCategory').value = element.dataset.category;
        filterArticles();
    }

    function filterArticles() {
        const search = document.getElementById('searchArticles').value.toLowerCase();
        const categoryId = document.getElementById('filterCategory').value;
        const status = document.getElementById('filterStatus').value;

        let filtered = allArticles;

        if (search) {
            filtered = filtered.filter(a => 
                a.title.toLowerCase().includes(search) || 
                (a.content && a.content.toLowerCase().includes(search)) ||
                (a.tags && a.tags.toLowerCase().includes(search))
            );
        }

        if (categoryId) {
            filtered = filtered.filter(a => a.categoryId == categoryId);
        }

        if (status) {
            filtered = filtered.filter(a => a.status === status);
        }

        renderArticles(filtered);
    }

    function resetFilters() {
        document.getElementById('searchArticles').value = '';
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterStatus').value = '';
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        document.querySelector('.category-pill[data-category=""]').classList.add('active');
        renderArticles(allArticles);
    }

    function openRequestArticleModal() {
        document.getElementById('requestArticleForm').reset();
        new bootstrap.Modal(document.getElementById('requestArticleModal')).show();
    }

    async function submitArticleRequest(event) {
        event.preventDefault();

        const data = {
            title: document.getElementById('requestTitle').value,
            categoryId: parseInt(document.getElementById('requestCategory').value) || null,
            summary: document.getElementById('requestSummary').value,
            content: document.getElementById('requestContent').value,
            tags: document.getElementById('requestTags').value,
            status: 'Pending Approval'
        };

        try {
            const response = await fetch('/api/knowledge-articles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success || response.ok) {
                showSuccess('Article request submitted! It will be reviewed by an Admin.');
                bootstrap.Modal.getInstance(document.getElementById('requestArticleModal')).hide();
                loadArticles();
                loadMyPendingRequests();
            } else {
                showError(result.message || 'Failed to submit article request');
            }
        } catch (error) {
            showError('Error submitting article request');
        }
    }

    async function viewArticle(articleId) {
        try {
            const response = await fetch(`/api/knowledge-articles/${articleId}`);
            const article = await response.json();

            const category = allCategories.find(c => c.categoryId === article.categoryId);
            const statusClass = article.status === 'Published' ? 'published' : 
                              article.status === 'Pending Approval' ? 'pending' : 'draft';

            document.getElementById('viewArticleTitle').textContent = article.title;
            document.getElementById('viewArticleStatus').textContent = article.status;
            document.getElementById('viewArticleStatus').className = `article-status ${statusClass}`;
            document.getElementById('viewArticleCategory').textContent = category ? category.categoryName : 'Uncategorized';
            document.getElementById('viewArticleContent').innerHTML = (article.content || '').replace(/\n/g, '<br>');
            document.getElementById('viewArticleViews').textContent = article.viewCount || 0;
            document.getElementById('viewArticleHelpful').textContent = article.helpfulCount || 0;
            document.getElementById('viewArticleUpdated').textContent = formatDate(article.updatedAt);

            new bootstrap.Modal(document.getElementById('viewArticleModal')).show();
        } catch (error) {
            showError('Error loading article');
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        new bootstrap.Toast(document.getElementById('successToast')).show();
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        new bootstrap.Toast(document.getElementById('errorToast')).show();
    }
</script>
}
