@{
    Layout = "~/Views/ERPWebsite/_ERPWebsiteLayout.cshtml";
    ViewData["Title"] = "Payment Successful";
    ViewData["ActivePage"] = "Pricing";
}

@section Styles {
    .payment-page {
        padding: 80px 24px 120px;
        background: #f8f9fc;
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .payment-card {
        background: #fff;
        border-radius: 30px;
        padding: 56px 56px;
        max-width: 700px;
        width: 100%;
        text-align: center;
        box-shadow: 0 24px 64px rgba(0,0,0,0.12);
        border: 1px solid #eef0f3;
    }

    .payment-icon {
        width: 98px; height: 98px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
    }
    .payment-icon.success { background: rgba(16,185,129,0.14); color: #10B981; }
    .payment-icon.loading { background: rgba(0,128,128,0.1); color: #008080; }
    .payment-icon.error { background: rgba(239,68,68,0.14); color: #ef4444; }

    .payment-card h2 {
        font-size: 2.8rem; font-weight: 800; color: #059669; margin-bottom: 14px;
        line-height: 1.05;
    }
    .payment-card p {
        font-size: 0.95rem; color: #6b7280; line-height: 1.7; margin-bottom: 8px;
    }

    .success-note {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #475569;
    }

    .success-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 18px;
    }

    #successState p,
    #errorState p,
    #verifyingState p {
        font-size: 1.12rem;
        max-width: 560px;
        margin-left: auto;
        margin-right: auto;
    }

    #errorState h2 { color: #dc2626; }
    #verifyingState h2 { color: #0f766e; font-size: 2.1rem; }

    .payment-details {
        background: #f8f9fc; border-radius: 18px; padding: 24px 28px;
        margin: 28px auto 10px; text-align: left;
        max-width: 560px;
    }
    .payment-details .detail-row {
        display: flex; justify-content: space-between;
        padding: 12px 0; font-size: 1.05rem;
        border-bottom: 1px solid #eee;
    }
    .payment-details .detail-row:last-child { border-bottom: none; }
    .payment-details .detail-label { color: #94a3b8; }
    .payment-details .detail-value { font-weight: 700; color: #1f2937; }

    .btn-login {
        display: inline-block; padding: 16px 50px;
        background: #007a79; color: #fff;
        border-radius: 16px; font-weight: 700; font-size: 1.1rem;
        transition: all 0.3s; margin-top: 24px;
        cursor: pointer; border: none;
        font-family: 'Poppins', sans-serif;
        box-shadow: 0 10px 26px rgba(0,122,121,0.22);
    }
    .btn-login:hover { background: #006666; transform: translateY(-2px); }

    .btn-retry {
        display: inline-block; padding: 14px 30px;
        background: #fff; color: #008080;
        border: 2px solid #e2e8f0;
        border-radius: 14px; font-weight: 700; font-size: 1rem;
        transition: all 0.3s; margin-top: 16px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
    }
    .btn-retry:hover { background: rgba(0,128,128,0.05); border-color: #008080; }

    .spinner-verify {
        width: 36px; height: 36px;
        border: 3px solid rgba(0,128,128,0.2);
        border-top-color: #008080;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }
    @@keyframes spin { to { transform: rotate(360deg); } }

    #verifyingState, #successState, #errorState { display: none; }
    #verifyingState.active, #successState.active, #errorState.active { display: block; }

    @@media (max-width: 768px) {
        .payment-card { padding: 36px 24px; border-radius: 22px; }
        .payment-card h2 { font-size: 2.1rem; }
        .payment-details { padding: 18px 16px; }
        .payment-details .detail-row { font-size: 0.95rem; }
        #successState p, #errorState p, #verifyingState p { font-size: 0.98rem; }
    }
}

<section class="payment-page">
    <div class="payment-card">

        <!-- Verifying State -->
        <div id="verifyingState" class="active">
            <div class="payment-icon loading">
                <div class="spinner-verify"></div>
            </div>
            <h2>Verifying Payment...</h2>
            <p>Please wait while we confirm your payment with PayMongo and set up your account.</p>
        </div>

        <!-- Success State -->
        <div id="successState">
            <div class="payment-icon success">
                <svg width="58" height="58" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="8 12 11 15 16 9"/>
                </svg>
            </div>
            <h2>Thank You for Subscribing!</h2>
            <p>Your CompuGear ERP subscription is now active. Your account has been created and is ready to use.</p>

            <div class="payment-details">
                <div class="detail-row">
                    <span class="detail-label">Company</span>
                    <span class="detail-value" id="detailCompany">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Plan</span>
                    <span class="detail-value" id="detailPlan">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Login Email</span>
                    <span class="detail-value" id="detailEmail">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Ref</span>
                    <span class="detail-value" id="detailPayment">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" style="color:#10B981;">âœ“ Confirmed</span>
                </div>
            </div>

            <p class="success-note">
                You will be redirected to the login page in <strong id="redirectSeconds">10</strong> seconds.
            </p>
            <div class="success-actions">
                <a href="/Auth/Login" class="btn-login">Go to Login</a>
                <a href="/ERPWebsite/Pricing" class="btn-retry" style="margin-top: 0;">View Plans</a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState">
            <div class="payment-icon error">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>
            <h2>Verification Failed</h2>
            <p id="errorMessage">We could not verify your payment. If you were charged, please contact our support team.</p>
            <button class="btn-retry" onclick="retryVerification()">Try Again</button>
            <br>
            <a href="/ERPWebsite/Subscribe" class="btn-retry" style="margin-top: 8px; display: inline-block;">Back to Subscribe</a>
        </div>

    </div>
</section>

@section Scripts {
    <script>
        const registrationId = '@ViewData["RegistrationId"]';
        const sessionId = '@ViewData["SessionId"]';

        // Auto-verify on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (registrationId) {
                verifyPayment();
            } else {
                showState('error', 'Missing registration information. Please start a new subscription.');
            }
        });

        async function verifyPayment() {
            showState('verifying');

            try {
                const response = await fetch('/api/erpwebsite/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        registrationId: registrationId,
                        sessionId: sessionId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show success with details
                    document.getElementById('detailCompany').textContent = result.companyName || '-';
                    document.getElementById('detailPlan').textContent = (result.planName || '-') + ' Plan';
                    document.getElementById('detailEmail').textContent = result.adminEmail || '-';
                    document.getElementById('detailPayment').textContent = result.paymentId
                        ? result.paymentId.substring(0, 16) + '...'
                        : '-';
                    showState('success');
                    startRedirectCountdown();
                } else {
                    showState('error', result.message || 'Payment verification failed.');
                }
            } catch (err) {
                console.error('Verification error:', err);
                showState('error', 'Network error. Please check your connection and try again.');
            }
        }

        function startRedirectCountdown() {
            const secondsEl = document.getElementById('redirectSeconds');
            if (!secondsEl) return;

            let seconds = 10;
            secondsEl.textContent = seconds;

            const timer = setInterval(() => {
                seconds -= 1;
                secondsEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(timer);
                    window.location.href = '/Auth/Login';
                }
            }, 1000);
        }

        function retryVerification() {
            verifyPayment();
        }

        function showState(state, errorMsg) {
            document.getElementById('verifyingState').classList.remove('active');
            document.getElementById('successState').classList.remove('active');
            document.getElementById('errorState').classList.remove('active');

            if (state === 'verifying') {
                document.getElementById('verifyingState').classList.add('active');
            } else if (state === 'success') {
                document.getElementById('successState').classList.add('active');
            } else if (state === 'error') {
                if (errorMsg) {
                    document.getElementById('errorMessage').textContent = errorMsg;
                }
                document.getElementById('errorState').classList.add('active');
            }
        }

    </script>
}
