@{
    Layout = "~/Views/ERPWebsite/_ERPWebsiteLayout.cshtml";
    ViewData["Title"] = "Subscribe";
    ViewData["ActivePage"] = "Pricing";
}

@section Styles {
    .subscribe-page { padding: 60px 24px 80px; background: #f8f9fc; min-height: 80vh; }
    .subscribe-container {
        max-width: 1000px; margin: 0 auto;
        display: grid; grid-template-columns: 1fr 380px; gap: 40px;
        align-items: start;
    }

    /* Form Card */
    .form-card {
        background: #fff; border-radius: 16px; padding: 40px;
        border: 1px solid #eee; box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .form-card h2 { font-size: 1.6rem; font-weight: 700; color: #1a1a2e; margin-bottom: 8px; }
    .form-card .form-subtitle { font-size: 0.95rem; color: #888; margin-bottom: 32px; }

    .form-section-title {
        font-size: 0.85rem; font-weight: 600; color: #008080;
        text-transform: uppercase; letter-spacing: 1px;
        margin-bottom: 16px; margin-top: 28px;
        padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
    }
    .form-section-title:first-of-type { margin-top: 0; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
        display: block; font-size: 0.85rem; font-weight: 500;
        color: #555; margin-bottom: 6px;
    }
    .form-group label .required { color: #ef4444; }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%; padding: 10px 14px; border: 1.5px solid #e0e0e0;
        border-radius: 8px; font-size: 0.95rem; font-family: 'Poppins', sans-serif;
        color: #333; transition: border-color 0.2s; background: #fff;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none; border-color: #008080;
        box-shadow: 0 0 0 3px rgba(0,128,128,0.08);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-group .input-error { border-color: #ef4444 !important; }
    .form-group .error-msg { font-size: 0.8rem; color: #ef4444; margin-top: 4px; display: none; }

    .form-check {
        display: flex; align-items: flex-start; gap: 10px;
        margin: 20px 0; font-size: 0.88rem; color: #666;
    }
    .form-check input[type="checkbox"] {
        width: 18px; height: 18px; accent-color: #008080; margin-top: 2px; cursor: pointer;
    }
    .form-check a { color: #008080; text-decoration: underline; }

    .module-selector {
        border: 1.5px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
    }
    .module-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
    }
    .module-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid #e6e6e6;
        border-radius: 8px;
        background: #fafafa;
        font-size: 0.9rem;
        color: #444;
    }
    .module-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #008080;
    }

    .btn-subscribe {
        width: 100%; padding: 14px 0; background: #008080; color: #fff;
        border: none; border-radius: 10px; font-size: 1rem; font-weight: 600;
        cursor: pointer; transition: all 0.3s;
        font-family: 'Poppins', sans-serif;
    }
    .btn-subscribe:hover { background: #006666; }
    .btn-subscribe:disabled { background: #ccc; cursor: not-allowed; }
    .btn-subscribe .spinner {
        display: none; width: 20px; height: 20px;
        border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
        border-radius: 50%; animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }
    @@keyframes spin { to { transform: rotate(360deg); } }

    /* Order Summary Card */
    .summary-card {
        background: #fff; border-radius: 16px; padding: 32px;
        border: 2px solid #008080; position: sticky; top: 96px;
    }
    .summary-card h3 { font-size: 1.15rem; font-weight: 700; color: #1a1a2e; margin-bottom: 24px; }
    .summary-card .plan-badge {
        display: inline-block; background: rgba(0,128,128,0.1);
        color: #008080; font-weight: 600; font-size: 0.85rem;
        padding: 4px 14px; border-radius: 20px; margin-bottom: 16px;
    }
    .summary-card .plan-price {
        font-size: 2.4rem; font-weight: 800; color: #1a1a2e; margin-bottom: 4px;
    }
    .summary-card .plan-price .per { font-size: 1rem; font-weight: 400; color: #999; }
    .summary-card .annual-note { font-size: 0.85rem; color: #aaa; margin-bottom: 24px; }
    .summary-card .summary-divider { border: none; border-top: 1px solid #f0f0f0; margin: 16px 0; }
    .summary-card .summary-features { list-style: none; }
    .summary-card .summary-features li {
        display: flex; align-items: center; gap: 8px;
        font-size: 0.9rem; color: #555; padding: 6px 0;
    }
    .summary-card .summary-features li svg { color: #10B981; flex-shrink: 0; }
    .summary-card .summary-total {
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;
        font-weight: 700; font-size: 1.05rem; color: #1a1a2e;
    }

    /* Toast notification */
    .toast-container {
        position: fixed; top: 90px; right: 24px; z-index: 3000;
        display: flex; flex-direction: column; gap: 12px;
        pointer-events: none;
    }
    .toast-card {
        pointer-events: auto;
        display: flex; align-items: flex-start; gap: 14px;
        background: #fff; border-radius: 14px; padding: 20px 24px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        border-left: 5px solid #10B981;
        max-width: 440px; width: 100%;
        animation: toastSlideIn 0.4s ease;
        transition: opacity 0.3s, transform 0.3s;
    }
    .toast-card.error { border-left-color: #ef4444; }
    .toast-card .toast-icon {
        flex-shrink: 0; width: 42px; height: 42px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }
    .toast-card .toast-icon.success { background: #10B981; color: #ffffff; }
    .toast-card .toast-icon.error { background: #ef4444; color: #ffffff; }
    .toast-card .toast-body { flex: 1; }
    .toast-card .toast-title { font-weight: 700; font-size: 1rem; color: #1a1a2e; margin-bottom: 4px; }
    .toast-card .toast-msg { font-size: 0.88rem; color: #666; line-height: 1.5; }
    .toast-card .toast-actions { margin-top: 12px; display: flex; gap: 10px; }
    .toast-card .toast-btn {
        padding: 8px 22px; border-radius: 8px; font-weight: 600; font-size: 0.85rem;
        cursor: pointer; transition: all 0.2s; border: none; font-family: 'Poppins', sans-serif;
    }
    .toast-card .toast-btn-primary { background: #008080; color: #fff; }
    .toast-card .toast-btn-primary:hover { background: #006666; }
    .toast-card .toast-btn-secondary { background: #f0f0f0; color: #555; }
    .toast-card .toast-btn-secondary:hover { background: #e0e0e0; }
    .toast-card .toast-close {
        flex-shrink: 0; background: none; border: none; cursor: pointer;
        color: #aaa; padding: 4px; transition: color 0.2s;
    }
    .toast-card .toast-close:hover { color: #333; }
    @@keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @@media (max-width: 768px) {
        .subscribe-container { grid-template-columns: 1fr; }
        .form-row { grid-template-columns: 1fr; }
        .summary-card { position: static; order: -1; }
        .module-grid { grid-template-columns: 1fr; }
    }
}

<section class="subscribe-page">
    <div class="subscribe-container">
        <!-- Registration Form -->
        <div class="form-card">
            <h2>Create Your Account</h2>
            <p class="form-subtitle">Fill in your details to subscribe and get started with CompuGear ERP.</p>

            <form id="subscribeForm" onsubmit="return false;">
                <!-- Company Information -->
                <div class="form-section-title">Company Information</div>
                <div class="form-group">
                    <label>Company Name <span class="required">*</span></label>
                    <input type="text" id="companyName" placeholder="e.g. Acme Corporation" required>
                    <div class="error-msg" id="companyNameError">Company name is required</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Company Email <span class="required">*</span></label>
                        <input type="email" id="companyEmail" placeholder="info@company.com" required>
                        <div class="error-msg" id="companyEmailError">Valid email is required</div>
                    </div>
                    <div class="form-group">
                        <label>Company Phone <span class="required">*</span></label>
                        <input type="text" id="companyPhone" placeholder="+63 XXX XXX XXXX" required>
                        <div class="error-msg" id="companyPhoneError">Phone number is required</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Company Address</label>
                    <input type="text" id="companyAddress" placeholder="123 Business Street, City">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="companyCity" placeholder="Manila">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="companyCountry" placeholder="Philippines" value="Philippines">
                    </div>
                </div>

                <!-- Admin Account -->
                <div class="form-section-title">Admin Account Details</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" id="firstName" placeholder="Juan" required>
                        <div class="error-msg" id="firstNameError">First name is required</div>
                    </div>
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" id="lastName" placeholder="Dela Cruz" required>
                        <div class="error-msg" id="lastNameError">Last name is required</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" id="adminEmail" placeholder="juan@company.com" required>
                    <div class="error-msg" id="adminEmailError">Valid email is required</div>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="adminPhone" placeholder="+63 9XX XXX XXXX">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Password <span class="required">*</span></label>
                        <input type="password" id="password" placeholder="Min 8 characters" required>
                        <div class="error-msg" id="passwordError">Password must be at least 8 characters</div>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password <span class="required">*</span></label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                        <div class="error-msg" id="confirmPasswordError">Passwords do not match</div>
                    </div>
                </div>

                <!-- Subscription -->
                <div class="form-section-title">Subscription Details</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Plan <span class="required">*</span></label>
                        <select id="planName" onchange="updateSummary()">
                            <option value="Basic">Basic - ₱2,499/mo</option>
                            <option value="Pro">Pro - ₱4,999/mo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Billing Cycle</label>
                        <select id="billingCycle" onchange="updateSummary()">
                            <option value="Monthly">Monthly</option>
                            <option value="Annual">Annual (Save 2 months)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Modules Included <span class="required">*</span></label>
                    <div class="module-selector">
                        <div class="module-grid" id="moduleGrid"></div>
                    </div>
                    <div class="error-msg" id="modulesError">Please select at least one module</div>
                </div>

                <div class="form-check">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms">I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>. I understand that my subscription will begin immediately upon registration.</label>
                </div>

                <button type="button" class="btn-subscribe" id="btnSubscribe" onclick="submitSubscription()">
                    <span class="btn-text">Create Account & Subscribe</span>
                    <div class="spinner" id="btnSpinner"></div>
                </button>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="summary-card">
            <h3>Order Summary</h3>
            <div class="plan-badge" id="summaryPlanBadge">Basic Plan</div>
            <div class="plan-price" id="summaryPrice">₱2,499<span class="per">/month</span></div>
            <div class="annual-note" id="summaryAnnual">Billed annually at ₱29,988</div>

            <hr class="summary-divider">

            <ul class="summary-features" id="summaryFeatures">
                <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Up to 50 Users
                </li>
                <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Up to 3 Admin Users
                </li>
                <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Sales Module
                </li>
                <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Inventory Module
                </li>
            </ul>

            <div class="summary-total">
                <span>Total Due Today</span>
                <span id="summaryTotal">₱2,499</span>
            </div>
        </div>
    </div>
</section>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

@section Scripts {
    <script>
        // Plan data
        const plans = {
            Basic: {
                monthly: 2499, annual: 29988,
                maxUsers: 50, maxAdmins: 3,
                features: ['Up to 50 Users', 'Up to 3 Admin Users', 'Sales Module', 'Inventory Module'],
                modules: ['SALES', 'INVENTORY']
            },
            Pro: {
                monthly: 4999, annual: 59988,
                maxUsers: 200, maxAdmins: 10,
                features: ['Up to 200 Users', 'Up to 10 Admin Users', 'All ERP Modules', 'Billing & Invoicing', 'Advanced Analytics', 'Priority Email Support'],
                modules: ['SALES', 'CUSTOMERS', 'INVENTORY', 'BILLING', 'SUPPORT', 'MARKETING']
            }
        };

        const moduleLabels = {
            SALES: 'Sales',
            CUSTOMERS: 'Customers',
            INVENTORY: 'Inventory',
            BILLING: 'Billing',
            SUPPORT: 'Support',
            MARKETING: 'Marketing',
            ADMIN: 'Admin Dashboard'
        };

        // Set initial plan from URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialPlan = urlParams.get('plan');
        if (initialPlan && plans[initialPlan]) {
            document.getElementById('planName').value = initialPlan;
        }

        // Update summary on load
        updateSummary();

        function updateSummary() {
            const plan = document.getElementById('planName').value;
            const billing = document.getElementById('billingCycle').value;
            const data = plans[plan];

            renderModuleOptions();

            const price = billing === 'Annual' ? Math.round(data.annual / 12) : data.monthly;
            const total = billing === 'Annual' ? data.annual : data.monthly;

            document.getElementById('summaryPlanBadge').textContent = plan + ' Plan';
            document.getElementById('summaryPrice').innerHTML = `₱${price.toLocaleString()}<span class="per">/${billing === 'Annual' ? 'month' : 'month'}</span>`;
            document.getElementById('summaryAnnual').textContent = billing === 'Annual'
                ? `Billed annually at ₱${data.annual.toLocaleString()}`
                : `Billed monthly`;
            document.getElementById('summaryTotal').textContent = billing === 'Annual'
                ? `₱${data.annual.toLocaleString()}`
                : `₱${data.monthly.toLocaleString()}`;

            // Features
            const featList = document.getElementById('summaryFeatures');
            featList.innerHTML = data.features.map(f =>
                `<li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>${f}</li>`
            ).join('');
        }

        function renderModuleOptions() {
            const plan = document.getElementById('planName').value;
            const allowed = plans[plan].modules;
            const existingChecked = new Set(
                Array.from(document.querySelectorAll('#moduleGrid input[type="checkbox"]:checked')).map(x => x.value)
            );

            const grid = document.getElementById('moduleGrid');
            grid.innerHTML = allowed.map(code => {
                const shouldCheck = existingChecked.size ? existingChecked.has(code) : true;
                return `
                    <label class="module-item">
                        <input type="checkbox" value="${code}" ${shouldCheck ? 'checked' : ''}>
                        <span>${moduleLabels[code] || code}</span>
                    </label>
                `;
            }).join('');
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            const input = el.previousElementSibling;
            if (input) input.classList.add('input-error');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function clearErrors() {
            document.querySelectorAll('.error-msg').forEach(el => {
                el.style.display = 'none';
                if (el.previousElementSibling) el.previousElementSibling.classList.remove('input-error');
            });
        }

        function showToast(type, title, message, showLogin) {
            const container = document.getElementById('toastContainer');
            const id = 'toast_' + Date.now();
            const iconSvg = type === 'success'
                ? '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
                : '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';

            const actions = showLogin
                ? `<div class="toast-actions">
                       <button class="toast-btn toast-btn-primary" onclick="window.location.href='/Auth/Login'">Go to Login</button>
                       <button class="toast-btn toast-btn-secondary" onclick="this.closest('.toast-card').remove()">Dismiss</button>
                   </div>`
                : `<div class="toast-actions">
                       <button class="toast-btn toast-btn-secondary" onclick="this.closest('.toast-card').remove()">Dismiss</button>
                   </div>`;

            const html = `
                <div class="toast-card ${type === 'error' ? 'error' : ''}" id="${id}">
                    <div class="toast-icon ${type}">${iconSvg}</div>
                    <div class="toast-body">
                        <div class="toast-title">${title}</div>
                        <div class="toast-msg">${message}</div>
                        ${actions}
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>`;

            container.insertAdjacentHTML('beforeend', html);

            // Auto-remove after 15s for non-success toasts
            if (type !== 'success') {
                setTimeout(() => { document.getElementById(id)?.remove(); }, 15000);
            }
        }

        async function submitSubscription() {
            clearErrors();
            let valid = true;

            // Validate
            const companyName = document.getElementById('companyName').value.trim();
            const companyEmail = document.getElementById('companyEmail').value.trim();
            const companyPhone = document.getElementById('companyPhone').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const adminEmail = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const selectedModuleCodes = Array.from(document.querySelectorAll('#moduleGrid input[type="checkbox"]:checked')).map(cb => cb.value);

            if (!companyName) { showError('companyNameError', 'Company name is required'); valid = false; }
            if (!companyEmail || !companyEmail.includes('@@')) { showError('companyEmailError', 'Valid email is required'); valid = false; }
            if (!companyPhone) { showError('companyPhoneError', 'Phone number is required'); valid = false; }
            if (!firstName) { showError('firstNameError', 'First name is required'); valid = false; }
            if (!lastName) { showError('lastNameError', 'Last name is required'); valid = false; }
            if (!adminEmail || !adminEmail.includes('@@')) { showError('adminEmailError', 'Valid email is required'); valid = false; }
            if (password.length < 8) { showError('passwordError', 'Password must be at least 8 characters'); valid = false; }
            if (password !== confirmPassword) { showError('confirmPasswordError', 'Passwords do not match'); valid = false; }
            if (!selectedModuleCodes.length) { showError('modulesError', 'Please select at least one module'); valid = false; }
            if (!agreeTerms) { showToast('error', 'Terms Required', 'Please agree to the Terms of Service before continuing.'); return; }

            if (!valid) return;

            // Disable button, show spinner
            const btn = document.getElementById('btnSubscribe');
            const btnText = btn.querySelector('.btn-text');
            const spinner = document.getElementById('btnSpinner');
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/erpwebsite/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        companyName,
                        companyEmail,
                        companyPhone,
                        companyAddress: document.getElementById('companyAddress').value.trim(),
                        companyCity: document.getElementById('companyCity').value.trim(),
                        companyCountry: document.getElementById('companyCountry').value.trim(),
                        firstName,
                        lastName,
                        adminEmail,
                        adminPhone: document.getElementById('adminPhone').value.trim(),
                        password,
                        planName: document.getElementById('planName').value,
                        billingCycle: document.getElementById('billingCycle').value,
                        selectedModuleCodes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success',
                        'Account Created Successfully!',
                        `Welcome, ${result.companyName}! Your ${result.planName} subscription is active. Login with <strong>${result.adminEmail}</strong> to access your admin dashboard.`,
                        true);
                    // Reset form
                    document.getElementById('subscribeForm').reset();
                    updateSummary();
                } else {
                    showToast('error', 'Subscription Failed', result.message || 'An error occurred. Please try again.');
                }
            } catch (err) {
                console.error(err);
                showToast('error', 'Network Error', 'Could not reach the server. Please check your connection and try again.');
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }
    </script>
}
