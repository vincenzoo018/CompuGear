@{
    ViewData["Title"] = "Marketing Analytics";
}

<div class="page-header">
    <h1 class="page-title">Marketing Analytics</h1>
    <p class="page-subtitle">Track campaign performance and ROI</p>
</div>

<div class="stat-cards">
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Total Budget</span>
            <span class="stat-value" id="totalBudget">₱0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Active Campaigns</span>
            <span class="stat-value" id="activeCampaigns">0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Active Promotions</span>
            <span class="stat-value" id="activePromotions">0</span>
        </div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-info">
            <span class="stat-label">Avg Discount</span>
            <span class="stat-value" id="avgDiscount">0%</span>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Campaign Status</h3>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 250px;">
                <canvas id="channelChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">Budget by Campaign</h3>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 250px;">
                <canvas id="roiChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let channelChart = null, roiChart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadMarketingAnalytics();
        });

        async function loadMarketingAnalytics() {
            try {
                const [campaigns, promotions] = await Promise.all([
                    API.get('/campaigns'),
                    API.get('/promotions')
                ]);

                // Calculate stats
                const totalBudget = campaigns.reduce((sum, c) => sum + (c.budget || 0), 0);
                const activeCampaigns = campaigns.filter(c => c.status === 'Active').length;
                const activePromotions = promotions.filter(p => p.isActive).length;
                const discounts = promotions.filter(p => p.discountPercentage).map(p => p.discountPercentage);
                const avgDiscount = discounts.length > 0 ? (discounts.reduce((a, b) => a + b, 0) / discounts.length).toFixed(0) : 0;

                // Update stats
                document.getElementById('totalBudget').textContent = Format.currency(totalBudget);
                document.getElementById('activeCampaigns').textContent = activeCampaigns;
                document.getElementById('activePromotions').textContent = activePromotions;
                document.getElementById('avgDiscount').textContent = avgDiscount + '%';

                // Status distribution chart
                const statusCounts = { 'Draft': 0, 'Active': 0, 'Paused': 0, 'Completed': 0 };
                campaigns.forEach(c => {
                    if (statusCounts.hasOwnProperty(c.status)) statusCounts[c.status]++;
                });

                const channelCtx = document.getElementById('channelChart').getContext('2d');
                if (channelChart) channelChart.destroy();
                channelChart = new Chart(channelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#6B7280', '#10B981', '#F59E0B', '#008080'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                // Budget chart
                const budgetData = campaigns.slice(0, 5).map(c => ({ name: c.name, budget: c.budget || 0 }));
                const roiCtx = document.getElementById('roiChart').getContext('2d');
                if (roiChart) roiChart.destroy();
                roiChart = new Chart(roiCtx, {
                    type: 'bar',
                    data: {
                        labels: budgetData.map(c => c.name.substring(0, 15) + (c.name.length > 15 ? '...' : '')),
                        datasets: [{
                            label: 'Budget',
                            data: budgetData.map(c => c.budget),
                            backgroundColor: '#008080',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { callback: value => '₱' + (value / 1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load marketing analytics:', error);
                Toast.error('Failed to load marketing analytics');
            }
        }
    </script>
}
