@{
    ViewData["Title"] = "Ticket Details";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    :root {
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --background: #FFFFFF;
        --foreground: #111827;
        --muted: #F9FAFB;
        --muted-foreground: #6B7280;
        --border: #E5E7EB;
        --primary: #008080;
        --primary-hover: #006666;
        --radius: 12px;
        --radius-sm: 8px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    }

    .ticket-page {
        padding: 30px 0;
        background: var(--background);
        min-height: 100vh;
        font-family: var(--font-family);
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--primary);
        text-decoration: none;
        margin-bottom: 20px;
        font-weight: 500;
        font-family: var(--font-family);
        font-size: 0.9rem;
    }

    .back-link:hover { color: var(--primary-hover); }

    .ticket-header {
        background: var(--background);
        color: var(--foreground);
        border-radius: var(--radius);
        padding: 24px 28px;
        margin-bottom: 25px;
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .ticket-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: var(--foreground);
        font-family: var(--font-family);
    }

    .ticket-number {
        color: var(--muted-foreground);
        font-size: 0.9rem;
    }

    .status-badge {
        padding: 6px 14px;
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        font-family: var(--font-family);
    }

    .status-badge.Open { background: #dbeafe; color: #1d4ed8; }
    .status-badge.InProgress { background: #fef3cd; color: #856404; }
    .status-badge.Resolved { background: #d4edda; color: #155724; }
    .status-badge.Closed { background: #e5e7eb; color: #6b7280; }

    .ticket-content {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 25px;
    }

    @@media (max-width: 992px) {
        .ticket-content { grid-template-columns: 1fr; }
    }

    .portal-card {
        background: var(--background);
        border-radius: var(--radius);
        padding: 24px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        margin-bottom: 20px;
        transition: border-color 0.2s;
    }

    .portal-card:hover {
        border-color: rgba(0,128,128,0.2);
    }

    .card-title {
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: var(--font-family);
    }

    .conversation-container {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
    }

    .message.customer { flex-direction: row-reverse; }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.1rem;
    }

    .message.customer .message-avatar { background: rgba(0,128,128,0.1); }
    .message.support .message-avatar { background: var(--muted); }

    .message-content {
        max-width: 75%;
        padding: 16px;
        border-radius: var(--radius);
        line-height: 1.6;
    }

    .message.customer .message-content {
        background: rgba(0,128,128,0.04);
        border-bottom-right-radius: 4px;
    }

    .message.support .message-content {
        background: var(--muted);
        border-bottom-left-radius: 4px;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.85rem;
    }

    .message-sender { font-weight: 600; color: var(--foreground); }
    .message-time { color: var(--muted-foreground); }
    .message-text { color: #4b5563; }

    .reply-form {
        padding-top: 20px;
        border-top: 1px solid var(--border);
        margin-top: 20px;
    }

    .reply-input {
        width: 100%;
        min-height: 100px;
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        resize: vertical;
        font-size: 0.95rem;
        font-family: var(--font-family);
        margin-bottom: 15px;
        transition: border-color 0.2s, box-shadow 0.2s;
        color: var(--foreground);
        background: var(--background);
    }

    .reply-input::placeholder {
        color: var(--muted-foreground);
    }

    .reply-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0,128,128,0.08);
    }

    .reply-btn {
        padding: 10px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-family: var(--font-family);
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }

    .reply-btn:hover { background: var(--primary-hover); }
    .reply-btn:disabled { background: #9ca3af; cursor: not-allowed; }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #F3F4F6;
    }

    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--muted-foreground); font-size: 0.9rem; }
    .info-value { font-weight: 600; color: var(--foreground); }

    .original-description {
        background: var(--muted);
        padding: 20px;
        border-radius: var(--radius-sm);
        border-left: 4px solid var(--primary);
        color: #4b5563;
        line-height: 1.7;
    }

    .loading-state {
        text-align: center;
        padding: 40px;
        color: var(--muted-foreground);
    }
</style>

<div class="ticket-page">
    <div class="container">
        <a href="/CustomerPortal/MyTickets" class="back-link">‚Üê Back to My Tickets</a>

        <div id="ticketContent">
            <div class="loading-state">
                <div style="font-size: 3rem; margin-bottom: 15px;">‚è≥</div>
                <h3>Loading ticket details...</h3>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let ticketId = null;
    let ticketData = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Get ticket ID from URL
        const pathParts = window.location.pathname.split('/');
        ticketId = pathParts[pathParts.length - 1];

        // Also check query string
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('id')) {
            ticketId = urlParams.get('id');
        }

        if (ticketId) {
            loadTicketDetails();
        } else {
            document.getElementById('ticketContent').innerHTML = '<div class="loading-state"><h3>Ticket not found</h3></div>';
        }
    });

    async function loadTicketDetails() {
        try {
            const response = await fetch(`/CustomerPortal/GetTicketDetails?id=${ticketId}`);
            const result = await response.json();

            if (result.success) {
                ticketData = result.data;
                renderTicket(result.data, result.messages || []);
            } else {
                document.getElementById('ticketContent').innerHTML = `
                    <div class="loading-state">
                        <div style="font-size: 3rem; margin-bottom: 15px;">‚ùå</div>
                        <h3>${result.message || 'Ticket not found'}</h3>
                        <a href="/CustomerPortal/MyTickets" style="color: #008080;">Go back to tickets</a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('ticketContent').innerHTML = '<div class="loading-state"><h3>Error loading ticket</h3></div>';
        }
    }

    function renderTicket(ticket, messages) {
        const priorityIcons = { 'High': 'üî¥', 'Medium': 'üü°', 'Low': 'üü¢' };
        const statusClass = (ticket.status || 'Open').replace(' ', '');

        document.getElementById('ticketContent').innerHTML = `
            <div class="ticket-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                    <div>
                        <h1>${ticket.subject}</h1>
                        <div class="ticket-number">üìã ${ticket.ticketNumber}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${ticket.status}</span>
                </div>
            </div>

            <div class="ticket-content">
                <div>
                    <!-- Original Description -->
                    <div class="portal-card">
                        <h3 class="card-title">üìù Original Request</h3>
                        <div class="original-description">${ticket.description || 'No description provided'}</div>
                    </div>

                    <!-- Conversation -->
                    <div class="portal-card">
                        <h3 class="card-title">üí¨ Conversation</h3>
                        <div class="conversation-container" id="conversationContainer">
                            ${messages.length > 0 ? messages.map(msg => `
                                <div class="message ${msg.senderType === 'Customer' ? 'customer' : 'support'}">
                                    <div class="message-avatar">${msg.senderType === 'Customer' ? 'üë§' : 'üë®‚Äçüíº'}</div>
                                    <div class="message-content">
                                        <div class="message-header">
                                            <span class="message-sender">${msg.senderName || msg.senderType}</span>
                                            <span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span>
                                        </div>
                                        <div class="message-text">${msg.message}</div>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center py-4 text-muted">No messages yet. Start the conversation below.</div>'}
                        </div>

                        ${ticket.status !== 'Closed' && ticket.status !== 'Resolved' ? `
                            <div class="reply-form">
                                <textarea class="reply-input" id="replyMessage" placeholder="Type your reply..."></textarea>
                                <button class="reply-btn" onclick="sendReply()">üì§ Send Reply</button>
                            </div>
                        ` : '<div class="text-center py-3 text-muted">This ticket is closed.</div>'}
                    </div>
                </div>

                <div>
                    <!-- Ticket Info -->
                    <div class="portal-card">
                        <h3 class="card-title">üìã Ticket Information</h3>
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="status-badge ${statusClass}" style="font-size: 0.75rem; padding: 4px 12px;">${ticket.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Priority</span>
                            <span class="info-value">${priorityIcons[ticket.priority] || 'üü°'} ${ticket.priority}</span>
                        </div>
                        ${ticket.categoryName ? `
                            <div class="info-row">
                                <span class="info-label">Category</span>
                                <span class="info-value">${ticket.categoryName}</span>
                            </div>
                        ` : ''}
                        ${ticket.agentName ? `
                            <div class="info-row">
                                <span class="info-label">Assigned To</span>
                                <span class="info-value">üë§ ${ticket.agentName}</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Created</span>
                            <span class="info-value">${new Date(ticket.createdAt).toLocaleDateString()}</span>
                        </div>
                        ${ticket.resolvedAt ? `
                            <div class="info-row">
                                <span class="info-label">Resolved</span>
                                <span class="info-value">${new Date(ticket.resolvedAt).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Contact Info -->
                    <div class="portal-card">
                        <h3 class="card-title">üìû Contact Details</h3>
                        ${ticket.contactName ? `
                            <div class="info-row">
                                <span class="info-label">Name</span>
                                <span class="info-value">${ticket.contactName}</span>
                            </div>
                        ` : ''}
                        ${ticket.contactEmail ? `
                            <div class="info-row">
                                <span class="info-label">Email</span>
                                <span class="info-value">${ticket.contactEmail}</span>
                            </div>
                        ` : ''}
                        ${ticket.contactPhone ? `
                            <div class="info-row">
                                <span class="info-label">Phone</span>
                                <span class="info-value">${ticket.contactPhone}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${ticket.resolution ? `
                        <div class="portal-card" style="background: #f0fdf4; border: 2px solid #10b981;">
                            <h3 class="card-title" style="color: #059669;">‚úÖ Resolution</h3>
                            <p style="color: #065f46; margin: 0;">${ticket.resolution}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    async function sendReply() {
        const message = document.getElementById('replyMessage').value.trim();

        if (!message) {
            alert('Please enter a message');
            return;
        }

        const btn = document.querySelector('.reply-btn');
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            const response = await fetch('/CustomerPortal/ReplyToTicket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ticketId: parseInt(ticketId),
                    message: message
                })
            });

            const result = await response.json();

            if (result.success) {
                // Reload ticket to show new message
                loadTicketDetails();
            } else {
                alert(result.message || 'Failed to send reply');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üì§ Send Reply';
        }
    }
</script>
}
