@{
    ViewData["Title"] = "Support Center";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .support-page { min-height: 100vh; }

    /* Page Header */
    .page-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--foreground);
        margin-bottom: 8px;
    }

    .page-subtitle { color: var(--muted-foreground); }

    /* Two Column Layout */
    .support-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
    }

    /* Chatbot Section */
    .chat-section {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        height: 650px;
        overflow: hidden;
        position: relative;
    }

    .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--primary);
        color: white;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chat-info h3 { font-size: 1.1rem; font-weight: 600; margin: 0; }
    .chat-info span { font-size: 0.8rem; opacity: 0.9; display: flex; align-items: center; gap: 6px; }
    .online-dot { width: 8px; height: 8px; background: #10B981; border-radius: 50%; animation: pulse 2s infinite; }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .btn-request-agent {
        padding: 8px 16px;
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: var(--radius-sm);
        color: white;
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-request-agent:hover { background: rgba(255,255,255,0.3); }
    .btn-request-agent:disabled { opacity: 0.6; cursor: not-allowed; }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .message {
        display: flex;
        gap: 10px;
        max-width: 85%;
    }

    .message.bot { align-self: flex-start; }
    .message.user { align-self: flex-end; flex-direction: row-reverse; }
    .message.agent { align-self: flex-start; }
    .message.system {
        align-self: center;
        max-width: 90%;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .message.bot .message-avatar { background: var(--primary); color: white; }
    .message.user .message-avatar { background: var(--muted); }
    .message.agent .message-avatar { background: #10B981; color: white; }

    .message-bubble {
        padding: 12px 16px;
        border-radius: 16px;
        line-height: 1.5;
    }

    .message.bot .message-bubble {
        background: var(--muted);
        color: var(--foreground);
        border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.agent .message-bubble {
        background: #D1FAE5;
        color: #065F46;
        border-bottom-left-radius: 4px;
    }

    .message.system .message-bubble {
        background: #FEF3C7;
        color: #92400E;
        font-size: 0.85rem;
        text-align: center;
        border-radius: 8px;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: var(--muted-foreground);
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    /* Live Agent Status Banner */
    .agent-status-banner {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9rem;
    }

    .agent-status-banner.waiting {
        background: linear-gradient(135deg, #F59E0B, #D97706);
    }

    .agent-status-banner .status-text {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-end-chat {
        padding: 6px 14px;
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        color: white;
        font-family: 'Poppins', sans-serif;
        font-size: 0.8rem;
        cursor: pointer;
    }

    .btn-end-chat:hover { background: rgba(255,255,255,0.3); }

    /* Quick Reply Buttons */
    .quick-replies {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        background: var(--background);
    }

    .quick-reply-btn {
        padding: 8px 16px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        color: var(--foreground);
        cursor: pointer;
        transition: all 0.3s;
    }

    .quick-reply-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .chat-input-container {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .chat-input::placeholder { color: #999; }
    .chat-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,128,128,0.08); }

    .chat-send-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .chat-send-btn:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,128,128,0.25); }

    /* FAQ & Channels Section */
    .faq-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .faq-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .faq-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .faq-list { display: flex; flex-direction: column; gap: 12px; }

    .faq-item {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        overflow: hidden;
    }

    .faq-question {
        padding: 18px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
        color: var(--foreground);
        transition: background 0.3s;
    }

    .faq-question:hover { background: var(--muted); }

    .faq-icon {
        font-size: 1.2rem;
        transition: transform 0.3s;
        color: var(--muted-foreground);
    }

    .faq-item.open .faq-icon { transform: rotate(180deg); }

    .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .faq-answer-content {
        padding: 0 20px 20px;
        color: var(--muted-foreground);
        line-height: 1.6;
    }

    .faq-item.open .faq-answer { max-height: 200px; }

    /* Support Channels */
    .channels-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .support-channels {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .channel-card {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
    }

    .channel-card:hover {
        border-color: rgba(0,128,128,0.2);
        box-shadow: 0 12px 32px rgba(0,0,0,0.08);
        transform: translateY(-4px);
    }

    .channel-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .channel-icon.email { background: var(--info-light); }
    .channel-icon.phone { background: var(--success-light); }
    .channel-icon.ticket { background: var(--warning-light); }
    .channel-icon.live { background: var(--error-light); }

    .channel-info h4 { font-weight: 600; color: var(--foreground); margin-bottom: 4px; }
    .channel-info p { font-size: 0.8rem; color: var(--muted-foreground); margin: 0; }

    /* Responsive */
    @@media (max-width: 992px) {
        .support-layout { grid-template-columns: 1fr; }
        .chat-section { height: 550px; }
    }

    @@media (max-width: 576px) {
        .support-channels { grid-template-columns: 1fr; }
        .chat-header { padding: 16px; flex-direction: column; gap: 12px; }
        .quick-replies { overflow-x: auto; flex-wrap: nowrap; }
        .quick-reply-btn { white-space: nowrap; }
    }
</style>

<div class="support-page">
    <!-- Page Header -->
    <div class="page-header animate-fade-in">
        <h1 class="page-title">üí¨ Customer Support</h1>
        <p class="page-subtitle">Chat with our AI assistant or connect with a live agent</p>
    </div>

    <div class="support-layout">
        <!-- Chatbot -->
        <section class="chat-section animate-fade-in" style="animation-delay: 0.1s">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="chat-avatar" id="chatAvatar">ü§ñ</div>
                    <div class="chat-info">
                        <h3 id="chatAgentName">GearBot Assistant</h3>
                        <span><span class="online-dot"></span> <span id="chatStatus">Online</span></span>
                    </div>
                </div>
                <button class="btn-request-agent" id="btnRequestAgent" onclick="requestLiveAgent()">
                    üë§ Request Live Agent
                </button>
            </div>

            <!-- Agent Status Banner (hidden by default) -->
            <div class="agent-status-banner waiting" id="agentStatusBanner" style="display: none;">
                <div class="status-text">
                    <span>‚è≥</span>
                    <span id="agentStatusText">Waiting for an agent to connect...</span>
                </div>
                <button class="btn-end-chat" onclick="endLiveChat()">Cancel</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-bubble">
                        Hi there! üëã I'm GearBot, your virtual assistant. How can I help you today?
                    </div>
                </div>
            </div>

            <div class="quick-replies" id="quickReplies">
                <button class="quick-reply-btn" onclick="sendQuickReply('Track my order')">üì¶ Track my order</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Return policy')">‚Ü©Ô∏è Return policy</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Shipping info')">üöö Shipping info</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Payment methods')">üí≥ Payment methods</button>
            </div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="chat-send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
        </section>

        <!-- FAQ & Channels -->
        <section class="faq-section animate-fade-in" style="animation-delay: 0.2s">
            <div class="faq-header">
                <h2 class="faq-title">‚ùì Frequently Asked Questions</h2>
            </div>
            <div class="faq-list" id="faqList">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        How do I track my order?
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            You can track your order by going to "My Orders" in your account dashboard. Click on any order to see its current status and tracking information.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        What is your return policy?
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            We offer a 30-day return policy for most products. Items must be unused and in their original packaging. To initiate a return, visit "My Orders" and select "Request Return".
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        What payment methods do you accept?
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            We accept major credit cards (Visa, Mastercard), GCash, Maya, bank transfers, and Cash on Delivery (COD) for orders within Metro Manila.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        How long does shipping take?
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Metro Manila: 1-3 business days. Luzon: 3-5 business days. Visayas & Mindanao: 5-7 business days. Express shipping available at checkout.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        Do products come with warranty?
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes! All products come with manufacturer warranty (1-3 years depending on product). Keep your receipt for claims.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Channels -->
            <div>
                <h2 class="channels-title">üìû Contact Us</h2>
                <div class="support-channels">
                    <a href="mailto:support@compugear.ph" class="channel-card">
                        <div class="channel-icon email">üìß</div>
                        <div class="channel-info">
                            <h4>Email Support</h4>
                            <p>support@compugear.ph</p>
                        </div>
                    </a>
                    <a href="tel:+6328001234" class="channel-card">
                        <div class="channel-icon phone">üìû</div>
                        <div class="channel-info">
                            <h4>Phone Support</h4>
                            <p>(02) 8000-1234</p>
                        </div>
                    </a>
                    <a href="/CustomerPortal/SubmitTicket" class="channel-card">
                        <div class="channel-icon ticket">üé´</div>
                        <div class="channel-info">
                            <h4>Submit a Ticket</h4>
                            <p>Get help in 24hrs</p>
                        </div>
                    </a>
                    <a href="/CustomerPortal/MyTickets" class="channel-card">
                        <div class="channel-icon live">üìã</div>
                        <div class="channel-info">
                            <h4>My Tickets</h4>
                            <p>View ticket history</p>
                        </div>
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>

@section Scripts {
<script>
    // Chat state
    let chatMode = 'bot'; // 'bot' or 'agent'
    let sessionId = null;
    let pollingInterval = null;
    let lastMessageId = 0;

    // Bot responses for different topics
    const botResponses = {
        'track': "To track your order, go to **My Orders** in your dashboard. You can see the current status and estimated delivery date there. Would you like me to show you how? üì¶",
        'return': "We have a **30-day return policy** for most products! Items must be unused and in original packaging. Just go to My Orders, select your order, and click 'Request Return'. Need help with a specific return? üîÑ",
        'shipping': "**Shipping times:**\n‚Ä¢ Metro Manila: 1-3 days\n‚Ä¢ Luzon: 3-5 days\n‚Ä¢ Visayas/Mindanao: 5-7 days\n\nFree shipping on orders over ‚Ç±2,000! üöö",
        'payment': "We accept:\n‚Ä¢ Credit/Debit Cards (Visa, Mastercard)\n‚Ä¢ GCash & Maya\n‚Ä¢ Bank Transfer\n‚Ä¢ Cash on Delivery (Metro Manila)\n\nAll transactions are securely encrypted! üí≥",
        'warranty': "All our products come with manufacturer warranty (1-3 years depending on the product). Keep your receipt for claims. Need to file a warranty claim? üõ°Ô∏è",
        'agent': "I understand you'd like to speak with a live agent. Click the **'Request Live Agent'** button above to connect with our support team. They're available Mon-Sat, 9AM-6PM. üë§",
        'default': "I'm here to help! You can ask me about:\n‚Ä¢ Order tracking üì¶\n‚Ä¢ Returns & refunds ‚Ü©Ô∏è\n‚Ä¢ Shipping information üöö\n‚Ä¢ Payment options üí≥\n\nOr click **'Request Live Agent'** to chat with our support team! üòä"
    };

    function handleKeyPress(event) {
        if (event.key === 'Enter') sendMessage();
    }

    function sendQuickReply(text) {
        document.getElementById('chatInput').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';

        if (chatMode === 'bot') {
            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const response = getBotResponse(message);
                addMessage(response, 'bot');
            }, 1200);
        } else if (chatMode === 'waiting' && sessionId) {
            // Customer is waiting for agent to accept - show warning
            addMessage('‚è≥ Please wait for a support agent to accept your chat request before sending messages.', 'system');
        } else if (chatMode === 'agent' && sessionId) {
            // Send to live agent (only when agent has accepted)
            try {
                const response = await fetch('/api/CustomerSendChatMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId, message: message })
                });
                const result = await response.json();
                if (!result.success && result.waitingForAgent) {
                    addMessage('‚è≥ Please wait for an agent to accept the chat.', 'system');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
    }

    function addMessage(text, type) {
        const container = document.getElementById('chatMessages');
        const avatars = { bot: 'ü§ñ', user: 'üë§', agent: 'üë®‚Äçüíº', system: '‚ö°' };

        const messageHtml = `
            <div class="message ${type}">
                ${type !== 'system' ? `<div class="message-avatar">${avatars[type]}</div>` : ''}
                <div class="message-bubble">${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>
            </div>`;

        container.insertAdjacentHTML('beforeend', messageHtml);
        container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        container.insertAdjacentHTML('beforeend', `
            <div class="message bot" id="typingIndicator">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>`);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    function getBotResponse(message) {
        const lower = message.toLowerCase();

        if (lower.includes('track') || lower.includes('order') || lower.includes('where')) {
            return botResponses.track;
        } else if (lower.includes('return') || lower.includes('refund') || lower.includes('exchange')) {
            return botResponses.return;
        } else if (lower.includes('ship') || lower.includes('delivery') || lower.includes('deliver')) {
            return botResponses.shipping;
        } else if (lower.includes('pay') || lower.includes('gcash') || lower.includes('card') || lower.includes('cod')) {
            return botResponses.payment;
        } else if (lower.includes('warranty') || lower.includes('guarantee')) {
            return botResponses.warranty;
        } else if (lower.includes('agent') || lower.includes('human') || lower.includes('person') || lower.includes('staff')) {
            return botResponses.agent;
        } else if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
            return "Hello! üëã Great to see you! How can I assist you today?";
        } else if (lower.includes('thank')) {
            return "You're welcome! üòä Is there anything else I can help you with?";
        } else {
            return botResponses.default;
        }
    }

    function toggleFaq(element) {
        const item = element.closest('.faq-item');
        const wasOpen = item.classList.contains('open');
        document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('open'));
        if (!wasOpen) item.classList.add('open');
    }

    // Live Agent Functions
    async function requestLiveAgent() {
        const btn = document.getElementById('btnRequestAgent');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Requesting...';

        try {
            const response = await fetch('/api/RequestLiveAgent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const result = await response.json();

            if (result.success) {
                sessionId = result.sessionId;
                chatMode = 'waiting';

                // Show waiting banner
                document.getElementById('agentStatusBanner').style.display = 'flex';
                document.getElementById('agentStatusText').textContent = 'Waiting for a support agent to accept your request...';

                // Hide quick replies
                document.getElementById('quickReplies').style.display = 'none';

                // Disable chat input while waiting for agent approval
                document.getElementById('chatInput').placeholder = 'Waiting for agent approval...';
                document.getElementById('chatInput').disabled = true;

                // Add system message
                addMessage('üîî You have requested to speak with a live agent. Please wait while a support agent accepts your request. You will be able to chat once an agent is available.', 'system');

                btn.style.display = 'none';

                // Start polling for agent connection
                startPolling();
            } else {
                alert(result.message || 'Failed to request live agent');
                btn.disabled = false;
                btn.innerHTML = 'üë§ Request Live Agent';
            }
        } catch (error) {
            console.error('Error requesting live agent:', error);
            btn.disabled = false;
            btn.innerHTML = 'üë§ Request Live Agent';
        }
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            if (!sessionId) return;

            try {
                const response = await fetch(`/api/GetCustomerChatUpdates?sessionId=${sessionId}&lastMessageId=${lastMessageId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Check if agent connected (agent has accepted the chat)
                    if (result.data.status === 'Active' && result.data.agentName && chatMode !== 'agent') {
                        chatMode = 'agent';

                        // Update UI for agent chat
                        document.getElementById('chatAvatar').textContent = 'üë®‚Äçüíº';
                        document.getElementById('chatAgentName').textContent = result.data.agentName;
                        document.getElementById('chatStatus').textContent = 'Live Chat';

                        // Enable chat input now that agent accepted
                        document.getElementById('chatInput').placeholder = 'Type your message...';
                        document.getElementById('chatInput').disabled = false;

                        const banner = document.getElementById('agentStatusBanner');
                        banner.classList.remove('waiting');
                        document.getElementById('agentStatusText').textContent = `‚úÖ Connected with ${result.data.agentName}`;

                        // Add connected message
                        addMessage(`üéâ ${result.data.agentName} has accepted your chat request. You can now start chatting!`, 'system');
                    }

                    // Add new messages
                    if (result.data.messages && result.data.messages.length > 0) {
                        result.data.messages.forEach(msg => {
                            if (msg.messageId > lastMessageId) {
                                lastMessageId = msg.messageId;
                                if (msg.senderType === 'Agent') {
                                    addMessage(msg.message, 'agent');
                                } else if (msg.senderType === 'System') {
                                    addMessage(msg.message, 'system');
                                }
                            }
                        });
                    }

                    // Check if chat ended
                    if (result.data.status === 'Ended') {
                        endLiveChatUI();
                        addMessage('This chat session has ended. Thank you for contacting us!', 'system');
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 2000);
    }

    async function endLiveChat() {
        if (sessionId) {
            try {
                await fetch('/api/CustomerEndChat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
            } catch (error) {
                console.error('Error ending chat:', error);
            }
        }
        endLiveChatUI();
    }

    function endLiveChatUI() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        chatMode = 'bot';
        sessionId = null;
        lastMessageId = 0;

        // Reset UI
        document.getElementById('chatAvatar').textContent = 'ü§ñ';
        document.getElementById('chatAgentName').textContent = 'GearBot Assistant';
        document.getElementById('chatStatus').textContent = 'Online';
        document.getElementById('agentStatusBanner').style.display = 'none';
        document.getElementById('quickReplies').style.display = 'flex';

        // Re-enable chat input
        document.getElementById('chatInput').placeholder = 'Type your message...';
        document.getElementById('chatInput').disabled = false;

        const btn = document.getElementById('btnRequestAgent');
        btn.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = 'üë§ Request Live Agent';
    }
</script>
}
