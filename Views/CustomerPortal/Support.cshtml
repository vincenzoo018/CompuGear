@{
    ViewData["Title"] = "Support Center";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .support-page {
        min-height: 100vh;
    }

    /* Page Header */
    .page-header {
        margin-bottom: 32px;
    }

    .page-header-content {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 6px;
    }

    .page-header-icon {
        width: 48px;
        height: 48px;
        background: var(--primary);
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .page-header-icon svg {
        width: 24px;
        height: 24px;
        color: white;
        stroke: white;
        fill: none;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--foreground);
        letter-spacing: -0.025em;
    }

    .page-subtitle {
        color: var(--muted-foreground);
        font-size: 0.95rem;
        margin-left: 64px;
    }

    /* Two Column Layout */
    .support-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 28px;
        align-items: start;
    }

    /* Chat Section */
    .chat-section {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        height: 650px;
        overflow: hidden;
        position: relative;
    }

    .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--card);
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .chat-info h3 {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }

    .chat-info span {
        font-size: 0.8rem;
        color: var(--muted-foreground);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .online-dot {
        width: 7px;
        height: 7px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .btn-request-agent {
        padding: 7px 14px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--foreground);
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-request-agent:hover {
        background: var(--muted);
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-request-agent:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Chat Messages */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        background: var(--muted);
    }

    .chat-messages::-webkit-scrollbar {
        width: 5px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 10px;
    }

    .message {
        display: flex;
        gap: 10px;
        max-width: 80%;
    }

    .message.bot { align-self: flex-start; }
    .message.user { align-self: flex-end; flex-direction: row-reverse; }
    .message.agent { align-self: flex-start; }
    .message.system {
        align-self: center;
        max-width: 90%;
    }

    .message-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        flex-shrink: 0;
    }

    .message.bot .message-avatar {
        background: var(--primary);
        color: white;
    }

    .message.user .message-avatar {
        background: var(--border);
    }

    .message.agent .message-avatar {
        background: var(--success);
        color: white;
    }

    .message-bubble {
        padding: 10px 14px;
        border-radius: var(--radius);
        line-height: 1.55;
        font-size: 0.9rem;
    }

    .message.bot .message-bubble {
        background: var(--card);
        color: var(--foreground);
        border: 1px solid var(--border);
        border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.agent .message-bubble {
        background: var(--success-light);
        color: var(--success-fg);
        border: 1px solid #A7F3D0;
        border-bottom-left-radius: 4px;
    }

    .message.system .message-bubble {
        background: var(--warning-light);
        color: var(--warning-fg);
        font-size: 0.8rem;
        text-align: center;
        border-radius: var(--radius-sm);
        border: 1px solid #FDE68A;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

    .typing-indicator span {
        width: 7px;
        height: 7px;
        background: var(--muted-foreground);
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    /* Agent Status Banner */
    .agent-status-banner {
        background: var(--success);
        color: white;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85rem;
    }

    .agent-status-banner.waiting {
        background: var(--warning);
    }

    .agent-status-banner .status-text {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-end-chat {
        padding: 5px 12px;
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: var(--radius-sm);
        color: white;
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-end-chat:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Quick Replies */
    .quick-replies {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 14px 20px;
        border-top: 1px solid var(--border);
        background: var(--card);
    }

    .quick-reply-btn {
        padding: 7px 16px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--foreground);
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-reply-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Chat Input */
    .chat-input-container {
        padding: 14px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 10px;
        background: var(--card);
    }

    .chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        outline: none;
        background: var(--muted);
        color: var(--foreground);
        transition: border-color 0.2s;
    }

    .chat-input::placeholder {
        color: var(--muted-foreground);
    }

    .chat-input:focus {
        border-color: var(--primary);
        background: var(--card);
    }

    .chat-send-btn {
        width: 42px;
        height: 42px;
        border-radius: var(--radius-sm);
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    .chat-send-btn:hover {
        background: var(--primary-hover);
    }

    /* Right Column: FAQ & Channels */
    .right-column {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .faq-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-header-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .section-header-icon.faq-icon-header {
        background: var(--info-light);
    }

    .section-header-icon.faq-icon-header svg {
        width: 18px;
        height: 18px;
        stroke: var(--info);
        fill: none;
    }

    .section-header-icon.channels-icon-header {
        background: var(--success-light);
    }

    .section-header-icon.channels-icon-header svg {
        width: 18px;
        height: 18px;
        stroke: var(--success);
        fill: none;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--foreground);
    }

    .faq-list {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .faq-item {
        background: var(--card);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .faq-item:first-child {
        border-radius: var(--radius) var(--radius) 0 0;
    }

    .faq-item:last-child {
        border-radius: 0 0 var(--radius) var(--radius);
    }

    .faq-item:not(:last-child) {
        border-bottom: none;
    }

    .faq-question {
        padding: 14px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--foreground);
        transition: background 0.2s;
    }

    .faq-question:hover {
        background: var(--muted);
    }

    .faq-icon {
        font-size: 0.75rem;
        transition: transform 0.2s;
        color: var(--muted-foreground);
    }

    .faq-item.open .faq-icon {
        transform: rotate(180deg);
    }

    .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .faq-answer-content {
        padding: 0 18px 16px;
        color: var(--muted-foreground);
        line-height: 1.6;
        font-size: 0.875rem;
    }

    .faq-item.open .faq-answer {
        max-height: 200px;
    }

    /* Support Channels */
    .channels-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .support-channels {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .channel-card {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: border-color 0.2s;
        text-decoration: none;
    }

    .channel-card:hover {
        border-color: var(--primary);
    }

    .channel-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .channel-icon.email { background: var(--info-light); }
    .channel-icon.phone { background: var(--success-light); }
    .channel-icon.ticket { background: var(--warning-light); }
    .channel-icon.live { background: var(--error-light); }

    .channel-info h4 {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--foreground);
        margin-bottom: 2px;
    }

    .channel-info p {
        font-size: 0.75rem;
        color: var(--muted-foreground);
        margin: 0;
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .support-layout {
            grid-template-columns: 1fr;
        }

        .chat-section {
            height: 550px;
        }
    }

    @@media (max-width: 576px) {
        .support-channels {
            grid-template-columns: 1fr;
        }

        .chat-header {
            padding: 14px 16px;
            flex-direction: column;
            gap: 10px;
        }

        .page-subtitle {
            margin-left: 0;
        }

        .quick-replies {
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .quick-reply-btn {
            white-space: nowrap;
        }
    }
</style>

<div class="support-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-icon">
                <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <h1 class="page-title">Customer Support</h1>
        </div>
        <p class="page-subtitle">Chat with our AI assistant or connect with a live agent</p>
    </div>

    <div class="support-layout">
        <!-- Chat Section -->
        <section class="chat-section">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="chat-avatar" id="chatAvatar">ü§ñ</div>
                    <div class="chat-info">
                        <h3 id="chatAgentName">GearBot Assistant</h3>
                        <span><span class="online-dot"></span> <span id="chatStatus">Online</span></span>
                    </div>
                </div>
                <button class="btn-request-agent" id="btnRequestAgent" onclick="requestLiveAgent()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Live Agent
                </button>
            </div>

            <!-- Agent Status Banner (hidden by default) -->
            <div class="agent-status-banner waiting" id="agentStatusBanner" style="display: none;">
                <div class="status-text">
                    <span>‚è≥</span>
                    <span id="agentStatusText">Waiting for an agent to connect...</span>
                </div>
                <button class="btn-end-chat" onclick="endLiveChat()">Cancel</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-bubble">
                        Hi there! üëã I'm GearBot, your virtual assistant. How can I help you today?
                    </div>
                </div>
            </div>

            <div class="quick-replies" id="quickReplies">
                <button class="quick-reply-btn" onclick="sendQuickReply('Track my order')">üì¶ Track my order</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Return policy')">‚Ü©Ô∏è Return policy</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Shipping info')">üöö Shipping info</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Payment methods')">üí≥ Payment methods</button>
            </div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="chat-send-btn" onclick="sendMessage()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
        </section>

        <!-- FAQ & Channels -->
        <div class="right-column">
            <section class="faq-section">
                <div class="section-header">
                    <div class="section-header-icon faq-icon-header">
                        <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <h2 class="section-title">Frequently Asked Questions</h2>
                </div>
                <div class="faq-list" id="faqList">
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            How do I track my order?
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                You can track your order by going to "My Orders" in your account dashboard. Click on any order to see its current status and tracking information.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            What is your return policy?
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                We offer a 30-day return policy for most products. Items must be unused and in their original packaging. To initiate a return, visit "My Orders" and select "Request Return".
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            What payment methods do you accept?
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                We accept major credit cards (Visa, Mastercard), GCash, Maya, bank transfers, and Cash on Delivery (COD) for orders within Metro Manila.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            How long does shipping take?
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Metro Manila: 1-3 business days. Luzon: 3-5 business days. Visayas & Mindanao: 5-7 business days. Express shipping available at checkout.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            Do products come with warranty?
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Yes! All products come with manufacturer warranty (1-3 years depending on product). Keep your receipt for claims.
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Support Channels -->
            <section class="channels-section">
                <div class="section-header">
                    <div class="section-header-icon channels-icon-header">
                        <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                    </div>
                    <h2 class="section-title">Contact Us</h2>
                </div>
                <div class="support-channels">
                    <a href="mailto:support@compugear.ph" class="channel-card">
                        <div class="channel-icon email">üìß</div>
                        <div class="channel-info">
                            <h4>Email Support</h4>
                            <p>support&#64;compugear.ph</p>
                        </div>
                    </a>
                    <a href="tel:+6328001234" class="channel-card">
                        <div class="channel-icon phone">üìû</div>
                        <div class="channel-info">
                            <h4>Phone Support</h4>
                            <p>(02) 8000-1234</p>
                        </div>
                    </a>
                    <a href="/CustomerPortal/SubmitTicket" class="channel-card">
                        <div class="channel-icon ticket">üé´</div>
                        <div class="channel-info">
                            <h4>Submit a Ticket</h4>
                            <p>Get help in 24hrs</p>
                        </div>
                    </a>
                    <a href="/CustomerPortal/MyTickets" class="channel-card">
                        <div class="channel-icon live">üìã</div>
                        <div class="channel-info">
                            <h4>My Tickets</h4>
                            <p>View ticket history</p>
                        </div>
                    </a>
                </div>
            </section>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Chat state
    let chatMode = 'bot'; // 'bot' or 'agent'
    let sessionId = null;
    let pollingInterval = null;
    let lastMessageId = 0;

    // Bot responses for different topics
    const botResponses = {
        'track': "To track your order, go to **My Orders** in your dashboard. You can see the current status and estimated delivery date there. Would you like me to show you how? üì¶",
        'return': "We have a **30-day return policy** for most products! Items must be unused and in original packaging. Just go to My Orders, select your order, and click 'Request Return'. Need help with a specific return? üîÑ",
        'shipping': "**Shipping times:**\n‚Ä¢ Metro Manila: 1-3 days\n‚Ä¢ Luzon: 3-5 days\n‚Ä¢ Visayas/Mindanao: 5-7 days\n\nFree shipping on orders over ‚Ç±2,000! üöö",
        'payment': "We accept:\n‚Ä¢ Credit/Debit Cards (Visa, Mastercard)\n‚Ä¢ GCash & Maya\n‚Ä¢ Bank Transfer\n‚Ä¢ Cash on Delivery (Metro Manila)\n\nAll transactions are securely encrypted! üí≥",
        'warranty': "All our products come with manufacturer warranty (1-3 years depending on the product). Keep your receipt for claims. Need to file a warranty claim? üõ°Ô∏è",
        'agent': "I understand you'd like to speak with a live agent. Click the **'Request Live Agent'** button above to connect with our support team. They're available Mon-Sat, 9AM-6PM. üë§",
        'default': "I'm here to help! You can ask me about:\n‚Ä¢ Order tracking üì¶\n‚Ä¢ Returns & refunds ‚Ü©Ô∏è\n‚Ä¢ Shipping information üöö\n‚Ä¢ Payment options üí≥\n\nOr click **'Request Live Agent'** to chat with our support team! üòä"
    };

    function handleKeyPress(event) {
        if (event.key === 'Enter') sendMessage();
    }

    function sendQuickReply(text) {
        document.getElementById('chatInput').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';

        if (chatMode === 'bot') {
            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const response = getBotResponse(message);
                addMessage(response, 'bot');
            }, 1200);
        } else if (chatMode === 'waiting' && sessionId) {
            // Customer is waiting for agent to accept - show warning
            addMessage('‚è≥ Please wait for a support agent to accept your chat request before sending messages.', 'system');
        } else if (chatMode === 'agent' && sessionId) {
            // Send to live agent (only when agent has accepted)
            try {
                const response = await fetch('/api/CustomerSendChatMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId, message: message })
                });
                const result = await response.json();
                if (!result.success && result.waitingForAgent) {
                    addMessage('‚è≥ Please wait for an agent to accept the chat.', 'system');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
    }

    function addMessage(text, type) {
        const container = document.getElementById('chatMessages');
        const avatars = { bot: 'ü§ñ', user: 'üë§', agent: 'üë®‚Äçüíº', system: '‚ö°' };

        const messageHtml = `
            <div class="message ${type}">
                ${type !== 'system' ? `<div class="message-avatar">${avatars[type]}</div>` : ''}
                <div class="message-bubble">${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>
            </div>`;

        container.insertAdjacentHTML('beforeend', messageHtml);
        container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        container.insertAdjacentHTML('beforeend', `
            <div class="message bot" id="typingIndicator">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>`);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    function getBotResponse(message) {
        const lower = message.toLowerCase();

        if (lower.includes('track') || lower.includes('order') || lower.includes('where')) {
            return botResponses.track;
        } else if (lower.includes('return') || lower.includes('refund') || lower.includes('exchange')) {
            return botResponses.return;
        } else if (lower.includes('ship') || lower.includes('delivery') || lower.includes('deliver')) {
            return botResponses.shipping;
        } else if (lower.includes('pay') || lower.includes('gcash') || lower.includes('card') || lower.includes('cod')) {
            return botResponses.payment;
        } else if (lower.includes('warranty') || lower.includes('guarantee')) {
            return botResponses.warranty;
        } else if (lower.includes('agent') || lower.includes('human') || lower.includes('person') || lower.includes('staff')) {
            return botResponses.agent;
        } else if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
            return "Hello! üëã Great to see you! How can I assist you today?";
        } else if (lower.includes('thank')) {
            return "You're welcome! üòä Is there anything else I can help you with?";
        } else {
            return botResponses.default;
        }
    }

    function toggleFaq(element) {
        const item = element.closest('.faq-item');
        const wasOpen = item.classList.contains('open');
        document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('open'));
        if (!wasOpen) item.classList.add('open');
    }

    // Live Agent Functions
    async function requestLiveAgent() {
        const btn = document.getElementById('btnRequestAgent');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Requesting...';

        try {
            const response = await fetch('/api/RequestLiveAgent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const result = await response.json();

            if (result.success) {
                sessionId = result.sessionId;
                chatMode = 'waiting';

                // Show waiting banner
                document.getElementById('agentStatusBanner').style.display = 'flex';
                document.getElementById('agentStatusText').textContent = 'Waiting for a support agent to accept your request...';

                // Hide quick replies
                document.getElementById('quickReplies').style.display = 'none';

                // Disable chat input while waiting for agent approval
                document.getElementById('chatInput').placeholder = 'Waiting for agent approval...';
                document.getElementById('chatInput').disabled = true;

                // Add system message
                addMessage('üîî You have requested to speak with a live agent. Please wait while a support agent accepts your request. You will be able to chat once an agent is available.', 'system');

                btn.style.display = 'none';

                // Start polling for agent connection
                startPolling();
            } else {
                alert(result.message || 'Failed to request live agent');
                btn.disabled = false;
                btn.innerHTML = 'üë§ Request Live Agent';
            }
        } catch (error) {
            console.error('Error requesting live agent:', error);
            btn.disabled = false;
            btn.innerHTML = 'üë§ Request Live Agent';
        }
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            if (!sessionId) return;

            try {
                const response = await fetch(`/api/GetCustomerChatUpdates?sessionId=${sessionId}&lastMessageId=${lastMessageId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Check if agent connected (agent has accepted the chat)
                    if (result.data.status === 'Active' && result.data.agentName && chatMode !== 'agent') {
                        chatMode = 'agent';

                        // Update UI for agent chat
                        document.getElementById('chatAvatar').textContent = 'üë®‚Äçüíº';
                        document.getElementById('chatAgentName').textContent = result.data.agentName;
                        document.getElementById('chatStatus').textContent = 'Live Chat';

                        // Enable chat input now that agent accepted
                        document.getElementById('chatInput').placeholder = 'Type your message...';
                        document.getElementById('chatInput').disabled = false;

                        const banner = document.getElementById('agentStatusBanner');
                        banner.classList.remove('waiting');
                        banner.style.display = 'none';

                        // Add connected message
                        addMessage(`üéâ ${result.data.agentName} has accepted your chat request. You can now start chatting!`, 'system');
                    }

                    if (result.data.status === 'Active' && result.data.agentName) {
                        document.getElementById('chatAvatar').textContent = 'üë®‚Äçüíº';
                        document.getElementById('chatAgentName').textContent = result.data.agentName;
                        document.getElementById('chatStatus').textContent = 'Live Chat';
                    }

                    // Add new messages
                    if (result.data.messages && result.data.messages.length > 0) {
                        result.data.messages.forEach(msg => {
                            if (msg.messageId > lastMessageId) {
                                lastMessageId = msg.messageId;
                                if (msg.senderType === 'Agent') {
                                    addMessage(msg.message, 'agent');
                                } else if (msg.senderType === 'System') {
                                    addMessage(msg.message, 'system');
                                }
                            }
                        });
                    }

                    // Check if chat ended
                    if (result.data.status === 'Ended') {
                        endLiveChatUI();
                        addMessage('This chat session has ended. Thank you for contacting us!', 'system');
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 2000);
    }

    async function endLiveChat() {
        if (sessionId) {
            try {
                await fetch('/api/CustomerEndChat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
            } catch (error) {
                console.error('Error ending chat:', error);
            }
        }
        endLiveChatUI();
    }

    function endLiveChatUI() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        chatMode = 'bot';
        sessionId = null;
        lastMessageId = 0;

        // Reset UI
        document.getElementById('chatAvatar').textContent = 'ü§ñ';
        document.getElementById('chatAgentName').textContent = 'GearBot Assistant';
        document.getElementById('chatStatus').textContent = 'Online';
        document.getElementById('agentStatusBanner').style.display = 'none';
        document.getElementById('quickReplies').style.display = 'flex';

        // Re-enable chat input
        document.getElementById('chatInput').placeholder = 'Type your message...';
        document.getElementById('chatInput').disabled = false;

        const btn = document.getElementById('btnRequestAgent');
        btn.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = 'üë§ Request Live Agent';
    }
</script>
}
