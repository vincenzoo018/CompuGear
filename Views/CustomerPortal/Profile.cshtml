@{
    ViewData["Title"] = "My Profile";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .profile-page { min-height: 100vh; }

    /* Profile Header */
    .profile-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        border-radius: 20px;
        padding: 40px;
        color: white;
        display: flex;
        align-items: center;
        gap: 32px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
    }

    .profile-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255,255,255,0.05);
        border-radius: 50%;
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: 4px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        position: relative;
        flex-shrink: 0;
    }

    .avatar-edit {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }

    .profile-info { flex: 1; position: relative; z-index: 1; }
    .profile-name { font-size: 2rem; font-weight: 800; margin-bottom: 4px; }
    .profile-email { font-size: 1rem; opacity: 0.9; margin-bottom: 12px; }

    .profile-stats {
        display: flex;
        gap: 32px;
    }

    .profile-stat {
        text-align: left;
    }

    .profile-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .profile-stat-label {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .header-actions {
        position: relative;
        z-index: 1;
    }

    .btn-edit-profile {
        padding: 12px 24px;
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: var(--radius-sm);
        color: white;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-edit-profile:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Tabs */
    .profile-tabs {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .tabs-nav {
        display: flex;
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        gap: 8px;
        overflow-x: auto;
    }

    .tab-pill {
        padding: 16px 24px;
        background: none;
        border: none;
        color: var(--muted-foreground);
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.3s;
    }

    .tab-pill:hover { color: var(--foreground); }

    .tab-pill.active {
        color: var(--primary);
        font-weight: 600;
    }

    .tab-pill.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
    }

    .tab-content { padding: 32px; display: none; }
    .tab-content.active { display: block; }

    /* Form Styles */
    .form-section {
        margin-bottom: 32px;
    }

    .form-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
        font-weight: 500;
        color: var(--foreground);
        font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
        padding: 12px 16px;
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        background: var(--background);
        color: var(--foreground);
        transition: border-color 0.3s;
    }

    .form-input::placeholder, .form-textarea::placeholder {
        color: #999;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0,128,128,0.08);
    }

    .form-textarea { resize: vertical; min-height: 100px; }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
    }

    .btn-save {
        padding: 12px 28px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-save:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,128,128,0.25); }

    .btn-cancel {
        padding: 12px 28px;
        background: var(--muted);
        color: var(--foreground);
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel:hover { background: var(--border); }

    /* Loyalty Card */
    .loyalty-card {
        background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
        border-radius: 20px;
        padding: 32px;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .loyalty-card::before {
        content: '‚≠ê';
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 5rem;
        opacity: 0.1;
    }

    .loyalty-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
    }

    .loyalty-tier {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .tier-icon { font-size: 2.5rem; }
    .tier-name { font-size: 1.5rem; font-weight: 800; }
    .tier-label { font-size: 0.8rem; opacity: 0.8; }

    .loyalty-points {
        text-align: right;
    }

    .points-value { font-size: 2rem; font-weight: 800; }
    .points-label { font-size: 0.8rem; opacity: 0.8; }

    .loyalty-progress {
        margin-bottom: 16px;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        margin-bottom: 8px;
        opacity: 0.9;
    }

    .progress-bar {
        height: 8px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #FCD34D, #F59E0B);
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .loyalty-perks {
        display: flex;
        gap: 24px;
        padding-top: 16px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .perk-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .perk-icon { font-size: 1.2rem; }

    /* Address Cards */
    .address-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .address-card {
        background: var(--background);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 20px;
        position: relative;
    }

    .address-card.default { border-color: var(--primary); }

    .address-card.default::before {
        content: 'Default';
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--primary);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .address-type {
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .address-text {
        color: var(--muted-foreground);
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .address-actions {
        display: flex;
        gap: 12px;
    }

    .btn-address {
        padding: 8px 16px;
        background: var(--muted);
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        color: var(--foreground);
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-address:hover { background: var(--border); }

    .btn-add-address {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 40px;
        border: 2px dashed var(--border);
        border-radius: 12px;
        color: var(--muted-foreground);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-add-address:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--primary-light);
    }

    /* Security */
    .security-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        background: var(--background);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .security-info { display: flex; align-items: center; gap: 16px; }
    .security-icon { font-size: 1.5rem; }
    .security-title { font-weight: 600; color: var(--foreground); }
    .security-desc { font-size: 0.85rem; color: var(--muted-foreground); }

    .btn-security {
        padding: 10px 20px;
        background: var(--muted);
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Poppins', sans-serif;
        color: var(--foreground);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-security:hover { background: var(--primary-hover); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,128,128,0.25); }

    /* Responsive */
    @@media (max-width: 768px) {
        .profile-header {
            flex-direction: column;
            text-align: center;
            padding: 32px 24px;
        }

        .profile-stats { justify-content: center; }
        .profile-stat { text-align: center; }
        .form-grid { grid-template-columns: 1fr; }
        .tabs-nav { padding: 0 12px; }
        .tab-pill { padding: 12px 16px; font-size: 0.9rem; }
        .tab-content { padding: 24px 16px; }
        .loyalty-perks { flex-wrap: wrap; }
        .address-grid { grid-template-columns: 1fr; }
    }

    @@media (max-width: 576px) {
        .profile-avatar { width: 80px; height: 80px; font-size: 2rem; }
        .profile-name { font-size: 1.5rem; }
        .loyalty-header { flex-direction: column; gap: 16px; }
        .loyalty-points { text-align: left; }
    }
</style>

<div class="profile-page">
    <!-- Profile Header -->
    <div class="profile-header animate-fade-in">
        <div class="profile-avatar" id="profileAvatar">
            üë§
            <button class="avatar-edit" title="Change photo">üì∑</button>
        </div>
        <div class="profile-info">
            <h1 class="profile-name" id="profileName">Loading...</h1>
            <p class="profile-email" id="profileEmail">Loading...</p>
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statOrders">0</div>
                    <div class="profile-stat-label">Orders</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statSpent">‚Ç±0</div>
                    <div class="profile-stat-label">Total Spent</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statMember">-</div>
                    <div class="profile-stat-label">Member Since</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Tabs -->
    <div class="profile-tabs animate-fade-in" style="animation-delay: 0.1s">
        <div class="tabs-nav">
            <button class="tab-pill active" onclick="switchTab('personal', this)">üë§ Personal Info</button>
            <button class="tab-pill" onclick="switchTab('addresses', this)">üìç Addresses</button>
            <button class="tab-pill" onclick="switchTab('loyalty', this)">‚≠ê Loyalty & Rewards</button>
            <button class="tab-pill" onclick="switchTab('security', this)">üîí Security</button>
        </div>

        <!-- Personal Info Tab -->
        <div class="tab-content active" id="tab-personal">
            <form id="personalForm" onsubmit="savePersonalInfo(event)">
                <div class="form-section">
                    <h3 class="form-section-title">üë§ Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="firstName" placeholder="Juan">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="lastName" placeholder="Dela Cruz">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="email" placeholder="juan@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="phone" placeholder="+63 917 123 4567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-input" id="birthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select class="form-select" id="gender">
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not">Prefer not to say</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="resetPersonalForm()">Cancel</button>
                    <button type="submit" class="btn-save">üíæ Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Addresses Tab -->
        <div class="tab-content" id="tab-addresses">
            <div class="form-section">
                <h3 class="form-section-title">üìç Saved Addresses</h3>
                <div class="address-grid" id="addressGrid">
                    <!-- Addresses loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Loyalty Tab -->
        <div class="tab-content" id="tab-loyalty">
            <div class="loyalty-card">
                <div class="loyalty-header">
                    <div class="loyalty-tier">
                        <span class="tier-icon" id="tierIcon">ü•à</span>
                        <div>
                            <div class="tier-name" id="tierName">Silver Member</div>
                            <div class="tier-label">Your current tier</div>
                        </div>
                    </div>
                    <div class="loyalty-points">
                        <div class="points-value" id="pointsValue">1,250</div>
                        <div class="points-label">Available Points</div>
                    </div>
                </div>
                <div class="loyalty-progress">
                    <div class="progress-label">
                        <span id="progressText">750 points to Gold tier</span>
                        <span id="progressPercent">62%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 62%"></div>
                    </div>
                </div>
                <div class="loyalty-perks">
                    <div class="perk-item"><span class="perk-icon">üéÅ</span> 5% cashback on orders</div>
                    <div class="perk-item"><span class="perk-icon">üöö</span> Free shipping over ‚Ç±1,000</div>
                    <div class="perk-item"><span class="perk-icon">üéÇ</span> Birthday bonus points</div>
                </div>
            </div>

            <div class="form-section" style="margin-top: 32px">
                <h3 class="form-section-title">üéÅ Recent Rewards Activity</h3>
                <div id="rewardsActivity">
                    <p style="color: var(--muted-foreground);">Loading activity...</p>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div class="tab-content" id="tab-security">
            <div class="form-section">
                <h3 class="form-section-title">üîí Account Security</h3>
                <div class="security-item">
                    <div class="security-info">
                        <span class="security-icon">üîë</span>
                        <div>
                            <div class="security-title">Password</div>
                            <div class="security-desc">Last changed 30 days ago</div>
                        </div>
                    </div>
                    <button class="btn-security" onclick="changePassword()">Change Password</button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <span class="security-icon">üì±</span>
                        <div>
                            <div class="security-title">Two-Factor Authentication</div>
                            <div class="security-desc">Add an extra layer of security</div>
                        </div>
                    </div>
                    <button class="btn-security" onclick="setup2FA()">Enable 2FA</button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <span class="security-icon">üìß</span>
                        <div>
                            <div class="security-title">Email Notifications</div>
                            <div class="security-desc">Manage email preferences</div>
                        </div>
                    </div>
                    <button class="btn-security" onclick="manageEmails()">Manage</button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <span class="security-icon">üóëÔ∏è</span>
                        <div>
                            <div class="security-title">Delete Account</div>
                            <div class="security-desc">Permanently delete your account and data</div>
                        </div>
                    </div>
                    <button class="btn-security" style="background: var(--error-light); color: var(--error-fg);" onclick="deleteAccount()">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', loadProfile);

    async function loadProfile() {
        try {
            const response = await fetch('/CustomerPortal/GetProfile');
            const result = await response.json();

            if (result.success) {
                populateProfile(result.data);
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }

    function populateProfile(data) {
        // API returns flat structure: data.firstName, data.totalOrders, etc.
        const fullName = ((data.firstName || '') + ' ' + (data.lastName || '')).trim() || 'Customer';

        // Header
        document.getElementById('profileName').textContent = fullName;
        document.getElementById('profileEmail').textContent = data.email || '';
        document.getElementById('statOrders').textContent = data.totalOrders || 0;
        document.getElementById('statSpent').textContent = '‚Ç±' + (data.totalSpent || 0).toLocaleString();

        if (data.createdAt) {
            const date = new Date(data.createdAt);
            document.getElementById('statMember').textContent = date.toLocaleDateString('en-PH', { month: 'short', year: 'numeric' });
        }

        // Form fields
        document.getElementById('firstName').value = data.firstName || '';
        document.getElementById('lastName').value = data.lastName || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('phone').value = data.phone || '';

        if (data.dateOfBirth) {
            const dobInput = document.getElementById('birthDate');
            if (dobInput) dobInput.value = data.dateOfBirth.split('T')[0];
        }
        if (data.gender) {
            const genderSelect = document.getElementById('gender');
            if (genderSelect) genderSelect.value = data.gender;
        }

        // Loyalty - points stored directly on customer
        const points = data.loyaltyPoints || 0;
        let tier = 'Bronze';
        if (points >= 10000) tier = 'Platinum';
        else if (points >= 5000) tier = 'Gold';
        else if (points >= 1000) tier = 'Silver';

        document.getElementById('pointsValue').textContent = points.toLocaleString();
        document.getElementById('tierName').textContent = tier + ' Member';

        const tiers = { 'Bronze': 'ü•â', 'Silver': 'ü•à', 'Gold': 'ü•á', 'Platinum': 'üíé' };
        document.getElementById('tierIcon').textContent = tiers[tier] || 'ü•â';

        // Addresses - API returns Addresses array with AddressLine1, City, etc.
        const addresses = (data.addresses || []).map(a => ({
            id: a.addressId,
            type: (a.addressType || 'home').toLowerCase(),
            street: a.addressLine1 || '',
            barangay: a.addressLine2 || '',
            city: a.city || '',
            province: a.state || '',
            postalCode: a.zipCode || '',
            isDefault: a.isDefault || false
        }));
        loadAddresses(addresses);

        // Rewards activity
        loadRewardsActivity(data.rewardsHistory || []);
    }

    function loadAddresses(addresses) {
        const grid = document.getElementById('addressGrid');

        if (addresses.length === 0) {
            grid.innerHTML = `
                <div class="btn-add-address" onclick="addNewAddress()">
                    ‚ûï Add New Address
                </div>`;
            return;
        }

        grid.innerHTML = addresses.map((addr, i) => `
            <div class="address-card ${addr.isDefault ? 'default' : ''}">
                <div class="address-type">${addr.type === 'home' ? 'üè† Home' : 'üè¢ Office'}</div>
                <div class="address-text">
                    ${addr.street}<br>
                    ${addr.barangay}, ${addr.city}<br>
                    ${addr.province} ${addr.postalCode}
                </div>
                <div class="address-actions">
                    <button class="btn-address" onclick="editAddress(${addr.id})">Edit</button>
                    ${!addr.isDefault ? `<button class="btn-address" onclick="setDefaultAddress(${addr.id})">Set Default</button>` : ''}
                </div>
            </div>`).join('') + `
            <div class="btn-add-address" onclick="addNewAddress()">
                ‚ûï Add New Address
            </div>`;
    }

    function loadRewardsActivity(history) {
        const container = document.getElementById('rewardsActivity');

        if (history.length === 0) {
            container.innerHTML = `
                <p style="color: var(--muted-foreground); text-align: center; padding: 20px;">
                    No rewards activity yet. Start shopping to earn points! üõí
                </p>`;
            return;
        }

        container.innerHTML = history.slice(0, 5).map(item => `
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                <div>
                    <div style="font-weight: 500; color: var(--foreground);">${item.description}</div>
                    <div style="font-size: 0.8rem; color: var(--muted-foreground);">${new Date(item.date).toLocaleDateString()}</div>
                </div>
                <div style="font-weight: 600; color: ${item.points > 0 ? 'var(--success)' : 'var(--error)'};">
                    ${item.points > 0 ? '+' : ''}${item.points} pts
                </div>
            </div>`).join('');
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-pill').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    async function savePersonalInfo(e) {
        e.preventDefault();

        const data = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            birthDate: document.getElementById('birthDate').value,
            gender: document.getElementById('gender').value
        };

        try {
            const response = await fetch('/CustomerPortal/UpdateProfile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showToast('‚úì Profile updated successfully!', 'success');
                document.getElementById('profileName').textContent = data.firstName + ' ' + data.lastName;
                document.getElementById('profileEmail').textContent = data.email;
            } else {
                showToast('Failed to update profile', 'error');
            }
        } catch (error) {
            showToast('Error saving profile', 'error');
        }
    }

    function resetPersonalForm() {
        loadProfile();
    }

    function addNewAddress() {
        const modal = document.createElement('div');
        modal.id = 'addressModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
        <div style="background:white;border-radius:var(--radius);padding:32px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:20px;color:var(--foreground);">Add New Address</h3>
            <div style="display:grid;gap:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div>
                        <label class="form-label">Type</label>
                        <select id="newAddrType" class="form-select" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:Poppins,sans-serif;">
                            <option value="Shipping">Shipping</option>
                            <option value="Billing">Billing</option>
                            <option value="Home">Home</option>
                            <option value="Office">Office</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Zip Code</label>
                        <input type="text" id="newAddrZip" class="form-input" placeholder="e.g. 1200">
                    </div>
                </div>
                <div>
                    <label class="form-label">Address Line 1 *</label>
                    <input type="text" id="newAddrLine1" class="form-input" placeholder="Street address, unit number">
                </div>
                <div>
                    <label class="form-label">Address Line 2</label>
                    <input type="text" id="newAddrLine2" class="form-input" placeholder="Barangay, building, etc.">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div>
                        <label class="form-label">City *</label>
                        <input type="text" id="newAddrCity" class="form-input" placeholder="City">
                    </div>
                    <div>
                        <label class="form-label">Province/State</label>
                        <input type="text" id="newAddrState" class="form-input" placeholder="Province">
                    </div>
                </div>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="newAddrDefault"> Set as default address
                </label>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
                <button onclick="document.getElementById('addressModal').remove()" style="padding:10px 20px;border:1.5px solid var(--border);background:white;border-radius:var(--radius-sm);cursor:pointer;font-family:Poppins,sans-serif;">Cancel</button>
                <button onclick="saveNewAddress()" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Save Address</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function saveNewAddress() {
        const data = {
            addressType: document.getElementById('newAddrType').value,
            addressLine1: document.getElementById('newAddrLine1').value,
            addressLine2: document.getElementById('newAddrLine2').value,
            city: document.getElementById('newAddrCity').value,
            state: document.getElementById('newAddrState').value,
            zipCode: document.getElementById('newAddrZip').value,
            country: 'Philippines',
            isDefault: document.getElementById('newAddrDefault').checked
        };
        if (!data.addressLine1 || !data.city) { showToast('Address & City are required', 'error'); return; }
        try {
            const res = await fetch('/CustomerPortal/AddAddress', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const result = await res.json();
            if (result.success) { showToast('‚úì Address added!', 'success'); document.getElementById('addressModal').remove(); loadProfile(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error adding address', 'error'); }
    }

    function editAddress(id) {
        const cards = document.querySelectorAll('.address-card');
        // Find the address card that contains the edit button for this id
        const modal = document.createElement('div');
        modal.id = 'editAddrModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
        <div style="background:white;border-radius:var(--radius);padding:32px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:20px;">Edit Address</h3>
            <div style="display:grid;gap:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div><label class="form-label">Type</label><select id="editAddrType" class="form-select" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:Poppins,sans-serif;"><option value="Shipping">Shipping</option><option value="Billing">Billing</option><option value="Home">Home</option><option value="Office">Office</option></select></div>
                    <div><label class="form-label">Zip Code</label><input type="text" id="editAddrZip" class="form-input"></div>
                </div>
                <div><label class="form-label">Address Line 1 *</label><input type="text" id="editAddrLine1" class="form-input"></div>
                <div><label class="form-label">Address Line 2</label><input type="text" id="editAddrLine2" class="form-input"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div><label class="form-label">City *</label><input type="text" id="editAddrCity" class="form-input"></div>
                    <div><label class="form-label">Province/State</label><input type="text" id="editAddrState" class="form-input"></div>
                </div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
                <button onclick="deleteAddress(${id})" style="padding:10px 20px;background:var(--error-light);color:var(--error-fg);border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:Poppins,sans-serif;">Delete</button>
                <button onclick="document.getElementById('editAddrModal').remove()" style="padding:10px 20px;border:1.5px solid var(--border);background:white;border-radius:var(--radius-sm);cursor:pointer;font-family:Poppins,sans-serif;">Cancel</button>
                <button onclick="saveEditAddress(${id})" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Save</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function saveEditAddress(id) {
        const data = {
            addressId: id,
            addressType: document.getElementById('editAddrType').value,
            addressLine1: document.getElementById('editAddrLine1').value,
            addressLine2: document.getElementById('editAddrLine2').value,
            city: document.getElementById('editAddrCity').value,
            state: document.getElementById('editAddrState').value,
            zipCode: document.getElementById('editAddrZip').value,
            country: 'Philippines'
        };
        if (!data.addressLine1 || !data.city) { showToast('Address & City are required', 'error'); return; }
        try {
            const res = await fetch('/CustomerPortal/UpdateAddress', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const result = await res.json();
            if (result.success) { showToast('‚úì Address updated!', 'success'); document.getElementById('editAddrModal').remove(); loadProfile(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error updating address', 'error'); }
    }

    async function deleteAddress(id) {
        if (!confirm('Delete this address?')) return;
        try {
            const res = await fetch('/CustomerPortal/DeleteAddress', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ addressId: id }) });
            const result = await res.json();
            if (result.success) { showToast('Address deleted', 'success'); const m = document.getElementById('editAddrModal'); if(m) m.remove(); loadProfile(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error deleting address', 'error'); }
    }

    async function setDefaultAddress(id) {
        try {
            const res = await fetch('/CustomerPortal/SetDefaultAddress', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ addressId: id }) });
            const result = await res.json();
            if (result.success) { showToast('‚úì Default address updated!', 'success'); loadProfile(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error setting default', 'error'); }
    }

    function changePassword() {
        const modal = document.createElement('div');
        modal.id = 'pwModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
        <div style="background:white;border-radius:var(--radius);padding:32px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:20px;">üîë Change Password</h3>
            <div style="display:grid;gap:12px;">
                <div><label class="form-label">Current Password</label><input type="password" id="currentPw" class="form-input"></div>
                <div><label class="form-label">New Password</label><input type="password" id="newPw" class="form-input" placeholder="Min 8 characters"></div>
                <div><label class="form-label">Confirm New Password</label><input type="password" id="confirmPw" class="form-input"></div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
                <button onclick="document.getElementById('pwModal').remove()" style="padding:10px 20px;border:1.5px solid var(--border);background:white;border-radius:var(--radius-sm);cursor:pointer;font-family:Poppins,sans-serif;">Cancel</button>
                <button onclick="submitPasswordChange()" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Change Password</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function submitPasswordChange() {
        const current = document.getElementById('currentPw').value;
        const newPw = document.getElementById('newPw').value;
        const confirm = document.getElementById('confirmPw').value;
        if (!current || !newPw) { showToast('Please fill all fields', 'error'); return; }
        if (newPw.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
        if (newPw !== confirm) { showToast('Passwords do not match', 'error'); return; }
        try {
            const res = await fetch('/CustomerPortal/ChangePassword', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ currentPassword:current, newPassword:newPw }) });
            const result = await res.json();
            if (result.success) { showToast('‚úì Password changed successfully!', 'success'); document.getElementById('pwModal').remove(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error changing password', 'error'); }
    }

    function setup2FA() {
        showToast('Two-factor authentication requires email/SMS verification. This feature will be available in the next update.', 'info');
    }

    function manageEmails() {
        const modal = document.createElement('div');
        modal.id = 'emailPrefModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
        <div style="background:white;border-radius:var(--radius);padding:32px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:20px;">üìß Email Preferences</h3>
            <div style="display:grid;gap:16px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;"><input type="checkbox" id="prefMarketing" checked> Marketing emails & promotions</label>
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;"><input type="checkbox" id="prefOrders" checked disabled> Order confirmations (required)</label>
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;"><input type="checkbox" id="prefSupport" checked disabled> Support ticket updates (required)</label>
                <div><label class="form-label">Preferred Contact Method</label>
                <select id="prefContact" class="form-select" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:Poppins,sans-serif;">
                    <option value="email">Email</option><option value="sms">SMS</option><option value="both">Both</option>
                </select></div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
                <button onclick="document.getElementById('emailPrefModal').remove()" style="padding:10px 20px;border:1.5px solid var(--border);background:white;border-radius:var(--radius-sm);cursor:pointer;font-family:Poppins,sans-serif;">Cancel</button>
                <button onclick="saveEmailPrefs()" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Save Preferences</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function saveEmailPrefs() {
        try {
            const res = await fetch('/CustomerPortal/UpdateEmailPreferences', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ marketingOptIn: document.getElementById('prefMarketing').checked, preferredContactMethod: document.getElementById('prefContact').value }) });
            const result = await res.json();
            if (result.success) { showToast('‚úì Preferences saved!', 'success'); document.getElementById('emailPrefModal').remove(); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error saving preferences', 'error'); }
    }

    async function deleteAccount() {
        if (!confirm('Are you sure you want to delete your account? This action cannot be undone. All your data will be permanently removed within 30 days.')) return;
        if (!confirm('This is your FINAL confirmation. Type DELETE to proceed.')) return;
        try {
            const res = await fetch('/CustomerPortal/DeleteAccount', { method:'POST', headers:{'Content-Type':'application/json'} });
            const result = await res.json();
            if (result.success) { showToast('Account deletion request submitted. You will be logged out.', 'info'); setTimeout(() => window.location.href = '/Auth/Logout', 2000); }
            else showToast(result.message, 'error');
        } catch(e) { showToast('Error submitting deletion request', 'error'); }
    }
</script>
}
