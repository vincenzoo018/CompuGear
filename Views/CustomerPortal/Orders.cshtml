    
    @{
    ViewData["Title"] = "My Orders";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .orders-page { min-height: 100vh; }

    /* Page Header */
    .page-header {
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--foreground);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-subtitle {
        color: var(--muted-foreground);
    }

    /* Stat Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 24px;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .stat-card.total::before { background: var(--primary); }
    .stat-card.processing::before { background: var(--warning); }
    .stat-card.shipped::before { background: var(--info); }
    .stat-card.delivered::before { background: var(--success); }

    .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 12px;
    }

    .stat-value {
        font-size: 1.65rem;
        font-weight: 700;
        color: var(--foreground);
        line-height: 1.2;
        letter-spacing: -0.02em;
    }

    .stat-label {
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--muted-foreground);
        margin-top: 4px;
    }

    /* Tabs Section */
    .tabs-section {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        gap: 8px;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 16px 20px;
        background: none;
        border: none;
        color: var(--muted-foreground);
        font-weight: 500;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.2s;
    }

    .tab-btn:hover { color: var(--foreground); }

    .tab-btn.active {
        color: var(--primary);
        font-weight: 600;
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
    }

    .tab-count {
        background: var(--muted);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .tab-btn.active .tab-count {
        background: var(--primary);
        color: white;
    }

    /* Orders List */
    .orders-content { padding: 24px; }

    .order-row {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: var(--background);
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .order-row:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(0,128,128,0.1);
    }

    .order-icon { font-size: 2rem; }

    .order-info { flex: 1; }

    .order-number {
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .order-meta {
        display: flex;
        gap: 16px;
        font-size: 0.85rem;
        color: var(--muted-foreground);
    }

    .order-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .order-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-emoji { font-size: 1.2rem; }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-pending { background: var(--pending-light); color: var(--pending-fg); }
    .badge-processing { background: var(--warning-light); color: var(--warning-fg); }
    .badge-shipped { background: var(--info-light); color: var(--info-fg); }
    .badge-delivered { background: var(--success-light); color: var(--success-fg); }
    .badge-cancelled { background: var(--error-light); color: var(--error-fg); }

    .order-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
        text-align: right;
    }

    .order-arrow {
        color: var(--muted-foreground);
        font-size: 1.2rem;
    }

    /* Modal */
    .cg-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    }

    .cg-modal-backdrop.active { 
        display: flex !important; 
    }

    .cg-modal {
        background: #FFFFFF;
        border-radius: 20px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        animation: orderModalScaleIn 0.25s ease forwards;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        opacity: 1;
        transform: scale(1);
        position: relative;
        display: block;
    }

    @@keyframes orderModalScaleIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    .cg-modal-header {
        padding: 24px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #FFFFFF;
        border-radius: 20px 20px 0 0;
    }

    .cg-modal-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #141516;
    }

    .cg-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #64748B;
        cursor: pointer;
        padding: 8px;
        line-height: 1;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .cg-modal-close:hover { 
        color: #141516; 
        background: #F1F5F9;
    }

    .cg-modal-body { 
        padding: 24px; 
        background: #FFFFFF;
    }

    /* Order Detail */
    .order-detail-status {
        text-align: center;
        padding: 20px;
        background: var(--muted);
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .detail-status-emoji { font-size: 3rem; margin-bottom: 12px; }

    .detail-status-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--foreground);
    }

    .order-timeline {
        display: flex;
        justify-content: space-between;
        padding: 20px 0;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
    }

    .timeline-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .timeline-step::after {
        content: '';
        position: absolute;
        top: 16px;
        left: 60%;
        right: -40%;
        height: 2px;
        background: var(--border);
    }

    .timeline-step:last-child::after { display: none; }

    .timeline-step.completed::after { background: var(--success); }

    .timeline-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        z-index: 1;
        border: 2px solid var(--border);
    }

    .timeline-step.completed .timeline-icon {
        background: var(--success-light);
        border-color: var(--success);
    }

    .timeline-step.current .timeline-icon {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .timeline-label {
        font-size: 0.7rem;
        color: var(--muted-foreground);
        margin-top: 8px;
        text-align: center;
    }

    .detail-section {
        margin-bottom: 20px;
    }

    .detail-section-title {
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 0.9rem;
    }

    .detail-label { color: var(--muted-foreground); }
    .detail-value { color: var(--foreground); font-weight: 500; }

    .order-items-list { margin-top: 12px; }

    .order-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--background);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .item-icon { font-size: 1.5rem; }
    .item-info { flex: 1; }
    .item-name { font-weight: 500; color: var(--foreground); }
    .item-meta { font-size: 0.8rem; color: var(--muted-foreground); }
    .item-price { font-weight: 600; color: var(--primary); }

    .order-total-row {
        display: flex;
        justify-content: space-between;
        padding: 16px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        margin-top: 16px;
        font-weight: 700;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon { font-size: 4rem; opacity: 0.5; margin-bottom: 16px; }
    .empty-text { color: var(--muted-foreground); font-size: 1.1rem; margin-bottom: 20px; }

    .btn-shop {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
    }

    .btn-shop:hover { color: white; transform: translateY(-2px); }

    /* Responsive */
    @@media (max-width: 1024px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 768px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-card { padding: 16px; }
        .stat-value { font-size: 1.35rem; }
        .order-row { flex-wrap: wrap; padding: 16px; }
        .order-status { order: 3; width: 100%; margin-top: 12px; }
        .order-amount { order: 2; }
        .order-arrow { display: none; }
        .tabs-header { padding: 0 12px; }
        .tab-btn { padding: 12px; font-size: 0.9rem; }
        .order-timeline { display: none; }
    }

    @@media (max-width: 576px) {
        .stats-grid { grid-template-columns: 1fr 1fr; }
        .page-title { font-size: 1.5rem; }
    }

    /* ========== TRACKING MODAL ========== */
    .tracking-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        backdrop-filter: blur(4px);
    }

    .tracking-backdrop.active {
        display: flex !important;
    }

    .tracking-modal {
        background: #FFFFFF;
        border-radius: 20px;
        width: 100%;
        max-width: 900px;
        max-height: 92vh;
        overflow-y: auto;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
        animation: trackingModalIn 0.3s ease forwards;
    }

    @@keyframes trackingModalIn {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .tracking-modal-header {
        padding: 24px 28px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #008080, #006666);
        border-radius: 20px 20px 0 0;
        color: white;
    }

    .tracking-modal-header .cg-modal-title {
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
    }

    .tracking-modal-header .cg-modal-close {
        color: rgba(255,255,255,0.8);
        background: rgba(255,255,255,0.15);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .tracking-modal-header .cg-modal-close:hover {
        background: rgba(255,255,255,0.3);
        color: white;
    }

    .tracking-modal-body {
        padding: 0;
    }

    /* Map Container */
    .tracking-map-container {
        width: 100%;
        height: 320px;
        position: relative;
        border-bottom: 3px solid #008080;
    }

    #trackingMap {
        width: 100%;
        height: 100%;
    }

    .map-overlay-info {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(8px);
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        z-index: 5;
        max-width: 260px;
    }

    .map-overlay-info .overlay-status {
        font-weight: 700;
        color: #008080;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .map-overlay-info .overlay-detail {
        font-size: 0.78rem;
        color: #64748B;
    }

    /* Tracking Content */
    .tracking-content {
        padding: 24px 28px;
    }

    .tracking-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 28px;
    }

    .tracking-summary-card {
        background: #F8FAFC;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
    }

    .tracking-summary-card .summary-icon {
        font-size: 1.6rem;
        margin-bottom: 6px;
    }

    .tracking-summary-card .summary-label {
        font-size: 0.75rem;
        color: #64748B;
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .tracking-summary-card .summary-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #141516;
    }

    /* Tracking Timeline */
    .tracking-timeline {
        position: relative;
        padding-left: 40px;
    }

    .tracking-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #E5E7EB;
        border-radius: 2px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 28px;
        padding-left: 20px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-dot {
        position: absolute;
        left: -31px;
        top: 2px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #E5E7EB;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 3px solid #FFFFFF;
        box-shadow: 0 0 0 2px #E5E7EB;
        z-index: 1;
    }

    .timeline-item.completed .timeline-dot {
        background: #10B981;
        box-shadow: 0 0 0 2px #10B981;
        color: white;
    }

    .timeline-item.current .timeline-dot {
        background: #008080;
        box-shadow: 0 0 0 2px #008080, 0 0 0 6px rgba(0,128,128,0.2);
        color: white;
        animation: pulseTrack 2s ease-in-out infinite;
    }

    @@keyframes pulseTrack {
        0%, 100% { box-shadow: 0 0 0 2px #008080, 0 0 0 6px rgba(0,128,128,0.2); }
        50% { box-shadow: 0 0 0 2px #008080, 0 0 0 10px rgba(0,128,128,0.1); }
    }

    .timeline-item-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .timeline-info h4 {
        font-size: 0.95rem;
        font-weight: 700;
        color: #141516;
        margin: 0 0 2px 0;
    }

    .timeline-item:not(.completed):not(.current) .timeline-info h4 {
        color: #94A3B8;
    }

    .timeline-info p {
        font-size: 0.82rem;
        color: #64748B;
        margin: 0;
    }

    .timeline-item:not(.completed):not(.current) .timeline-info p {
        color: #CBD5E1;
    }

    .timeline-date {
        font-size: 0.78rem;
        color: #64748B;
        white-space: nowrap;
        text-align: right;
    }

    .timeline-item:not(.completed):not(.current) .timeline-date {
        color: #CBD5E1;
    }

    /* Track Order Button */
    .btn-track-order {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #008080, #006666);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        justify-content: center;
        margin-top: 16px;
    }

    .btn-track-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,128,128,0.3);
    }

    /* Tracking Items in Modal */
    .tracking-items-section {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #E5E7EB;
    }

    .tracking-items-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #141516;
        margin-bottom: 12px;
    }

    .tracking-item-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: #F8FAFC;
        border-radius: 8px;
        margin-bottom: 6px;
    }

    .tracking-item-icon {
        font-size: 1.3rem;
    }

    .tracking-item-details {
        flex: 1;
    }

    .tracking-item-name {
        font-weight: 600;
        font-size: 0.88rem;
        color: #141516;
    }

    .tracking-item-qty {
        font-size: 0.78rem;
        color: #64748B;
    }

    .tracking-item-price {
        font-weight: 700;
        color: #008080;
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .tracking-modal { max-width: 100%; border-radius: 16px; }
        .tracking-map-container { height: 240px; }
        .tracking-summary { grid-template-columns: 1fr; }
        .tracking-content { padding: 16px 20px; }
    }
</style>

<div class="orders-page">
    <!-- Page Header -->
    <div class="page-header animate-fade-in">
        <h1 class="page-title">üì¶ My Orders</h1>
        <p class="page-subtitle">Track and manage your orders</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card total animate-fade-in" style="animation-delay: 0.05s">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card processing animate-fade-in" style="animation-delay: 0.1s">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value" id="statProcessing">0</div>
            <div class="stat-label">Processing</div>
        </div>
        <div class="stat-card shipped animate-fade-in" style="animation-delay: 0.15s">
            <div class="stat-icon">üöö</div>
            <div class="stat-value" id="statShipped">0</div>
            <div class="stat-label">Shipped</div>
        </div>
        <div class="stat-card delivered animate-fade-in" style="animation-delay: 0.2s">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="statDelivered">0</div>
            <div class="stat-label">Delivered</div>
        </div>
    </div>

    <!-- Orders Tabs -->
    <div class="tabs-section animate-fade-in" style="animation-delay: 0.25s">
        <div class="tabs-header">
            <button class="tab-btn active" data-status="all" onclick="filterOrders('all', this)">
                All
                <span class="tab-count" id="countAll">0</span>
            </button>
            <button class="tab-btn" data-status="pending" onclick="filterOrders('pending', this)">
                Pending
                <span class="tab-count" id="countPending">0</span>
            </button>
            <button class="tab-btn" data-status="processing" onclick="filterOrders('processing', this)">
                Processing
                <span class="tab-count" id="countProcessing">0</span>
            </button>
            <button class="tab-btn" data-status="shipped" onclick="filterOrders('shipped', this)">
                Shipped
                <span class="tab-count" id="countShipped">0</span>
            </button>
            <button class="tab-btn" data-status="delivered" onclick="filterOrders('delivered', this)">
                Delivered
                <span class="tab-count" id="countDelivered">0</span>
            </button>
            <button class="tab-btn" data-status="cancelled" onclick="filterOrders('cancelled', this)">
                Cancelled
                <span class="tab-count" id="countCancelled">0</span>
            </button>
        </div>
        <div class="orders-content" id="ordersContent">
            <div class="empty-state">
                <div class="empty-icon">üîÑ</div>
                <p class="empty-text">Loading orders...</p>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="cg-modal-backdrop" id="orderModal" onclick="closeModalOnBackdrop(event)">
    <div class="cg-modal" onclick="event.stopPropagation()">
        <div class="cg-modal-header">
            <span class="cg-modal-title" id="modalTitle">Order Details</span>
            <button class="cg-modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="cg-modal-body" id="modalBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Order Tracking Modal -->
<div class="tracking-backdrop" id="trackingModal" onclick="closeTrackingOnBackdrop(event)">
    <div class="tracking-modal" onclick="event.stopPropagation()">
        <div class="tracking-modal-header">
            <span class="cg-modal-title">
                <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span id="trackingModalTitle">Track Order</span>
            </span>
            <button class="cg-modal-close" onclick="closeTrackingModal()">&times;</button>
        </div>
        <div class="tracking-modal-body">
            <!-- Google Map -->
            <div class="tracking-map-container">
                <div id="trackingMap"></div>
                <div class="map-overlay-info" id="mapOverlayInfo">
                    <div class="overlay-status" id="overlayStatus">Loading...</div>
                    <div class="overlay-detail" id="overlayDetail">Fetching tracking info</div>
                </div>
            </div>
            <!-- Tracking Details -->
            <div class="tracking-content" id="trackingContent">
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:2rem;">üîÑ</div>
                    <p style="color:#64748B;">Loading tracking details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAppyyZwTguVFsOgqXF8PPjBg4uoGvtnCs&v=weekly&libraries=geometry,places&callback=initMapsReady" async defer></script>
<script>
    const productIcons = ['üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üéß', 'üíæ', 'üéÆ', 'üì±', 'üîå', 'üíª', 'üñ®Ô∏è'];
    let allOrders = [];
    let currentFilter = 'all';
    let trackingMap = null;
    let googleMapsReady = false;

    const statusConfig = {
        'Pending': { emoji: '‚è±Ô∏è', badge: 'badge-pending', step: 0 },
        'Confirmed': { emoji: '‚úì', badge: 'badge-processing', step: 1 },
        'Processing': { emoji: '‚öôÔ∏è', badge: 'badge-processing', step: 1 },
        'Shipped': { emoji: 'üöö', badge: 'badge-shipped', step: 2 },
        'Out for Delivery': { emoji: 'üìç', badge: 'badge-shipped', step: 2 },
        'Delivered': { emoji: '‚úÖ', badge: 'badge-delivered', step: 3 },
        'Cancelled': { emoji: '‚ùå', badge: 'badge-cancelled', step: -1 },
        'Refunded': { emoji: '‚Ü©Ô∏è', badge: 'badge-cancelled', step: -1 }
    };

    // Google Maps callback
    function initMapsReady() {
        googleMapsReady = true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        const orderId = urlParams.get('orderId');

        if (paymentStatus === 'success' && orderId) {
            showPaymentSuccessToast(orderId);
            window.history.replaceState({}, document.title, '/CustomerPortal/Orders');
        }

        loadOrders();
    });

    async function showPaymentSuccessToast(orderId) {
        try {
            const response = await fetch(`/CustomerPortal/CheckPaymentStatus?orderId=${orderId}`);
            const result = await response.json();

            if (result.success) {
                const order = result.data;
                const isPaid = order.paymentStatus === 'Paid';

                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);';
                overlay.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 50px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: trackingModalIn 0.3s ease;">
                        <div style="font-size: 5rem; margin-bottom: 16px;">${isPaid ? 'üéâ' : '‚è±Ô∏è'}</div>
                        <h2 style="font-size: 1.8rem; font-weight: 800; color: #1f2937; margin-bottom: 8px;">${isPaid ? 'Payment Successful!' : 'Order Created!'}</h2>
                        <p style="color: #6b7280; margin-bottom: 8px;">Order <strong>#${order.orderNumber}</strong></p>
                        <p style="color: ${isPaid ? '#10b981' : '#f59e0b'}; font-weight: 600; margin-bottom: 8px;">
                            ${isPaid ? '‚úÖ Payment confirmed' : '‚è≥ Payment pending'}
                        </p>
                        <p style="color: #008080; font-size: 1.3rem; font-weight: 800; margin-bottom: 24px;">‚Ç±${order.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
                        <button onclick="this.closest('div').parentElement.remove()" 
                            style="padding: 14px 40px; background: linear-gradient(135deg, #008080, #006666); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,128,128,0.3);">
                            üëç Got It!
                        </button>
                    </div>`;
                document.body.appendChild(overlay);
                setTimeout(() => overlay.remove(), 8000);
            }
        } catch (error) {
            console.error('Error checking payment:', error);
        }
    }

    async function loadOrders() {
        try {
            const response = await fetch('/CustomerPortal/GetOrders?pageSize=50');
            const result = await response.json();

            if (result.success) {
                allOrders = result.data || [];

                if (result.stats) {
                    document.getElementById('statTotal').textContent = result.stats.total || 0;
                    document.getElementById('statProcessing').textContent = result.stats.pending || 0;
                    
                    const shippedCount = allOrders.filter(o => o.orderStatus === 'Shipped').length;
                    document.getElementById('statShipped').textContent = shippedCount;
                    document.getElementById('statDelivered').textContent = result.stats.delivered || 0;

                    document.getElementById('countAll').textContent = result.stats.total || 0;
                    const pendingCount = allOrders.filter(o => o.orderStatus === 'Pending').length;
                    const processingCount = allOrders.filter(o => o.orderStatus === 'Processing' || o.orderStatus === 'Confirmed').length;
                    const deliveredCount = allOrders.filter(o => o.orderStatus === 'Delivered').length;
                    const cancelledCount = allOrders.filter(o => o.orderStatus === 'Cancelled').length;
                    
                    document.getElementById('countPending').textContent = pendingCount;
                    document.getElementById('countProcessing').textContent = processingCount;
                    document.getElementById('countShipped').textContent = shippedCount;
                    document.getElementById('countDelivered').textContent = deliveredCount;
                    document.getElementById('countCancelled').textContent = cancelledCount;
                }

                renderOrders(allOrders);
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            showEmptyState();
        }
    }

    function filterOrders(status, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = status;

        let filtered = allOrders;
        if (status !== 'all') {
            filtered = allOrders.filter(o => {
                const orderStatus = (o.orderStatus || '').toLowerCase();
                if (status === 'processing') return orderStatus === 'processing' || orderStatus === 'confirmed';
                return orderStatus === status.toLowerCase();
            });
        }
        renderOrders(filtered);
    }

    function renderOrders(orders) {
        const container = document.getElementById('ordersContent');

        if (!orders || orders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <p class="empty-text">${currentFilter === 'all' ? "You haven't placed any orders yet" : `No ${currentFilter} orders found`}</p>
                    <a href="/CustomerPortal/Products" class="btn-shop">üõí Start Shopping</a>
                </div>`;
            return;
        }

        container.innerHTML = orders.map((order, index) => {
            const config = statusConfig[order.orderStatus] || statusConfig['Pending'];
            const orderDate = new Date(order.orderDate).toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' });
            const itemCount = order.itemCount || (order.items ? order.items.length : 0);
            const paymentBadge = order.paymentStatus === 'Paid' 
                ? '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">PAID</span>'
                : order.paymentStatus === 'Pending'
                ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">UNPAID</span>'
                : '';

            return `
                <div class="order-row animate-fade-in" style="animation-delay: ${index * 0.05}s" onclick="viewOrderDetail(${order.orderId})">
                    <div class="order-icon">${config.emoji}</div>
                    <div class="order-info">
                        <div class="order-number">
                            #${order.orderNumber || order.orderId} ${paymentBadge}
                        </div>
                        <div class="order-meta">
                            <span class="order-meta-item">üìÖ ${orderDate}</span>
                            <span class="order-meta-item">üì¶ ${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
                            ${order.paymentMethod ? `<span class="order-meta-item">üí≥ ${order.paymentMethod}</span>` : ''}
                        </div>
                    </div>
                    <div class="order-status">
                        <span class="status-badge ${config.badge}">${order.orderStatus}</span>
                    </div>
                    <div class="order-amount">‚Ç±${order.totalAmount.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</div>
                    <div class="order-arrow">‚Üí</div>
                </div>`;
        }).join('');
    }

    function showEmptyState() {
        document.getElementById('ordersContent').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <p class="empty-text">You haven't placed any orders yet</p>
                <a href="/CustomerPortal/Products" class="btn-shop">üõí Start Shopping</a>
            </div>`;
    }

    async function viewOrderDetail(orderId) {
        const order = allOrders.find(o => o.orderId === orderId);
        if (!order) return;

        const config = statusConfig[order.orderStatus] || statusConfig['Pending'];
        const orderDate = new Date(order.orderDate).toLocaleDateString('en-PH', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        document.getElementById('modalTitle').textContent = `Order #${order.orderNumber || order.orderId}`;

        // Build timeline HTML
        const steps = ['Confirmed', 'Processing', 'Shipped', 'Delivered'];
        const currentStep = config.step;

        const timelineHtml = steps.map((step, i) => {
            let stepClass = '';
            if (currentStep === -1) stepClass = '';
            else if (i < currentStep) stepClass = 'completed';
            else if (i === currentStep) stepClass = 'current';

            const stepEmojis = ['‚úì', '‚öôÔ∏è', 'üöö', '‚úÖ'];
            return `
                <div class="timeline-step ${stepClass}">
                    <div class="timeline-icon">${stepEmojis[i]}</div>
                    <div class="timeline-label">${step}</div>
                </div>`;
        }).join('');

        // Build items list
        const items = order.items || [];
        const itemsHtml = items.map((item, i) => `
            <div class="order-item">
                <div class="item-icon">${productIcons[i % productIcons.length]}</div>
                <div class="item-info">
                    <div class="item-name">${item.productName}</div>
                    <div class="item-meta">Qty: ${item.quantity} √ó ‚Ç±${item.unitPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="item-price">‚Ç±${item.totalPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
            </div>`).join('');

        // VAT breakdown
        const subtotal = items.reduce((sum, item) => sum + item.totalPrice, 0) || order.totalAmount;
        const vatableSales = subtotal / 1.12;
        const vatAmount = subtotal - vatableSales;

        // Determine if tracking should be available
        const canTrack = order.orderStatus !== 'Cancelled' && order.orderStatus !== 'Refunded';
        const trackBtnHtml = canTrack ? `
            <button class="btn-track-order" onclick="event.stopPropagation(); closeModal(); openTrackingModal(${order.orderId});">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                üìç Track My Order
            </button>` : '';

        document.getElementById('modalBody').innerHTML = `
            <div class="order-detail-status">
                <div class="detail-status-emoji">${config.emoji}</div>
                <div class="detail-status-text">${order.orderStatus}</div>
                <div style="margin-top: 4px; font-size: 0.85rem; color: ${order.paymentStatus === 'Paid' ? '#10b981' : '#f59e0b'};">
                    Payment: ${order.paymentStatus} ${order.paymentStatus === 'Paid' ? '‚úÖ' : '‚è≥'}
                </div>
            </div>

            <div class="order-timeline">
                ${timelineHtml}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Order Information</div>
                <div class="detail-row">
                    <span class="detail-label">Order Date</span>
                    <span class="detail-value">${orderDate}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Method</span>
                    <span class="detail-value">${order.paymentMethod || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Status</span>
                    <span class="detail-value" style="color: ${order.paymentStatus === 'Paid' ? '#10b981' : '#f59e0b'}">${order.paymentStatus}</span>
                </div>
                ${order.shippingMethod ? `
                <div class="detail-row">
                    <span class="detail-label">Shipping Method</span>
                    <span class="detail-value">${order.shippingMethod}</span>
                </div>` : ''}
                ${order.trackingNumber ? `
                <div class="detail-row">
                    <span class="detail-label">Tracking Number</span>
                    <span class="detail-value">${order.trackingNumber}</span>
                </div>` : ''}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Items (${items.length})</div>
                <div class="order-items-list">
                    ${itemsHtml || '<p style="color: #64748B; font-size: 0.9rem;">Item details not available</p>'}
                </div>
            </div>

            <div class="detail-section" style="background: #f0fdf4; border-radius: 12px; padding: 16px; margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: #6b7280;">VATable Sales</span>
                    <span>‚Ç±${vatableSales.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: #6b7280;">VAT (12%)</span>
                    <span>‚Ç±${vatAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
            </div>

            <div class="order-total-row">
                <span>Total Amount</span>
                <span>‚Ç±${order.totalAmount.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</span>
            </div>

            ${trackBtnHtml}`;

        document.getElementById('orderModal').classList.add('active');
        document.getElementById('orderModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('orderModal').classList.remove('active');
        document.getElementById('orderModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    function closeModalOnBackdrop(event) {
        if (event.target.id === 'orderModal') closeModal();
    }

    // ==========================================
    // TRACKING MODAL FUNCTIONS
    // ==========================================

    async function openTrackingModal(orderId) {
        const modal = document.getElementById('trackingModal');
        modal.classList.add('active');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        document.getElementById('trackingModalTitle').textContent = 'Loading...';
        document.getElementById('overlayStatus').textContent = 'Loading...';
        document.getElementById('overlayDetail').textContent = 'Fetching tracking information';
        document.getElementById('trackingContent').innerHTML = `
            <div style="text-align:center; padding:40px;">
                <div style="font-size:2rem; animation: pulseTrack 1.5s infinite;">üì¶</div>
                <p style="color:#64748B; margin-top:12px;">Loading tracking details...</p>
            </div>`;

        try {
            const response = await fetch(`/CustomerPortal/GetOrderTracking?orderId=${orderId}`);
            const result = await response.json();

            if (result.success) {
                renderTrackingModal(result.data);
            } else {
                document.getElementById('trackingContent').innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <div style="font-size:2rem;">‚ùå</div>
                        <p style="color:#EF4444; margin-top:12px;">Failed to load tracking info</p>
                    </div>`;
            }
        } catch (error) {
            console.error('Tracking error:', error);
            document.getElementById('trackingContent').innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:2rem;">‚ùå</div>
                    <p style="color:#EF4444; margin-top:12px;">Error loading tracking data</p>
                </div>`;
        }
    }

    function renderTrackingModal(data) {
        // Update header
        document.getElementById('trackingModalTitle').textContent = `Track Order #${data.orderNumber}`;

        // Map overlay
        const statusText = data.orderStatus === 'Delivered' ? '‚úÖ Delivered' 
            : data.orderStatus === 'Shipped' ? 'üöö In Transit'
            : data.orderStatus === 'Out for Delivery' ? 'üìç Out for Delivery'
            : data.orderStatus === 'Processing' ? '‚öôÔ∏è Processing'
            : data.orderStatus === 'Confirmed' ? '‚úì Confirmed'
            : '‚è±Ô∏è Pending';
        
        document.getElementById('overlayStatus').textContent = statusText;
        document.getElementById('overlayDetail').textContent = 
            data.trackingNumber ? `Tracking: ${data.trackingNumber}` : `Est. Delivery: ${data.tracking.estimatedDelivery}`;

        // Initialize Google Map
        initTrackingMap(data.tracking);

        // Build summary cards
        const summaryHtml = `
            <div class="tracking-summary">
                <div class="tracking-summary-card">
                    <div class="summary-icon">üìç</div>
                    <div class="summary-label">From</div>
                    <div class="summary-value">${data.tracking.origin.label}</div>
                </div>
                <div class="tracking-summary-card">
                    <div class="summary-icon">üè†</div>
                    <div class="summary-label">Destination</div>
                    <div class="summary-value">${data.shippingAddress || data.shippingCity || 'Delivery Address'}</div>
                </div>
                <div class="tracking-summary-card">
                    <div class="summary-icon">üìÖ</div>
                    <div class="summary-label">Est. Delivery</div>
                    <div class="summary-value">${data.tracking.estimatedDelivery}</div>
                </div>
            </div>`;

        // Build timeline
        const timelineIcons = {
            'placed': 'üìã',
            'confirmed': '‚úÖ',
            'processing': '‚öôÔ∏è',
            'shipped': 'üöö',
            'outfordelivery': 'üìç',
            'delivered': 'üè†'
        };

        // Find the last completed step to mark it as "current"
        let lastCompletedIdx = -1;
        data.timeline.forEach((step, i) => {
            if (step.completed) lastCompletedIdx = i;
        });

        const timelineHtml = data.timeline.map((step, idx) => {
            let cls = '';
            if (step.completed && idx === lastCompletedIdx) cls = 'current';
            else if (step.completed) cls = 'completed';

            const icon = timelineIcons[step.icon] || '‚óã';
            const dateStr = step.date 
                ? new Date(step.date).toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                : '‚Äî';

            return `
                <div class="timeline-item ${cls}">
                    <div class="timeline-dot">${step.completed ? '‚úì' : '‚óã'}</div>
                    <div class="timeline-item-content">
                        <div class="timeline-info">
                            <h4>${icon} ${step.status}</h4>
                            <p>${step.description}</p>
                        </div>
                        <div class="timeline-date">${step.completed ? dateStr : ''}</div>
                    </div>
                </div>`;
        }).join('');

        // Build items
        const itemsHtml = (data.items || []).map((item, i) => `
            <div class="tracking-item-row">
                <div class="tracking-item-icon">${productIcons[i % productIcons.length]}</div>
                <div class="tracking-item-details">
                    <div class="tracking-item-name">${item.productName}</div>
                    <div class="tracking-item-qty">Qty: ${item.quantity} √ó ‚Ç±${item.unitPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="tracking-item-price">‚Ç±${item.totalPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
            </div>`).join('');

        // Progress bar percentage
        const progressPct = Math.round(data.tracking.progress * 100);

        document.getElementById('trackingContent').innerHTML = `
            ${summaryHtml}

            <!-- Progress Bar -->
            <div style="margin-bottom: 28px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span style="font-size:0.82rem; font-weight:600; color:#141516;">Delivery Progress</span>
                    <span style="font-size:0.82rem; font-weight:700; color:#008080;">${progressPct}%</span>
                </div>
                <div style="background:#E5E7EB; border-radius:10px; height:10px; overflow:hidden;">
                    <div style="background: linear-gradient(90deg, #008080, #10B981); height:100%; width:${progressPct}%; border-radius:10px; transition: width 1s ease;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:6px;">
                    <span style="font-size:0.72rem; color:#94A3B8;">Warehouse</span>
                    <span style="font-size:0.72rem; color:#94A3B8;">Your Address</span>
                </div>
            </div>

            <!-- Timeline -->
            <div style="margin-bottom:24px;">
                <h3 style="font-size:1rem; font-weight:700; color:#141516; margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid #E5E7EB;">üì¶ Tracking Timeline</h3>
                <div class="tracking-timeline">
                    ${timelineHtml}
                </div>
            </div>

            <!-- Order Info -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div style="background:#F8FAFC; border-radius:10px; padding:14px;">
                    <div style="font-size:0.75rem; color:#64748B; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Shipping Method</div>
                    <div style="font-weight:600; color:#141516; font-size:0.9rem;">${data.shippingMethod || 'Standard Shipping'}</div>
                </div>
                <div style="background:#F8FAFC; border-radius:10px; padding:14px;">
                    <div style="font-size:0.75rem; color:#64748B; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Tracking Number</div>
                    <div style="font-weight:600; color:#008080; font-size:0.9rem;">${data.trackingNumber || 'Awaiting shipment'}</div>
                </div>
            </div>

            <!-- Items -->
            <div class="tracking-items-section">
                <div class="tracking-items-title">üì¶ Items in this Order (${(data.items || []).length})</div>
                ${itemsHtml}
                <div style="display:flex; justify-content:space-between; padding:14px 12px; background:linear-gradient(135deg, #008080, #006666); color:white; border-radius:10px; margin-top:10px; font-weight:700;">
                    <span>Total</span>
                    <span>‚Ç±${data.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
            </div>`;
    }

    function initTrackingMap(tracking) {
        if (!googleMapsReady || typeof google === 'undefined') {
            setTimeout(() => initTrackingMap(tracking), 500);
            return;
        }

        const mapEl = document.getElementById('trackingMap');
        const origin = tracking.origin;
        const dest = tracking.destination;
        const current = tracking.currentLocation;

        const centerLat = (origin.lat + dest.lat) / 2;
        const centerLng = (origin.lng + dest.lng) / 2;

        trackingMap = new google.maps.Map(mapEl, {
            center: { lat: centerLat, lng: centerLng },
            zoom: 12,
            disableDefaultUI: true,
            zoomControl: true,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            gestureHandling: 'cooperative',
            styles: [
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#e9e9e9' }] },
                { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#9e9e9e' }] },
                { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#ffffff' }] },
                { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#f0f0f0' }] },
                { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#616161' }] },
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#f5f5f5' }] },
                { featureType: 'administrative', elementType: 'geometry.stroke', stylers: [{ color: '#c9c9c9' }] }
            ]
        });

        // Origin marker (warehouse)
        const originInfo = new google.maps.InfoWindow({
            content: `<div style="padding:8px 12px; font-family:'Segoe UI',sans-serif;">
                <strong style="color:#008080; font-size:14px;">üì¶ ${origin.label}</strong><br>
                <span style="font-size:12px; color:#666;">Origin / Warehouse</span>
            </div>`
        });
        const originMarker = new google.maps.Marker({
            position: { lat: origin.lat, lng: origin.lng },
            map: trackingMap,
            title: origin.label,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">' +
                    '<circle cx="22" cy="22" r="20" fill="#008080" stroke="white" stroke-width="3"/>' +
                    '<text x="22" y="28" text-anchor="middle" font-size="20">üì¶</text></svg>'),
                scaledSize: new google.maps.Size(44, 44),
                anchor: new google.maps.Point(22, 22)
            }
        });
        originMarker.addListener('click', () => originInfo.open(trackingMap, originMarker));

        // Destination marker
        const destInfo = new google.maps.InfoWindow({
            content: `<div style="padding:8px 12px; font-family:'Segoe UI',sans-serif;">
                <strong style="color:#10B981; font-size:14px;">üè† ${dest.label}</strong><br>
                <span style="font-size:12px; color:#666;">Delivery Address</span>
            </div>`
        });
        const destMarker = new google.maps.Marker({
            position: { lat: dest.lat, lng: dest.lng },
            map: trackingMap,
            title: dest.label,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">' +
                    '<circle cx="22" cy="22" r="20" fill="#10B981" stroke="white" stroke-width="3"/>' +
                    '<text x="22" y="28" text-anchor="middle" font-size="20">üè†</text></svg>'),
                scaledSize: new google.maps.Size(44, 44),
                anchor: new google.maps.Point(22, 22)
            }
        });
        destMarker.addListener('click', () => destInfo.open(trackingMap, destMarker));

        // Use Google Directions Service for real road-based route
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({
            map: trackingMap,
            suppressMarkers: true,  // We use custom markers
            preserveViewport: false,
            polylineOptions: {
                strokeColor: '#CBD5E1',
                strokeOpacity: 0.9,
                strokeWeight: 5
            }
        });

        // Build waypoints for Directions API (intermediate stops)
        const dirWaypoints = tracking.waypoints
            .filter((wp, i) => i > 0 && i < tracking.waypoints.length - 1)
            .map(wp => ({
                location: new google.maps.LatLng(wp.lat, wp.lng),
                stopover: false
            }));

        directionsService.route({
            origin: new google.maps.LatLng(origin.lat, origin.lng),
            destination: new google.maps.LatLng(dest.lat, dest.lng),
            waypoints: dirWaypoints,
            travelMode: google.maps.TravelMode.DRIVING,
            optimizeWaypoints: false
        }, function(result, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                // Render full route in gray
                directionsRenderer.setDirections(result);

                // Overlay completed portion in teal if package is in transit
                if (tracking.progress > 0 && tracking.progress < 1 && result.routes[0]) {
                    const routeOverview = result.routes[0].overview_path;
                    const completedCount = Math.floor(routeOverview.length * tracking.progress);
                    const completedPath = routeOverview.slice(0, completedCount + 1);

                    new google.maps.Polyline({
                        path: completedPath,
                        geodesic: true,
                        strokeColor: '#008080',
                        strokeOpacity: 1,
                        strokeWeight: 6,
                        map: trackingMap
                    });
                } else if (tracking.progress >= 1) {
                    // Delivered ‚Äî show entire route in teal
                    directionsRenderer.setOptions({
                        polylineOptions: {
                            strokeColor: '#008080',
                            strokeOpacity: 1,
                            strokeWeight: 6
                        }
                    });
                    directionsRenderer.setDirections(result);
                }
            } else {
                // Fallback to polylines if Directions API fails
                console.warn('Directions API failed, using polyline fallback:', status);
                drawFallbackRoute(tracking, current);
            }
        });

        // Current location marker (package in transit)
        if (tracking.progress > 0 && tracking.progress < 1 && current) {
            const packageMarker = new google.maps.Marker({
                position: { lat: current.lat, lng: current.lng },
                map: trackingMap,
                title: 'Current Package Location',
                zIndex: 999,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        '<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 52 52">' +
                        '<circle cx="26" cy="26" r="23" fill="#FF6B35" stroke="white" stroke-width="3">' +
                        '<animate attributeName="r" from="21" to="25" dur="1.5s" repeatCount="indefinite"/>' +
                        '</circle>' +
                        '<text x="26" y="33" text-anchor="middle" font-size="22">üöö</text></svg>'),
                    scaledSize: new google.maps.Size(52, 52),
                    anchor: new google.maps.Point(26, 26)
                },
                animation: google.maps.Animation.BOUNCE
            });

            const packageInfo = new google.maps.InfoWindow({
                content: `<div style="padding:8px 12px; font-family:'Segoe UI',sans-serif;">
                    <strong style="color:#FF6B35; font-size:14px;">üöö Your Package</strong><br>
                    <span style="font-size:12px; color:#666;">Currently in transit</span><br>
                    <span style="font-size:12px; color:#008080; font-weight:700;">${Math.round(tracking.progress * 100)}% of the way there</span>
                </div>`
            });
            packageMarker.addListener('click', () => packageInfo.open(trackingMap, packageMarker));
            setTimeout(() => packageMarker.setAnimation(null), 3000);
        }

        // Waypoint markers (small dots)
        tracking.waypoints.forEach((wp, i) => {
            if (i === 0 || i === tracking.waypoints.length - 1) return;
            new google.maps.Marker({
                position: { lat: wp.lat, lng: wp.lng },
                map: trackingMap,
                title: wp.label,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 6,
                    fillColor: wp.reached ? '#008080' : '#CBD5E1',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2
                }
            });
        });

        // Fit bounds
        const bounds = new google.maps.LatLngBounds();
        bounds.extend({ lat: origin.lat, lng: origin.lng });
        bounds.extend({ lat: dest.lat, lng: dest.lng });
        if (current) bounds.extend({ lat: current.lat, lng: current.lng });
        trackingMap.fitBounds(bounds, { padding: 60 });
    }

    // Fallback polyline route if Directions API is unavailable
    function drawFallbackRoute(tracking, current) {
        const routePath = tracking.waypoints.map(wp => ({ lat: wp.lat, lng: wp.lng }));
        new google.maps.Polyline({
            path: routePath,
            geodesic: true,
            strokeColor: '#CBD5E1',
            strokeOpacity: 0.8,
            strokeWeight: 4,
            map: trackingMap
        });
        const completedPath = tracking.waypoints.filter(wp => wp.reached).map(wp => ({ lat: wp.lat, lng: wp.lng }));
        if (current) completedPath.push({ lat: current.lat, lng: current.lng });
        new google.maps.Polyline({
            path: completedPath,
            geodesic: true,
            strokeColor: '#008080',
            strokeOpacity: 1,
            strokeWeight: 5,
            map: trackingMap
        });
    }

    function closeTrackingModal() {
        document.getElementById('trackingModal').classList.remove('active');
        document.getElementById('trackingModal').style.display = 'none';
        document.body.style.overflow = '';
        trackingMap = null;
    }

    function closeTrackingOnBackdrop(event) {
        if (event.target.id === 'trackingModal') closeTrackingModal();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeTrackingModal();
        }
    });
</script>
}
