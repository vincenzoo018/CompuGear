@{
    ViewData["Title"] = "My Orders";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .orders-page { padding: 30px 0; background: #f8f9fa; min-height: 100vh; }
    
    .page-header {
        background: linear-gradient(135deg, #008080 0%, #20b2aa 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 30px;
    }
    
    .page-header h1 { font-weight: 800; margin-bottom: 10px; font-size: 2.2rem; }
    .page-header p { opacity: 0.9; margin: 0; }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    @@media (max-width: 768px) {
        .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        text-align: center;
    }
    
    .stat-icon { font-size: 2rem; margin-bottom: 10px; }
    .stat-value { font-size: 2rem; font-weight: 800; color: #1f2937; }
    .stat-label { color: #6b7280; font-size: 0.9rem; }
    
    .orders-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .orders-header {
        padding: 25px 30px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .orders-header h3 { font-weight: 700; color: #1f2937; margin: 0; }
    
    .filter-tabs {
        display: flex;
        gap: 10px;
    }
    
    .filter-tab {
        padding: 10px 20px;
        border: none;
        background: #f3f4f6;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.3s;
    }
    
    .filter-tab:hover, .filter-tab.active {
        background: #008080;
        color: white;
    }
    
    .order-item {
        padding: 25px 30px;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.3s;
    }
    
    .order-item:hover { background: #fafafa; }
    .order-item:last-child { border-bottom: none; }
    
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .order-info h4 {
        font-weight: 700;
        color: #008080;
        margin: 0 0 5px 0;
        font-size: 1.1rem;
    }
    
    .order-date { color: #6b7280; font-size: 0.9rem; }
    
    .order-status {
        padding: 8px 18px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-pending { background: #fef3cd; color: #856404; }
    .status-processing { background: #cce5ff; color: #004085; }
    .status-shipped { background: #e2d5f1; color: #5a2d82; }
    .status-delivered { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    
    .order-products {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .product-thumbnail {
        min-width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        position: relative;
    }
    
    .product-qty {
        position: absolute;
        bottom: -5px;
        right: -5px;
        background: #008080;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    .more-products {
        min-width: 80px;
        height: 80px;
        background: #e5e7eb;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-weight: 600;
    }
    
    .order-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px dashed #e5e7eb;
    }
    
    .order-total {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .order-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-view {
        padding: 10px 20px;
        background: linear-gradient(135deg, #008080, #006666);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .btn-view:hover { transform: translateY(-2px); }
    
    .btn-reorder {
        padding: 10px 20px;
        background: white;
        color: #008080;
        border: 2px solid #008080;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .btn-reorder:hover { background: #f0f9f9; }
    
    .empty-orders {
        text-align: center;
        padding: 60px 30px;
    }
    
    .empty-orders-icon { font-size: 5rem; margin-bottom: 20px; }
    .empty-orders h3 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 10px; }
    .empty-orders p { color: #6b7280; margin-bottom: 25px; }
    
    .shop-now-btn {
        display: inline-block;
        padding: 15px 40px;
        background: linear-gradient(135deg, #008080, #006666);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .shop-now-btn:hover { transform: translateY(-3px); color: white; }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 30px;
    }
    
    .page-btn {
        padding: 10px 16px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .page-btn:hover, .page-btn.active {
        background: #008080;
        color: white;
        border-color: #008080;
    }
    
    /* Order Details Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }
    
    .modal-header {
        padding: 25px 30px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 { font-weight: 700; color: #1f2937; margin: 0; }
    
    .modal-close {
        width: 40px;
        height: 40px;
        border: none;
        background: #f3f4f6;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .modal-body { padding: 30px; }
    
    .detail-section { margin-bottom: 25px; }
    .detail-title { font-weight: 600; color: #6b7280; margin-bottom: 10px; font-size: 0.9rem; }
    
    .detail-item-row {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 12px;
        margin-bottom: 10px;
    }
    
    .detail-item-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .detail-item-info { flex: 1; }
    .detail-item-name { font-weight: 600; color: #1f2937; }
    .detail-item-meta { color: #6b7280; font-size: 0.85rem; }
    .detail-item-price { font-weight: 700; color: #008080; }
</style>

<div class="orders-page">
    <div class="container">
        <div class="page-header">
            <h1>üì¶ My Orders</h1>
            <p>Track and manage your orders</p>
        </div>
        
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üöö</div>
                <div class="stat-value" id="shippedOrders">0</div>
                <div class="stat-label">Shipped</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="deliveredOrders">0</div>
                <div class="stat-label">Delivered</div>
            </div>
        </div>
        
        <div class="orders-container">
            <div class="orders-header">
                <h3>üõí Order History</h3>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-status="">All</button>
                    <button class="filter-tab" data-status="Pending">Pending</button>
                    <button class="filter-tab" data-status="Processing">Processing</button>
                    <button class="filter-tab" data-status="Shipped">Shipped</button>
                    <button class="filter-tab" data-status="Delivered">Delivered</button>
                </div>
            </div>
            
            <div id="ordersContent">
                <div class="empty-orders">
                    <div class="empty-orders-icon">üì≠</div>
                    <h3>Loading orders...</h3>
                </div>
            </div>
            
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal-overlay" id="orderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìã Order Details</h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

@section Scripts {
<script>
    let orders = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentStatus = '';
    const pageSize = 10;
    const productIcons = ['üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üéß', 'üíæ', 'üéÆ', 'üì±', 'üîå'];

    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
        setupFilterTabs();
    });

    function setupFilterTabs() {
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentStatus = this.dataset.status;
                currentPage = 1;
                loadOrders();
            });
        });
    }

    async function loadOrders(page = 1) {
        currentPage = page;
        
        try {
            const params = new URLSearchParams({
                page: page,
                pageSize: pageSize,
                status: currentStatus
            });
            
            const response = await fetch(`/CustomerPortal/GetOrders?${params}`);
            const result = await response.json();
            
            if (result.success) {
                orders = result.data;
                updateStats(result.stats);
                renderOrders();
                totalPages = Math.ceil(result.totalCount / pageSize);
                renderPagination();
            } else {
                renderEmpty();
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            renderEmpty();
        }
    }

    function updateStats(stats) {
        if (stats) {
            document.getElementById('totalOrders').textContent = stats.total || 0;
            document.getElementById('pendingOrders').textContent = stats.pending || 0;
            document.getElementById('shippedOrders').textContent = stats.shipped || 0;
            document.getElementById('deliveredOrders').textContent = stats.delivered || 0;
        }
    }

    function renderOrders() {
        const container = document.getElementById('ordersContent');
        
        if (!orders || orders.length === 0) {
            renderEmpty();
            return;
        }

        container.innerHTML = orders.map(order => {
            const statusClass = `status-${order.orderStatus.toLowerCase()}`;
            const displayItems = order.items?.slice(0, 4) || [];
            const moreCount = (order.items?.length || 0) - 4;

            return `
                <div class="order-item">
                    <div class="order-header">
                        <div class="order-info">
                            <h4>Order #${order.orderNumber}</h4>
                            <div class="order-date">üìÖ ${new Date(order.orderDate).toLocaleDateString('en-PH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <span class="order-status ${statusClass}">${order.orderStatus}</span>
                    </div>
                    
                    <div class="order-products">
                        ${displayItems.map((item, i) => `
                            <div class="product-thumbnail">
                                ${productIcons[i % productIcons.length]}
                                <span class="product-qty">${item.quantity}</span>
                            </div>
                        `).join('')}
                        ${moreCount > 0 ? `<div class="more-products">+${moreCount}</div>` : ''}
                    </div>
                    
                    <div class="order-footer">
                        <div class="order-total">Total: ‚Ç±${order.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                        <div class="order-actions">
                            <button class="btn-view" onclick="viewOrderDetails(${order.orderId})">üìã View Details</button>
                            ${order.orderStatus === 'Delivered' ? `<button class="btn-reorder" onclick="reorder(${order.orderId})">üîÑ Reorder</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderEmpty() {
        document.getElementById('ordersContent').innerHTML = `
            <div class="empty-orders">
                <div class="empty-orders-icon">üì≠</div>
                <h3>No orders found</h3>
                <p>You haven't placed any orders yet. Start shopping now!</p>
                <a href="/CustomerPortal/Products" class="shop-now-btn">üõçÔ∏è Browse Products</a>
            </div>
        `;
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        
        if (currentPage > 1) {
            html += `<button class="page-btn" onclick="loadOrders(${currentPage - 1})">‚Üê Prev</button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadOrders(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span style="padding: 10px;">...</span>';
            }
        }
        
        if (currentPage < totalPages) {
            html += `<button class="page-btn" onclick="loadOrders(${currentPage + 1})">Next ‚Üí</button>`;
        }
        
        pagination.innerHTML = html;
    }

    function viewOrderDetails(orderId) {
        const order = orders.find(o => o.orderId === orderId);
        if (!order) return;

        const statusClass = `status-${order.orderStatus.toLowerCase()}`;
        
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin: 0; color: #008080;">Order #${order.orderNumber}</h4>
                        <div style="color: #6b7280; font-size: 0.9rem;">${new Date(order.orderDate).toLocaleDateString()}</div>
                    </div>
                    <span class="order-status ${statusClass}">${order.orderStatus}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-title">üì¶ ORDER ITEMS</div>
                ${order.items?.map((item, i) => `
                    <div class="detail-item-row">
                        <div class="detail-item-icon">${productIcons[i % productIcons.length]}</div>
                        <div class="detail-item-info">
                            <div class="detail-item-name">${item.productName}</div>
                            <div class="detail-item-meta">Qty: ${item.quantity} √ó ‚Ç±${item.unitPrice?.toLocaleString() || '0'}</div>
                        </div>
                        <div class="detail-item-price">‚Ç±${((item.quantity || 0) * (item.unitPrice || 0)).toLocaleString()}</div>
                    </div>
                `).join('') || '<div style="color: #6b7280;">No items</div>'}
            </div>
            
            <div class="detail-section" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #6b7280;">Subtotal</span>
                    <span>‚Ç±${order.subtotal?.toLocaleString() || order.totalAmount?.toLocaleString() || '0'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #6b7280;">Shipping</span>
                    <span>‚Ç±${order.shippingFee?.toLocaleString() || '0'}</span>
                </div>
                ${order.discount > 0 ? `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #6b7280;">Discount</span>
                        <span style="color: #10b981;">-‚Ç±${order.discount?.toLocaleString() || '0'}</span>
                    </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #008080;">
                    <span style="font-weight: 700;">Total</span>
                    <span style="font-weight: 800; color: #008080; font-size: 1.2rem;">‚Ç±${order.totalAmount?.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
            </div>
            
            ${order.shippingAddress ? `
                <div class="detail-section">
                    <div class="detail-title">üìç SHIPPING ADDRESS</div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 12px;">
                        ${order.shippingAddress}
                    </div>
                </div>
            ` : ''}
        `;
        
        document.getElementById('orderModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('orderModal').classList.remove('active');
    }

    function reorder(orderId) {
        const order = orders.find(o => o.orderId === orderId);
        if (!order || !order.items) return;

        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        order.items.forEach(item => {
            const existingIndex = cart.findIndex(c => c.productId === item.productId);
            if (existingIndex > -1) {
                cart[existingIndex].quantity += item.quantity;
            } else {
                cart.push({
                    productId: item.productId,
                    name: item.productName,
                    price: item.unitPrice,
                    quantity: item.quantity,
                    sku: ''
                });
            }
        });
        
        localStorage.setItem('cart', JSON.stringify(cart));
        showToast('‚úì Items added to cart!', '#10b981');
        
        setTimeout(() => {
            window.location.href = '/CustomerPortal/Cart';
        }, 1000);
    }

    function showToast(message, color) {
        const toast = document.createElement('div');
        toast.innerHTML = `<div style="position: fixed; bottom: 20px; right: 20px; background: ${color}; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999;">${message}</div>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    }

    // Close modal on outside click
    document.getElementById('orderModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
</script>
}
