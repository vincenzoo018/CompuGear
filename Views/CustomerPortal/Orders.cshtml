
@{
    ViewData["Title"] = "My Orders";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>
    .orders-page {
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
    }

    /* Page Header */
    .page-header {
        margin-bottom: 28px;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: -0.02em;
    }

    .page-subtitle {
        color: var(--muted-foreground);
        font-size: 0.925rem;
    }

    /* Stat Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 28px;
    }

    .stat-card {
        background: #FFFFFF;
        border-radius: var(--radius);
        border: 1px solid #E5E7EB;
        padding: 20px 22px;
        position: relative;
        overflow: hidden;
        transition: border-color 0.2s ease;
    }

    .stat-card:hover {
        border-color: #D1D5DB;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
    }

    .stat-card.total::before { background: var(--primary); }
    .stat-card.processing::before { background: var(--warning); }
    .stat-card.shipped::before { background: var(--info); }
    .stat-card.delivered::before { background: var(--success); }

    .stat-icon {
        font-size: 1.35rem;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--foreground);
        line-height: 1;
        letter-spacing: -0.02em;
    }

    .stat-label {
        font-size: 0.825rem;
        color: var(--muted-foreground);
        margin-top: 4px;
        font-weight: 500;
    }

    /* Tabs Section */
    .tabs-section {
        background: #FFFFFF;
        border-radius: var(--radius);
        border: 1px solid #E5E7EB;
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        border-bottom: 1px solid #E5E7EB;
        padding: 0 20px;
        gap: 4px;
        overflow-x: auto;
        background: #F9FAFB;
    }

    .tab-btn {
        padding: 14px 16px;
        background: none;
        border: none;
        color: var(--muted-foreground);
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.2s ease;
    }

    .tab-btn:hover {
        color: var(--foreground);
    }

    .tab-btn.active {
        color: var(--primary);
        font-weight: 600;
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 2px 2px 0 0;
    }

    .tab-count {
        background: #F3F4F6;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.725rem;
        font-weight: 600;
        color: var(--muted-foreground);
    }

    .tab-btn.active .tab-count {
        background: var(--primary);
        color: white;
    }

    /* Orders List */
    .orders-content {
        padding: 20px;
    }

    .order-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 18px;
        background: #FFFFFF;
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
        border: 1px solid #F3F4F6;
    }

    .order-row:hover {
        background-color: #F9FAFB;
        border-color: #E5E7EB;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .order-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #F9FAFB;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
    }

    .order-info { flex: 1; min-width: 0; }

    .order-number {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--foreground);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .order-meta {
        display: flex;
        gap: 14px;
        font-size: 0.8rem;
        color: var(--muted-foreground);
    }

    .order-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .order-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-emoji { font-size: 1.1rem; }

    .status-badge {
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.725rem;
        font-weight: 600;
        letter-spacing: 0.01em;
    }

    .badge-pending { background: var(--pending-light); color: var(--pending-fg); }
    .badge-processing { background: var(--warning-light); color: var(--warning-fg); }
    .badge-shipped { background: var(--info-light); color: var(--info-fg); }
    .badge-delivered { background: var(--success-light); color: var(--success-fg); }
    .badge-cancelled { background: var(--error-light); color: var(--error-fg); }

    .order-amount {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--foreground);
        text-align: right;
        white-space: nowrap;
    }

    .order-arrow {
        color: #D1D5DB;
        font-size: 1rem;
    }

    /* Modal */
    .cg-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
        backdrop-filter: blur(2px);
    }

    .cg-modal-backdrop.active {
        display: flex !important;
    }

    .cg-modal {
        background: #FFFFFF;
        border-radius: var(--radius);
        width: 100%;
        max-width: 580px;
        max-height: 90vh;
        overflow-y: auto;
        animation: orderModalScaleIn 0.2s ease forwards;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12), 0 0 1px rgba(0,0,0,0.1);
        opacity: 1;
        transform: scale(1);
        position: relative;
        display: block;
    }

    @@keyframes orderModalScaleIn {
        from { opacity: 0; transform: scale(0.97) translateY(8px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .cg-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #FFFFFF;
        border-radius: var(--radius) var(--radius) 0 0;
    }

    .cg-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--foreground);
        letter-spacing: -0.01em;
    }

    .cg-modal-close {
        background: none;
        border: none;
        font-size: 1.4rem;
        color: #9CA3AF;
        cursor: pointer;
        padding: 6px;
        line-height: 1;
        border-radius: 6px;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .cg-modal-close:hover {
        color: var(--foreground);
        background: #F3F4F6;
    }

    .cg-modal-body {
        padding: 24px;
        background: #FFFFFF;
    }

    /* Order Detail */
    .order-detail-status {
        text-align: center;
        padding: 20px;
        background: #F9FAFB;
        border-radius: var(--radius-sm);
        margin-bottom: 20px;
        border: 1px solid #F3F4F6;
    }

    .detail-status-emoji { font-size: 2.5rem; margin-bottom: 10px; }

    .detail-status-text {
        font-size: 1rem;
        font-weight: 600;
        color: var(--foreground);
    }

    .order-timeline {
        display: flex;
        justify-content: space-between;
        padding: 16px 0;
        margin-bottom: 20px;
        border-bottom: 1px solid #F3F4F6;
    }

    .timeline-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .timeline-step::after {
        content: '';
        position: absolute;
        top: 16px;
        left: 60%;
        right: -40%;
        height: 2px;
        background: #E5E7EB;
    }

    .timeline-step:last-child::after { display: none; }

    .timeline-step.completed::after { background: var(--success); }

    .timeline-icon {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #F9FAFB;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        z-index: 1;
        border: 2px solid #E5E7EB;
    }

    .timeline-step.completed .timeline-icon {
        background: var(--success-light);
        border-color: var(--success);
    }

    .timeline-step.current .timeline-icon {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .timeline-label {
        font-size: 0.675rem;
        color: var(--muted-foreground);
        margin-top: 8px;
        text-align: center;
        font-weight: 500;
    }

    .detail-section {
        margin-bottom: 18px;
    }

    .detail-section-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--foreground);
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #F3F4F6;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 7px 0;
        font-size: 0.875rem;
    }

    .detail-label { color: var(--muted-foreground); }
    .detail-value { color: var(--foreground); font-weight: 500; }

    .order-items-list { margin-top: 10px; }

    .order-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: #F9FAFB;
        border-radius: var(--radius-sm);
        margin-bottom: 6px;
        border: 1px solid #F3F4F6;
    }

    .item-icon { font-size: 1.35rem; }
    .item-info { flex: 1; }
    .item-name { font-weight: 500; color: var(--foreground); font-size: 0.875rem; }
    .item-meta { font-size: 0.775rem; color: var(--muted-foreground); }
    .item-price { font-weight: 600; color: var(--primary); font-size: 0.875rem; }

    .order-total-row {
        display: flex;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--primary);
        color: white;
        border-radius: var(--radius-sm);
        margin-top: 14px;
        font-weight: 700;
        font-size: 0.925rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 56px 20px;
    }

    .empty-icon { font-size: 3rem; opacity: 0.4; margin-bottom: 14px; }
    .empty-text { color: var(--muted-foreground); font-size: 0.95rem; margin-bottom: 20px; }

    .btn-shop {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 22px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        transition: background-color 0.15s ease;
    }

    .btn-shop:hover {
        color: white;
        background: var(--primary-hover);
    }

    /* Responsive */
    @@media (max-width: 1024px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 768px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-card { padding: 16px; }
        .stat-value { font-size: 1.5rem; }
        .order-row { flex-wrap: wrap; padding: 14px; }
        .order-status { order: 3; width: 100%; margin-top: 10px; }
        .order-amount { order: 2; }
        .order-arrow { display: none; }
        .tabs-header { padding: 0 12px; }
        .tab-btn { padding: 12px 10px; font-size: 0.825rem; }
        .order-timeline { display: none; }
    }

    @@media (max-width: 576px) {
        .stats-grid { grid-template-columns: 1fr 1fr; }
        .page-title { font-size: 1.35rem; }
    }

    /* ========== TRACKING MODAL ========== */
    .tracking-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        backdrop-filter: blur(3px);
    }

    .tracking-backdrop.active {
        display: flex !important;
    }

    .tracking-modal {
        background: #FFFFFF;
        border-radius: var(--radius);
        width: 100%;
        max-width: 880px;
        max-height: 92vh;
        overflow-y: auto;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 0 1px rgba(0,0,0,0.1);
        animation: trackingModalIn 0.25s ease forwards;
    }

    @@keyframes trackingModalIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tracking-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #FFFFFF;
        border-radius: var(--radius) var(--radius) 0 0;
    }

    .tracking-modal-header .cg-modal-title {
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.05rem;
        font-weight: 700;
    }

    .tracking-modal-header .cg-modal-title svg {
        color: var(--primary);
    }

    .tracking-modal-header .cg-modal-close {
        color: #9CA3AF;
        background: #F3F4F6;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .tracking-modal-header .cg-modal-close:hover {
        background: #E5E7EB;
        color: var(--foreground);
    }

    .tracking-modal-body {
        padding: 0;
    }

    /* Map Container */
    .tracking-map-container {
        width: 100%;
        height: 300px;
        position: relative;
        border-bottom: 1px solid #E5E7EB;
    }

    #trackingMap {
        width: 100%;
        height: 100%;
    }

    .map-overlay-info {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(255,255,255,0.96);
        backdrop-filter: blur(8px);
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #E5E7EB;
        z-index: 5;
        max-width: 240px;
    }

    .map-overlay-info .overlay-status {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.85rem;
        margin-bottom: 2px;
    }

    .map-overlay-info .overlay-detail {
        font-size: 0.75rem;
        color: #6B7280;
    }

    /* Tracking Content */
    .tracking-content {
        padding: 24px;
    }

    .tracking-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }

    .tracking-summary-card {
        background: #F9FAFB;
        border: 1px solid #F3F4F6;
        border-radius: var(--radius-sm);
        padding: 14px;
        text-align: center;
    }

    .tracking-summary-card .summary-icon {
        font-size: 1.4rem;
        margin-bottom: 6px;
    }

    .tracking-summary-card .summary-label {
        font-size: 0.7rem;
        color: #6B7280;
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .tracking-summary-card .summary-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--foreground);
    }

    /* Tracking Timeline */
    .tracking-timeline {
        position: relative;
        padding-left: 36px;
    }

    .tracking-timeline::before {
        content: '';
        position: absolute;
        left: 14px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #E5E7EB;
        border-radius: 1px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 24px;
        padding-left: 18px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-dot {
        position: absolute;
        left: -28px;
        top: 2px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #F3F4F6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        border: 2px solid #FFFFFF;
        box-shadow: 0 0 0 2px #E5E7EB;
        z-index: 1;
    }

    .timeline-item.completed .timeline-dot {
        background: #10B981;
        box-shadow: 0 0 0 2px #10B981;
        color: white;
    }

    .timeline-item.current .timeline-dot {
        background: var(--primary);
        box-shadow: 0 0 0 2px var(--primary);
        color: white;
        animation: pulseTrack 2.5s ease-in-out infinite;
    }

    @@keyframes pulseTrack {
        0%, 100% { box-shadow: 0 0 0 2px var(--primary), 0 0 0 5px rgba(0,128,128,0.12); }
        50% { box-shadow: 0 0 0 2px var(--primary), 0 0 0 8px rgba(0,128,128,0.06); }
    }

    .timeline-item-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .timeline-info h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--foreground);
        margin: 0 0 2px 0;
    }

    .timeline-item:not(.completed):not(.current) .timeline-info h4 {
        color: #C4C9D4;
    }

    .timeline-info p {
        font-size: 0.8rem;
        color: #6B7280;
        margin: 0;
    }

    .timeline-item:not(.completed):not(.current) .timeline-info p {
        color: #D1D5DB;
    }

    .timeline-date {
        font-size: 0.75rem;
        color: #6B7280;
        white-space: nowrap;
        text-align: right;
    }

    .timeline-item:not(.completed):not(.current) .timeline-date {
        color: #D1D5DB;
    }

    /* Track Order Button */
    .btn-track-order {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 11px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.15s ease;
        width: 100%;
        justify-content: center;
        margin-top: 14px;
    }

    .btn-track-order:hover {
        background: var(--primary-hover);
    }

    /* Tracking Items in Modal */
    .tracking-items-section {
        margin-top: 20px;
        padding-top: 18px;
        border-top: 1px solid #F3F4F6;
    }

    .tracking-items-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: 10px;
    }

    .tracking-item-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: #F9FAFB;
        border-radius: var(--radius-sm);
        margin-bottom: 6px;
        border: 1px solid #F3F4F6;
    }

    .tracking-item-icon {
        font-size: 1.2rem;
    }

    .tracking-item-details {
        flex: 1;
    }

    .tracking-item-name {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--foreground);
    }

    .tracking-item-qty {
        font-size: 0.75rem;
        color: #6B7280;
    }

    .tracking-item-price {
        font-weight: 700;
        color: var(--primary);
        font-size: 0.85rem;
    }

    @@media (max-width: 768px) {
        .tracking-modal { max-width: 100%; border-radius: var(--radius); }
        .tracking-map-container { height: 220px; }
        .tracking-summary { grid-template-columns: 1fr; }
        .tracking-content { padding: 16px 20px; }
    }
</style>

<div class="orders-page">
    <!-- Page Header -->
    <div class="page-header animate-fade-in">
        <h1 class="page-title">My Orders</h1>
        <p class="page-subtitle">Track and manage your orders</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card total animate-fade-in" style="animation-delay: 0.05s">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card processing animate-fade-in" style="animation-delay: 0.1s">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value" id="statProcessing">0</div>
            <div class="stat-label">Processing</div>
        </div>
        <div class="stat-card shipped animate-fade-in" style="animation-delay: 0.15s">
            <div class="stat-icon">üöö</div>
            <div class="stat-value" id="statShipped">0</div>
            <div class="stat-label">Shipped</div>
        </div>
        <div class="stat-card delivered animate-fade-in" style="animation-delay: 0.2s">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="statDelivered">0</div>
            <div class="stat-label">Delivered</div>
        </div>
    </div>

    <!-- Orders Tabs -->
    <div class="tabs-section animate-fade-in" style="animation-delay: 0.25s">
        <div class="tabs-header">
            <button class="tab-btn active" data-status="all" onclick="filterOrders('all', this)">
                All
                <span class="tab-count" id="countAll">0</span>
            </button>
            <button class="tab-btn" data-status="pending" onclick="filterOrders('pending', this)">
                Pending
                <span class="tab-count" id="countPending">0</span>
            </button>
            <button class="tab-btn" data-status="processing" onclick="filterOrders('processing', this)">
                Processing
                <span class="tab-count" id="countProcessing">0</span>
            </button>
            <button class="tab-btn" data-status="shipped" onclick="filterOrders('shipped', this)">
                Shipped
                <span class="tab-count" id="countShipped">0</span>
            </button>
            <button class="tab-btn" data-status="delivered" onclick="filterOrders('delivered', this)">
                Delivered
                <span class="tab-count" id="countDelivered">0</span>
            </button>
            <button class="tab-btn" data-status="cancelled" onclick="filterOrders('cancelled', this)">
                Cancelled
                <span class="tab-count" id="countCancelled">0</span>
            </button>
        </div>
        <div class="orders-content" id="ordersContent">
            <div class="empty-state">
                <div class="empty-icon">üîÑ</div>
                <p class="empty-text">Loading orders...</p>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="cg-modal-backdrop" id="orderModal" onclick="closeModalOnBackdrop(event)">
    <div class="cg-modal" onclick="event.stopPropagation()">
        <div class="cg-modal-header">
            <span class="cg-modal-title" id="modalTitle">Order Details</span>
            <button class="cg-modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="cg-modal-body" id="modalBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Order Tracking Modal -->
<div class="tracking-backdrop" id="trackingModal" onclick="closeTrackingOnBackdrop(event)">
    <div class="tracking-modal" onclick="event.stopPropagation()">
        <div class="tracking-modal-header">
            <span class="cg-modal-title">
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span id="trackingModalTitle">Track Order</span>
            </span>
            <button class="cg-modal-close" onclick="closeTrackingModal()">&times;</button>
        </div>
        <div class="tracking-modal-body">
            <!-- Google Map -->
            <div class="tracking-map-container">
                <div id="trackingMap"></div>
                <div class="map-overlay-info" id="mapOverlayInfo">
                    <div class="overlay-status" id="overlayStatus">Loading...</div>
                    <div class="overlay-detail" id="overlayDetail">Fetching tracking info</div>
                </div>
            </div>
            <!-- Tracking Details -->
            <div class="tracking-content" id="trackingContent">
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:2rem;">üîÑ</div>
                    <p style="color:#64748B;">Loading tracking details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAppyyZwTguVFsOgqXF8PPjBg4uoGvtnCs&callback=initMapsReady" async defer></script>
<script>
    const productIcons = ['üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üéß', 'üíæ', 'üéÆ', 'üì±', 'üîå', 'üíª', 'üñ®Ô∏è'];
    let allOrders = [];
    let currentFilter = 'all';
    let trackingMap = null;
    let googleMapsReady = false;

    const statusConfig = {
        'Pending': { emoji: '‚è±Ô∏è', badge: 'badge-pending', step: 0 },
        'Confirmed': { emoji: '‚úì', badge: 'badge-processing', step: 1 },
        'Processing': { emoji: '‚öôÔ∏è', badge: 'badge-processing', step: 1 },
        'Shipped': { emoji: 'üöö', badge: 'badge-shipped', step: 2 },
        'Out for Delivery': { emoji: 'üìç', badge: 'badge-shipped', step: 2 },
        'Delivered': { emoji: '‚úÖ', badge: 'badge-delivered', step: 3 },
        'Cancelled': { emoji: '‚ùå', badge: 'badge-cancelled', step: -1 },
        'Refunded': { emoji: '‚Ü©Ô∏è', badge: 'badge-cancelled', step: -1 }
    };

    // Google Maps callback
    function initMapsReady() {
        googleMapsReady = true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        const orderId = urlParams.get('orderId');

        if (paymentStatus === 'success' && orderId) {
            showPaymentSuccessToast(orderId);
            window.history.replaceState({}, document.title, '/CustomerPortal/Orders');
        }

        loadOrders();
    });

    async function showPaymentSuccessToast(orderId) {
        try {
            const response = await fetch(`/CustomerPortal/CheckPaymentStatus?orderId=${orderId}`);
            const result = await response.json();

            if (result.success) {
                const order = result.data;
                const isPaid = order.paymentStatus === 'Paid';

                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);';
                overlay.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 50px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: trackingModalIn 0.3s ease;">
                        <div style="font-size: 5rem; margin-bottom: 16px;">${isPaid ? 'üéâ' : '‚è±Ô∏è'}</div>
                        <h2 style="font-size: 1.8rem; font-weight: 800; color: #1f2937; margin-bottom: 8px;">${isPaid ? 'Payment Successful!' : 'Order Created!'}</h2>
                        <p style="color: #6b7280; margin-bottom: 8px;">Order <strong>#${order.orderNumber}</strong></p>
                        <p style="color: ${isPaid ? '#10b981' : '#f59e0b'}; font-weight: 600; margin-bottom: 8px;">
                            ${isPaid ? '‚úÖ Payment confirmed' : '‚è≥ Payment pending'}
                        </p>
                        <p style="color: #008080; font-size: 1.3rem; font-weight: 800; margin-bottom: 24px;">‚Ç±${order.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
                        <button onclick="this.closest('div').parentElement.remove()"
                            style="padding: 14px 40px; background: linear-gradient(135deg, #008080, #006666); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,128,128,0.3);">
                            üëç Got It!
                        </button>
                    </div>`;
                document.body.appendChild(overlay);
                setTimeout(() => overlay.remove(), 8000);
            }
        } catch (error) {
            console.error('Error checking payment:', error);
        }
    }

    async function loadOrders() {
        try {
            const response = await fetch('/CustomerPortal/GetOrders?pageSize=50');
            const result = await response.json();

            if (result.success) {
                allOrders = result.data || [];

                if (result.stats) {
                    document.getElementById('statTotal').textContent = result.stats.total || 0;
                    document.getElementById('statProcessing').textContent = result.stats.pending || 0;

                    const shippedCount = allOrders.filter(o => o.orderStatus === 'Shipped').length;
                    document.getElementById('statShipped').textContent = shippedCount;
                    document.getElementById('statDelivered').textContent = result.stats.delivered || 0;

                    document.getElementById('countAll').textContent = result.stats.total || 0;
                    const pendingCount = allOrders.filter(o => o.orderStatus === 'Pending').length;
                    const processingCount = allOrders.filter(o => o.orderStatus === 'Processing' || o.orderStatus === 'Confirmed').length;
                    const deliveredCount = allOrders.filter(o => o.orderStatus === 'Delivered').length;
                    const cancelledCount = allOrders.filter(o => o.orderStatus === 'Cancelled').length;

                    document.getElementById('countPending').textContent = pendingCount;
                    document.getElementById('countProcessing').textContent = processingCount;
                    document.getElementById('countShipped').textContent = shippedCount;
                    document.getElementById('countDelivered').textContent = deliveredCount;
                    document.getElementById('countCancelled').textContent = cancelledCount;
                }

                renderOrders(allOrders);
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            showEmptyState();
        }
    }

    function filterOrders(status, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = status;

        let filtered = allOrders;
        if (status !== 'all') {
            filtered = allOrders.filter(o => {
                const orderStatus = (o.orderStatus || '').toLowerCase();
                if (status === 'processing') return orderStatus === 'processing' || orderStatus === 'confirmed';
                return orderStatus === status.toLowerCase();
            });
        }
        renderOrders(filtered);
    }

    function renderOrders(orders) {
        const container = document.getElementById('ordersContent');

        if (!orders || orders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <p class="empty-text">${currentFilter === 'all' ? "You haven't placed any orders yet" : `No ${currentFilter} orders found`}</p>
                    <a href="/CustomerPortal/Products" class="btn-shop">üõí Start Shopping</a>
                </div>`;
            return;
        }

        container.innerHTML = orders.map((order, index) => {
            const config = statusConfig[order.orderStatus] || statusConfig['Pending'];
            const orderDate = new Date(order.orderDate).toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' });
            const itemCount = order.itemCount || (order.items ? order.items.length : 0);
            const paymentBadge = order.paymentStatus === 'Paid'
                ? '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">PAID</span>'
                : order.paymentStatus === 'Pending'
                ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">UNPAID</span>'
                : '';

            return `
                <div class="order-row animate-fade-in" style="animation-delay: ${index * 0.05}s" onclick="viewOrderDetail(${order.orderId})">
                    <div class="order-icon">${config.emoji}</div>
                    <div class="order-info">
                        <div class="order-number">
                            #${order.orderNumber || order.orderId} ${paymentBadge}
                        </div>
                        <div class="order-meta">
                            <span class="order-meta-item">üìÖ ${orderDate}</span>
                            <span class="order-meta-item">üì¶ ${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
                            ${order.paymentMethod ? `<span class="order-meta-item">üí≥ ${order.paymentMethod}</span>` : ''}
                        </div>
                    </div>
                    <div class="order-status">
                        <span class="status-badge ${config.badge}">${order.orderStatus}</span>
                    </div>
                    <div class="order-amount">‚Ç±${order.totalAmount.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</div>
                    <div class="order-arrow">‚Üí</div>
                </div>`;
        }).join('');
    }

    function showEmptyState() {
        document.getElementById('ordersContent').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <p class="empty-text">You haven't placed any orders yet</p>
                <a href="/CustomerPortal/Products" class="btn-shop">üõí Start Shopping</a>
            </div>`;
    }

    async function viewOrderDetail(orderId) {
        const order = allOrders.find(o => o.orderId === orderId);
        if (!order) return;

        const config = statusConfig[order.orderStatus] || statusConfig['Pending'];
        const orderDate = new Date(order.orderDate).toLocaleDateString('en-PH', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        document.getElementById('modalTitle').textContent = `Order #${order.orderNumber || order.orderId}`;

        // Build timeline HTML
        const steps = ['Confirmed', 'Processing', 'Shipped', 'Delivered'];
        const currentStep = config.step;

        const timelineHtml = steps.map((step, i) => {
            let stepClass = '';
            if (currentStep === -1) stepClass = '';
            else if (i < currentStep) stepClass = 'completed';
            else if (i === currentStep) stepClass = 'current';

            const stepEmojis = ['‚úì', '‚öôÔ∏è', 'üöö', '‚úÖ'];
            return `
                <div class="timeline-step ${stepClass}">
                    <div class="timeline-icon">${stepEmojis[i]}</div>
                    <div class="timeline-label">${step}</div>
                </div>`;
        }).join('');

        // Build items list
        const items = order.items || [];
        const itemsHtml = items.map((item, i) => `
            <div class="order-item">
                <div class="item-icon">${productIcons[i % productIcons.length]}</div>
                <div class="item-info">
                    <div class="item-name">${item.productName}</div>
                    <div class="item-meta">Qty: ${item.quantity} √ó ‚Ç±${item.unitPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="item-price">‚Ç±${item.totalPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
            </div>`).join('');

        // VAT breakdown
        const subtotal = items.reduce((sum, item) => sum + item.totalPrice, 0) || order.totalAmount;
        const vatableSales = subtotal / 1.12;
        const vatAmount = subtotal - vatableSales;

        // Determine if tracking should be available
        const canTrack = order.orderStatus !== 'Cancelled' && order.orderStatus !== 'Refunded';
        const trackBtnHtml = canTrack ? `
            <button class="btn-track-order" onclick="event.stopPropagation(); closeModal(); openTrackingModal(${order.orderId});">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                üìç Track My Order
            </button>` : '';

        // Determine if cancel/return buttons should show
        const canCancel = ['Pending', 'Processing', 'Confirmed'].includes(order.orderStatus);
        const canReturn = order.orderStatus === 'Delivered';
        const cancelBtnHtml = canCancel ? `
            <button onclick="event.stopPropagation(); showCancelOrderModal(${order.orderId}, '${order.orderNumber || order.orderId}')" style="width:100%;padding:12px;margin-top:8px;background:#fef2f2;color:#dc2626;border:1.5px solid #fecaca;border-radius:10px;cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;font-size:0.95rem;">
                ‚ùå Cancel Order
            </button>` : '';
        const returnBtnHtml = canReturn ? `
            <button onclick="event.stopPropagation(); showReturnRequestModal(${order.orderId}, '${order.orderNumber || order.orderId}')" style="width:100%;padding:12px;margin-top:8px;background:#eff6ff;color:#2563eb;border:1.5px solid #bfdbfe;border-radius:10px;cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;font-size:0.95rem;">
                ‚Ü©Ô∏è Request Return
            </button>` : '';

        document.getElementById('modalBody').innerHTML = `
            <div class="order-detail-status">
                <div class="detail-status-emoji">${config.emoji}</div>
                <div class="detail-status-text">${order.orderStatus}</div>
                <div style="margin-top: 4px; font-size: 0.85rem; color: ${order.paymentStatus === 'Paid' ? '#10b981' : '#f59e0b'};">
                    Payment: ${order.paymentStatus} ${order.paymentStatus === 'Paid' ? '‚úÖ' : '‚è≥'}
                </div>
            </div>

            <div class="order-timeline">
                ${timelineHtml}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Order Information</div>
                <div class="detail-row">
                    <span class="detail-label">Order Date</span>
                    <span class="detail-value">${orderDate}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Method</span>
                    <span class="detail-value">${order.paymentMethod || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Status</span>
                    <span class="detail-value" style="color: ${order.paymentStatus === 'Paid' ? '#10b981' : '#f59e0b'}">${order.paymentStatus}</span>
                </div>
                ${order.shippingMethod ? `
                <div class="detail-row">
                    <span class="detail-label">Shipping Method</span>
                    <span class="detail-value">${order.shippingMethod}</span>
                </div>` : ''}
                ${order.trackingNumber ? `
                <div class="detail-row">
                    <span class="detail-label">Tracking Number</span>
                    <span class="detail-value">${order.trackingNumber}</span>
                </div>` : ''}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Items (${items.length})</div>
                <div class="order-items-list">
                    ${itemsHtml || '<p style="color: #64748B; font-size: 0.9rem;">Item details not available</p>'}
                </div>
            </div>

            <div class="detail-section" style="background: #f0fdf4; border-radius: 12px; padding: 16px; margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: #6b7280;">VATable Sales</span>
                    <span>‚Ç±${vatableSales.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: #6b7280;">VAT (12%)</span>
                    <span>‚Ç±${vatAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
            </div>

            <div class="order-total-row">
                <span>Total Amount</span>
                <span>‚Ç±${order.totalAmount.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</span>
            </div>

            ${trackBtnHtml}
            ${cancelBtnHtml}
            ${returnBtnHtml}`;

        document.getElementById('orderModal').classList.add('active');
        document.getElementById('orderModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('orderModal').classList.remove('active');
        document.getElementById('orderModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    function closeModalOnBackdrop(event) {
        if (event.target.id === 'orderModal') closeModal();
    }

    // ==========================================
    // TRACKING MODAL FUNCTIONS
    // ==========================================

    async function openTrackingModal(orderId) {
        const modal = document.getElementById('trackingModal');
        modal.classList.add('active');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        document.getElementById('trackingModalTitle').textContent = 'Loading...';
        document.getElementById('overlayStatus').textContent = 'Loading...';
        document.getElementById('overlayDetail').textContent = 'Fetching tracking information';
        document.getElementById('trackingContent').innerHTML = `
            <div style="text-align:center; padding:40px;">
                <div style="font-size:2rem; animation: pulseTrack 1.5s infinite;">üì¶</div>
                <p style="color:#64748B; margin-top:12px;">Loading tracking details...</p>
            </div>`;

        try {
            const response = await fetch(`/CustomerPortal/GetOrderTracking?orderId=${orderId}`);
            const result = await response.json();

            if (result.success) {
                renderTrackingModal(result.data);
            } else {
                document.getElementById('trackingContent').innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <div style="font-size:2rem;">‚ùå</div>
                        <p style="color:#EF4444; margin-top:12px;">Failed to load tracking info</p>
                    </div>`;
            }
        } catch (error) {
            console.error('Tracking error:', error);
            document.getElementById('trackingContent').innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:2rem;">‚ùå</div>
                    <p style="color:#EF4444; margin-top:12px;">Error loading tracking data</p>
                </div>`;
        }
    }

    function renderTrackingModal(data) {
        // Update header
        document.getElementById('trackingModalTitle').textContent = `Track Order #${data.orderNumber}`;

        // Map overlay
        const statusText = data.orderStatus === 'Delivered' ? '‚úÖ Delivered'
            : data.orderStatus === 'Shipped' ? 'üöö In Transit'
            : data.orderStatus === 'Out for Delivery' ? 'üìç Out for Delivery'
            : data.orderStatus === 'Processing' ? '‚öôÔ∏è Processing'
            : data.orderStatus === 'Confirmed' ? '‚úì Confirmed'
            : '‚è±Ô∏è Pending';

        document.getElementById('overlayStatus').textContent = statusText;
        document.getElementById('overlayDetail').textContent =
            data.trackingNumber ? `Tracking: ${data.trackingNumber}` : `Est. Delivery: ${data.tracking.estimatedDelivery}`;

        // Initialize Google Map
        initTrackingMap(data.tracking);

        // Build summary cards
        const summaryHtml = `
            <div class="tracking-summary">
                <div class="tracking-summary-card">
                    <div class="summary-icon">üìç</div>
                    <div class="summary-label">From</div>
                    <div class="summary-value">${data.tracking.origin.label}</div>
                </div>
                <div class="tracking-summary-card">
                    <div class="summary-icon">üè†</div>
                    <div class="summary-label">Destination</div>
                    <div class="summary-value">${data.shippingAddress || data.shippingCity || 'Delivery Address'}</div>
                </div>
                <div class="tracking-summary-card">
                    <div class="summary-icon">üìÖ</div>
                    <div class="summary-label">Est. Delivery</div>
                    <div class="summary-value">${data.tracking.estimatedDelivery}</div>
                </div>
            </div>`;

        // Build timeline
        const timelineIcons = {
            'placed': 'üìã',
            'confirmed': '‚úÖ',
            'processing': '‚öôÔ∏è',
            'shipped': 'üöö',
            'outfordelivery': 'üìç',
            'delivered': 'üè†'
        };

        // Find the last completed step to mark it as "current"
        let lastCompletedIdx = -1;
        data.timeline.forEach((step, i) => {
            if (step.completed) lastCompletedIdx = i;
        });

        const timelineHtml = data.timeline.map((step, idx) => {
            let cls = '';
            if (step.completed && idx === lastCompletedIdx) cls = 'current';
            else if (step.completed) cls = 'completed';

            const icon = timelineIcons[step.icon] || '‚óã';
            const dateStr = step.date
                ? new Date(step.date).toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                : '‚Äî';

            return `
                <div class="timeline-item ${cls}">
                    <div class="timeline-dot">${step.completed ? '‚úì' : '‚óã'}</div>
                    <div class="timeline-item-content">
                        <div class="timeline-info">
                            <h4>${icon} ${step.status}</h4>
                            <p>${step.description}</p>
                        </div>
                        <div class="timeline-date">${step.completed ? dateStr : ''}</div>
                    </div>
                </div>`;
        }).join('');

        // Build items
        const itemsHtml = (data.items || []).map((item, i) => `
            <div class="tracking-item-row">
                <div class="tracking-item-icon">${productIcons[i % productIcons.length]}</div>
                <div class="tracking-item-details">
                    <div class="tracking-item-name">${item.productName}</div>
                    <div class="tracking-item-qty">Qty: ${item.quantity} √ó ‚Ç±${item.unitPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="tracking-item-price">‚Ç±${item.totalPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
            </div>`).join('');

        // Progress bar percentage
        const progressPct = Math.round(data.tracking.progress * 100);

        document.getElementById('trackingContent').innerHTML = `
            ${summaryHtml}

            <!-- Progress Bar -->
            <div style="margin-bottom: 28px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span style="font-size:0.82rem; font-weight:600; color:#141516;">Delivery Progress</span>
                    <span style="font-size:0.82rem; font-weight:700; color:#008080;">${progressPct}%</span>
                </div>
                <div style="background:#E5E7EB; border-radius:10px; height:10px; overflow:hidden;">
                    <div style="background: linear-gradient(90deg, #008080, #10B981); height:100%; width:${progressPct}%; border-radius:10px; transition: width 1s ease;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:6px;">
                    <span style="font-size:0.72rem; color:#94A3B8;">Warehouse</span>
                    <span style="font-size:0.72rem; color:#94A3B8;">Your Address</span>
                </div>
            </div>

            <!-- Timeline -->
            <div style="margin-bottom:24px;">
                <h3 style="font-size:1rem; font-weight:700; color:#141516; margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid #E5E7EB;">üì¶ Tracking Timeline</h3>
                <div class="tracking-timeline">
                    ${timelineHtml}
                </div>
            </div>

            <!-- Order Info -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div style="background:#F8FAFC; border-radius:10px; padding:14px;">
                    <div style="font-size:0.75rem; color:#64748B; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Shipping Method</div>
                    <div style="font-weight:600; color:#141516; font-size:0.9rem;">${data.shippingMethod || 'Standard Shipping'}</div>
                </div>
                <div style="background:#F8FAFC; border-radius:10px; padding:14px;">
                    <div style="font-size:0.75rem; color:#64748B; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Tracking Number</div>
                    <div style="font-weight:600; color:#008080; font-size:0.9rem;">${data.trackingNumber || 'Awaiting shipment'}</div>
                </div>
            </div>

            <!-- Items -->
            <div class="tracking-items-section">
                <div class="tracking-items-title">üì¶ Items in this Order (${(data.items || []).length})</div>
                ${itemsHtml}
                <div style="display:flex; justify-content:space-between; padding:14px 12px; background:linear-gradient(135deg, #008080, #006666); color:white; border-radius:10px; margin-top:10px; font-weight:700;">
                    <span>Total</span>
                    <span>‚Ç±${data.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
            </div>`;
    }

    function initTrackingMap(tracking) {
        if (!googleMapsReady || typeof google === 'undefined') {
            // Retry after a delay if Google Maps isn't loaded yet
            setTimeout(() => initTrackingMap(tracking), 500);
            return;
        }

        const mapEl = document.getElementById('trackingMap');

        const origin = tracking.origin;
        const dest = tracking.destination;
        const current = tracking.currentLocation;

        // Center map between origin and destination
        const centerLat = (origin.lat + dest.lat) / 2;
        const centerLng = (origin.lng + dest.lng) / 2;

        trackingMap = new google.maps.Map(mapEl, {
            center: { lat: centerLat, lng: centerLng },
            zoom: 12,
            disableDefaultUI: true,
            zoomControl: true,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            styles: [
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#e9e9e9' }] },
                { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#9e9e9e' }] },
                { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#ffffff' }] },
                { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#616161' }] },
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#f5f5f5' }] }
            ]
        });

        // Warehouse marker (origin)
        new google.maps.Marker({
            position: { lat: origin.lat, lng: origin.lng },
            map: trackingMap,
            title: origin.label,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: '#008080',
                fillOpacity: 1,
                strokeColor: '#FFFFFF',
                strokeWeight: 3
            },
            label: { text: 'üì¶', fontSize: '16px' }
        });

        // Add info window for origin
        const originInfo = new google.maps.InfoWindow({
            content: `<div style="padding:6px; font-family:Segoe UI,sans-serif;"><strong style="color:#008080;">üì¶ ${origin.label}</strong><br><span style="font-size:12px; color:#666;">Origin</span></div>`
        });

        const originMarker = new google.maps.Marker({
            position: { lat: origin.lat, lng: origin.lng },
            map: trackingMap,
            title: origin.label,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                        <circle cx="20" cy="20" r="18" fill="#008080" stroke="white" stroke-width="3"/>
                        <text x="20" y="26" text-anchor="middle" font-size="18">üì¶</text>
                    </svg>`),
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 20)
            }
        });
        originMarker.addListener('click', () => originInfo.open(trackingMap, originMarker));

        // Destination marker
        const destMarker = new google.maps.Marker({
            position: { lat: dest.lat, lng: dest.lng },
            map: trackingMap,
            title: dest.label,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                        <circle cx="20" cy="20" r="18" fill="#10B981" stroke="white" stroke-width="3"/>
                        <text x="20" y="26" text-anchor="middle" font-size="18">üè†</text>
                    </svg>`),
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 20)
            }
        });

        const destInfo = new google.maps.InfoWindow({
            content: `<div style="padding:6px; font-family:Segoe UI,sans-serif;"><strong style="color:#10B981;">üè† ${dest.label}</strong><br><span style="font-size:12px; color:#666;">Destination</span></div>`
        });
        destMarker.addListener('click', () => destInfo.open(trackingMap, destMarker));

        // Draw route line (completed path)
        const routePath = tracking.waypoints.map(wp => ({ lat: wp.lat, lng: wp.lng }));

        // Full route (gray)
        new google.maps.Polyline({
            path: routePath,
            geodesic: true,
            strokeColor: '#CBD5E1',
            strokeOpacity: 0.8,
            strokeWeight: 4,
            map: trackingMap
        });

        // Completed route (teal)
        const completedPath = tracking.waypoints.filter(wp => wp.reached).map(wp => ({ lat: wp.lat, lng: wp.lng }));
        if (current) {
            completedPath.push({ lat: current.lat, lng: current.lng });
        }

        new google.maps.Polyline({
            path: completedPath,
            geodesic: true,
            strokeColor: '#008080',
            strokeOpacity: 1,
            strokeWeight: 5,
            map: trackingMap
        });

        // Current location marker (package in transit)
        if (tracking.progress > 0 && tracking.progress < 1) {
            const packageMarker = new google.maps.Marker({
                position: { lat: current.lat, lng: current.lng },
                map: trackingMap,
                title: 'Current Package Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                            <circle cx="25" cy="25" r="22" fill="#FF6B35" stroke="white" stroke-width="3">
                                <animate attributeName="r" from="20" to="24" dur="1.5s" repeatCount="indefinite" />
                            </circle>
                            <text x="25" y="32" text-anchor="middle" font-size="22">üöö</text>
                        </svg>`),
                    scaledSize: new google.maps.Size(50, 50),
                    anchor: new google.maps.Point(25, 25)
                },
                animation: google.maps.Animation.BOUNCE
            });

            const packageInfo = new google.maps.InfoWindow({
                content: `<div style="padding:8px; font-family:Segoe UI,sans-serif;">
                    <strong style="color:#FF6B35;">üöö Your Package</strong><br>
                    <span style="font-size:12px; color:#666;">Currently in transit</span><br>
                    <span style="font-size:12px; color:#008080; font-weight:600;">${Math.round(tracking.progress * 100)}% of the way there</span>
                </div>`
            });
            packageMarker.addListener('click', () => packageInfo.open(trackingMap, packageMarker));

            // Stop bounce after 3 seconds for a cleaner look
            setTimeout(() => packageMarker.setAnimation(null), 3000);
        }

        // Waypoint markers (small dots)
        tracking.waypoints.forEach((wp, i) => {
            if (i === 0 || i === tracking.waypoints.length - 1) return; // Skip origin/dest
            new google.maps.Marker({
                position: { lat: wp.lat, lng: wp.lng },
                map: trackingMap,
                title: wp.label,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5,
                    fillColor: wp.reached ? '#008080' : '#CBD5E1',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2
                }
            });
        });

        // Fit bounds to show full route
        const bounds = new google.maps.LatLngBounds();
        bounds.extend({ lat: origin.lat, lng: origin.lng });
        bounds.extend({ lat: dest.lat, lng: dest.lng });
        if (current) bounds.extend({ lat: current.lat, lng: current.lng });
        trackingMap.fitBounds(bounds, { padding: 60 });

        // Trigger resize after modal is fully visible
        setTimeout(() => {
            google.maps.event.trigger(trackingMap, 'resize');
            trackingMap.fitBounds(bounds, { padding: 60 });
        }, 300);
    }

    function closeTrackingModal() {
        document.getElementById('trackingModal').classList.remove('active');
        document.getElementById('trackingModal').style.display = 'none';
        document.body.style.overflow = '';
        trackingMap = null;
    }

    function closeTrackingOnBackdrop(event) {
        if (event.target.id === 'trackingModal') closeTrackingModal();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeTrackingModal();
            const cm = document.getElementById('cancelReturnModal'); if (cm) cm.remove();
        }
    });

    function showCancelOrderModal(orderId, orderNumber) {
        closeModal();
        const modal = document.createElement('div');
        modal.id = 'cancelReturnModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
        <div style="background:white;border-radius:16px;padding:32px;width:90%;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:8px;color:#dc2626;">‚ùå Cancel Order #${orderNumber}</h3>
            <p style="color:#6b7280;font-size:0.9rem;margin-bottom:20px;">This action cannot be undone. If you've already paid, a refund will be issued.</p>
            <div style="margin-bottom:16px;">
                <label style="font-weight:600;font-size:0.9rem;display:block;margin-bottom:6px;">Reason for cancellation *</label>
                <select id="cancelReason" style="width:100%;padding:10px;border:1.5px solid #e5e7eb;border-radius:8px;font-family:Poppins,sans-serif;">
                    <option value="">Select a reason...</option>
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Found a better price">Found a better price elsewhere</option>
                    <option value="Ordered by mistake">Ordered by mistake</option>
                    <option value="Taking too long">Taking too long to process</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;">
                <button onclick="document.getElementById('cancelReturnModal').remove()" style="padding:10px 20px;border:1.5px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;font-family:Poppins,sans-serif;">Keep Order</button>
                <button onclick="submitCancelOrder(${orderId})" style="padding:10px 20px;background:#dc2626;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Confirm Cancel</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function submitCancelOrder(orderId) {
        const reason = document.getElementById('cancelReason').value;
        if (!reason) { alert('Please select a reason'); return; }
        try {
            const res = await fetch('/CustomerPortal/CancelOrder', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ orderId, reason }) });
            const result = await res.json();
            if (result.success) {
                document.getElementById('cancelReturnModal').remove();
                alert('Order cancelled successfully.' + (result.message.includes('refund') ? ' A refund has been initiated.' : ''));
                loadOrders();
            } else { alert(result.message || 'Failed to cancel order'); }
        } catch(e) { alert('Error cancelling order'); }
    }

    function showReturnRequestModal(orderId, orderNumber) {
        closeModal();
        const modal = document.createElement('div');
        modal.id = 'cancelReturnModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
        <div style="background:white;border-radius:16px;padding:32px;width:90%;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom:8px;color:#2563eb;">‚Ü©Ô∏è Return Order #${orderNumber}</h3>
            <p style="color:#6b7280;font-size:0.9rem;margin-bottom:20px;">Returns must be requested within 7 days of delivery. Items must be in original condition.</p>
            <div style="margin-bottom:16px;">
                <label style="font-weight:600;font-size:0.9rem;display:block;margin-bottom:6px;">Reason for return *</label>
                <select id="returnReason" style="width:100%;padding:10px;border:1.5px solid #e5e7eb;border-radius:8px;font-family:Poppins,sans-serif;">
                    <option value="">Select a reason...</option>
                    <option value="Defective product">Defective / damaged product</option>
                    <option value="Wrong item received">Wrong item received</option>
                    <option value="Item not as described">Item not as described</option>
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;">
                <button onclick="document.getElementById('cancelReturnModal').remove()" style="padding:10px 20px;border:1.5px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;font-family:Poppins,sans-serif;">Cancel</button>
                <button onclick="submitReturnRequest(${orderId})" style="padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Poppins,sans-serif;">Submit Return</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function submitReturnRequest(orderId) {
        const reason = document.getElementById('returnReason').value;
        if (!reason) { alert('Please select a reason'); return; }
        try {
            const res = await fetch('/CustomerPortal/RequestReturn', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ orderId, reason }) });
            const result = await res.json();
            if (result.success) {
                document.getElementById('cancelReturnModal').remove();
                alert('Return request submitted! You will receive instructions via email.');
                loadOrders();
            } else { alert(result.message || 'Failed to submit return request'); }
        } catch(e) { alert('Error submitting return request'); }
    }
</script>
}
